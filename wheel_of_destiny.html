<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Numantic √áarkƒ± - Kehanet</title>
    <script src="js/tailwind.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/play-billing.js"></script>
    <script src="js/premium.js"></script>
    <script src="js/gamification-engine.js"></script>
    <script src="js/profile.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        midnight: "#050b18",
                        abyss: "#02040a",
                        parchment: "#e8d5b5",
                        bronze: "#cd7f32",
                        "burnished-gold": "#a67c00",
                        "ethereal-blue": "#4a9eff"
                    },
                    fontFamily: {
                        "serif-title": ["Cinzel", "serif"],
                        "serif-body": ["Cormorant Garamond", "serif"],
                        "sans": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        lg: "1.5rem",
                        xl: "2.5rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <style type="text/tailwindcss">
        :root{--midnight-blue:#050b18;--bronze-accent:#cd7f32;--parchment-text:#e8d5b5}
        .nebula-bg{background:radial-gradient(circle at 20% 30%,rgba(74,158,255,0.15) 0%,transparent 40%),radial-gradient(circle at 80% 70%,rgba(138,43,226,0.1) 0%,transparent 40%),radial-gradient(circle at center,#0b1426 0%,#02040a 100%)}
        .constellation-overlay{background-image:radial-gradient(1px 1px at 20px 30px,#ffffff,rgba(0,0,0,0)),radial-gradient(1.5px 1.5px at 100px 150px,#ffffff,rgba(0,0,0,0)),radial-gradient(1px 1px at 200px 80px,#ffffff,rgba(0,0,0,0)),radial-gradient(2px 2px at 250px 250px,#ffffff,rgba(0,0,0,0)),radial-gradient(1.5px 1.5px at 50px 400px,#ffffff,rgba(0,0,0,0));background-size:300px 300px}
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
            background-color: #02040a
        }

        #wheel {
            transition: transform 0s;
        }

        #wheel.spinning {
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 1);
        }
    </style>
</head>

<body class="font-sans text-parchment selection:bg-bronze/30">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden nebula-bg">
        <div class="absolute inset-0 constellation-overlay opacity-30 pointer-events-none"></div>

        <!-- Header -->
        <div class="flex items-center p-4 pb-2 justify-between z-10">
            <button onclick="window.location.href='mystic_numerology_home_1.html'"
                class="flex size-12 shrink-0 items-center justify-start cursor-pointer bg-transparent border-none">
                <span class="material-symbols-outlined text-bronze">arrow_back_ios</span>
            </button>
            <h2 class="text-parchment font-serif-title text-sm tracking-[0.2em] flex-1 text-center">Numantic √áarkƒ±</h2>
            <div class="flex w-12 items-center justify-end">
                <div class="flex items-center gap-1 bg-bronze/10 border border-bronze/30 px-3 py-1 rounded-sm">
                    <span class="material-symbols-outlined text-bronze text-sm">auto_awesome</span>
                    <p class="text-bronze text-xs font-bold font-sans" id="energy-count">1</p>
                </div>
            </div>
        </div>

        <!-- Title -->
        <div class="flex-1 flex flex-col items-center justify-center relative px-4">
            <div class="z-10 text-center mb-10">
                <h2 class="text-parchment font-serif-title text-4xl mb-1 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]">Numantic
                    √áarkƒ±</h2>
                <p class="text-bronze/80 font-serif-body italic text-lg">Kozmik hizanƒ± ke≈üfet</p>
            </div>

            <!-- Wheel -->
            <div class="relative w-80 h-80 flex items-center justify-center mb-12">
                <div class="absolute inset-[-20px] rounded-full border border-bronze/20 scale-[1.05]"></div>
                <div class="absolute inset-[-10px] rounded-full border-[3px] border-double border-bronze/40"></div>

                <!-- Pointer -->
                <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 z-40">
                    <div
                        class="w-1 h-12 bg-bronze relative after:content-[''] after:absolute after:bottom-0 after:left-1/2 after:-translate-x-1/2 after:border-l-[6px] after:border-r-[6px] after:border-t-[10px] after:border-l-transparent after:border-r-transparent after:border-t-bronze">
                    </div>
                </div>

                <!-- Spinning wheel -->
                <div id="wheel"
                    class="relative w-full h-full rounded-full border-[1.5px] border-bronze shadow-[0_0_50px_rgba(205,127,50,0.15)] bg-abyss/80 overflow-hidden flex items-center justify-center">
                    <div class="absolute inset-4 rounded-full border border-bronze/10"></div>
                    <div class="absolute inset-0">
                        <div class="absolute inset-0 rotate-[45deg] border-t border-bronze/20"></div>
                        <div class="absolute inset-0 rotate-[90deg] border-t border-bronze/20"></div>
                        <div class="absolute inset-0 rotate-[135deg] border-t border-bronze/20"></div>
                        <div class="absolute inset-0 rotate-[180deg] border-t border-bronze/20"></div>
                    </div>
                    <div
                        class="absolute inset-0 flex items-center justify-center text-parchment/70 font-serif-title text-xl">
                        <div class="absolute top-6">1</div>
                        <div class="absolute right-10 top-16">2</div>
                        <div class="absolute right-6">3</div>
                        <div class="absolute right-10 bottom-16 text-ethereal-blue">‚ú¶</div>
                        <div class="absolute bottom-6">5</div>
                        <div class="absolute left-10 bottom-16">6</div>
                        <div class="absolute left-6">7</div>
                        <div class="absolute left-10 top-16">8</div>
                    </div>

                    <!-- Spin button -->
                    <div id="spin-btn" onclick="handleSpin()"
                        class="z-30 w-28 h-28 bg-gradient-to-b from-bronze to-burnished-gold rounded-full flex flex-col items-center justify-center shadow-[0_10px_30px_rgba(0,0,0,0.6)] cursor-pointer hover:brightness-110 active:scale-95 border-[1px] border-parchment/30">
                        <span
                            class="text-abyss font-serif-title font-black tracking-[0.2em] text-xl leading-none">√áEVƒ∞R</span>
                        <div class="w-8 h-[1px] bg-abyss/40 mt-1"></div>
                    </div>
                </div>
            </div>

            <p id="spin-hint" class="text-bronze/60 text-xs font-serif-body italic mb-8">Hen√ºz √ßevirmedin...</p>

            <!-- Rewards -->
            <div class="w-full max-w-md bg-abyss/60 backdrop-blur-md rounded-lg p-6 border border-bronze/20 relative">
                <div class="absolute top-0 left-0 w-4 h-4 border-t border-l border-bronze/50 rounded-tl-sm"></div>
                <div class="absolute top-0 right-0 w-4 h-4 border-t border-r border-bronze/50 rounded-tr-sm"></div>
                <div class="absolute bottom-0 left-0 w-4 h-4 border-b border-l border-bronze/50 rounded-bl-sm"></div>
                <div class="absolute bottom-0 right-0 w-4 h-4 border-b border-r border-bronze/50 rounded-br-sm"></div>
                <div class="flex items-center justify-between mb-5">
                    <h3 class="text-parchment font-serif-title text-sm tracking-widest uppercase">G√ºn√ºn Kozmik √ñd√ºlleri
                    </h3>
                    <span class="text-[10px] text-bronze/60 italic font-serif-body">G√ºnde 1 kez yenilenir</span>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div id="reward-1"
                        class="flex flex-col items-center p-3 rounded-md bg-bronze/5 border border-bronze/10 text-center transition-all duration-500">
                        <div
                            class="w-12 h-12 rounded-full border border-bronze/30 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-bronze text-2xl">workspace_premium</span>
                        </div>
                        <span class="text-[11px] font-serif-body italic text-parchment/80 leading-tight">1 G√ºn Premium</span>
                        <span class="text-[9px] text-bronze/50 mt-1">%15 ≈üans</span>
                    </div>
                    <div id="reward-2"
                        class="flex flex-col items-center p-3 rounded-md bg-bronze/5 border border-bronze/10 text-center transition-all duration-500">
                        <div
                            class="w-12 h-12 rounded-full border border-bronze/30 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-bronze text-2xl">diamond</span>
                        </div>
                        <span class="text-[11px] font-serif-body italic text-parchment/80 leading-tight">5 G√ºn Premium</span>
                        <span class="text-[9px] text-bronze/50 mt-1">%5 ≈üans</span>
                    </div>
                    <div id="reward-3"
                        class="flex flex-col items-center p-3 rounded-md bg-bronze/5 border border-bronze/10 text-center transition-all duration-500">
                        <div
                            class="w-12 h-12 rounded-full border border-bronze/30 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-bronze text-2xl">auto_awesome</span>
                        </div>
                        <span class="text-[11px] font-serif-body italic text-parchment/80 leading-tight">10 G√ºn Premium</span>
                        <span class="text-[9px] text-bronze/50 mt-1">%2 ≈üans</span>
                    </div>
                </div>
            </div>

            <div class="mt-10 mb-6">
                <div
                    class="flex items-center gap-4 text-bronze/30 text-[10px] font-serif-title tracking-[0.4em] uppercase">
                    <span class="w-12 h-[0.5px] bg-gradient-to-r from-transparent to-bronze/30"></span>
                    <span>Yƒ±ldƒ±zlar hizalanƒ±yor</span>
                    <span class="w-12 h-[0.5px] bg-gradient-to-l from-transparent to-bronze/30"></span>
                </div>
            </div>
        </div>
    </div>


    <!-- Result overlay -->
    <div id="result-overlay"
        style="display:none;position:fixed;inset:0;background:rgba(2,4,10,0.85);z-index:100;align-items:center;justify-content:center;flex-direction:column;gap:16px;">
        <div style="font-size:72px;line-height:1" id="result-icon">‚ú®</div>
        <p style="font-size:28px;font-weight:700;letter-spacing:0.15em;color:#cd7f32;font-family:Cinzel,serif"
            id="result-number">7</p>
        <p style="font-size:16px;color:#e8d5b5;opacity:0.8;font-family:Cormorant Garamond,serif;font-style:italic;text-align:center;padding:0 24px;"
            id="result-text"></p>
        <div id="premium-reward-banner" style="display:none;margin-top:16px;padding:12px 24px;background:linear-gradient(135deg,#bf953f,#fcf6ba,#b38728);border-radius:12px;text-align:center;">
            <p style="font-size:11px;color:#02040a;font-weight:800;letter-spacing:0.1em;text-transform:uppercase;font-family:Cinzel,serif;">‚≠ê Premium √ñd√ºl√º Kazandƒ±n!</p>
            <p id="premium-reward-text" style="font-size:18px;font-weight:900;color:#02040a;font-family:Cinzel,serif;margin-top:4px;">5 G√ºn Premium</p>
        </div>
        <button onclick="closeResult()"
            style="margin-top:24px;padding:14px 40px;background:linear-gradient(to bottom,#cd7f32,#a67c00);border-radius:9999px;color:#02040a;font-weight:700;font-family:Cinzel,serif;letter-spacing:0.15em;font-size:13px;cursor:pointer;border:none;">√ñD√úL√ú
            AL</button>
    </div>

    <script>
        var spinning = false;
        var currentRotation = 0;
        var userCanSpin = true;

        var segments = [
            { num: '1', text: 'Yeni Ba≈ülangƒ±√ßlar ‚Äî Taze bir d√∂ng√º uyanƒ±yor', icon: 'üå±' },
            { num: '2', text: 'Uyum ‚Äî Denge yoluna rehberlik ediyor', icon: '‚òØÔ∏è' },
            { num: '3', text: 'ƒ∞fade ‚Äî Sesin ger√ßekliƒüi ≈üekillendiriyor', icon: 'üé®' },
            { num: '‚ú¶', text: 'Kozmik Bonus ‚Äî Yƒ±ldƒ±zlar seni destekliyor!', icon: '‚≠ê' },
            { num: '5', text: '√ñzg√ºrl√ºk ‚Äî Deƒüi≈üim kurtulu≈ü getirir', icon: 'ü¶ã' },
            { num: '6', text: 'A≈ük ‚Äî Kalp enerjisi g√º√ßleniyor', icon: 'üíõ' },
            { num: '7', text: 'Arayƒ±≈ü ‚Äî ƒ∞√ßsel bilgelik bekliyor', icon: 'üîÆ' },
            { num: '8', text: 'Bolluk ‚Äî Refah sana akƒ±yor', icon: 'üí∞' },
        ];

        document.addEventListener('DOMContentLoaded', checkSpinStatus);

        async function checkSpinStatus() {
            try {
                // Supabase session recover'ƒ±nƒ± bekle (race condition √∂nleme)
                if (window.auth && window.auth.whenReady) await window.auth.whenReady();
                const session = await window.auth.getSession();
                if (!session) {
                    window.location.href = 'mystic_sign_up_screen.html';
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await window.supabaseClient
                    .from('wheel_spins')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .gte('created_at', today)
                    .limit(1);

                if (data && data.length > 0) {
                    userCanSpin = false;
                    document.getElementById('spin-hint').innerText = 'Bug√ºnk√º hakkƒ±nƒ± kullandƒ±n. Yarƒ±n tekrar gel!';
                    document.getElementById('energy-count').innerText = '0';
                    document.getElementById('spin-btn').style.opacity = '0.5';
                    document.getElementById('spin-btn').style.cursor = 'default';
                }
            } catch (e) {
                console.error('Hata:', e);
            }
        }

        async function handleSpin() {
            if (!userCanSpin || spinning) return;
            spinWheel();
        }

        function spinWheel() {
            spinning = true;
            var wheel = document.getElementById('wheel');
            var btn = document.getElementById('spin-btn');

            btn.style.opacity = '0.6';
            btn.style.pointerEvents = 'none';

            var extraSpins = (Math.floor(Math.random() * 5) + 5) * 360;
            var targetSegment = Math.floor(Math.random() * segments.length);
            var segmentAngle = 360 / segments.length;
            var targetAngle = targetSegment * segmentAngle;
            var totalRotation = currentRotation + extraSpins + targetAngle;

            wheel.classList.add('spinning');
            wheel.style.transform = 'rotate(' + totalRotation + 'deg)';
            currentRotation = totalRotation;

            setTimeout(async () => {
                wheel.classList.remove('spinning');
                spinning = false;

                const result = segments[targetSegment];

                // Save to Supabase
                try {
                    const session = await window.auth.getSession();
                    await window.supabaseClient.from('wheel_spins').insert({
                        user_id: session.user.id,
                        result: result.num
                    });
                    userCanSpin = false;
                    document.getElementById('energy-count').innerText = '0';
                    // XP tracking
                    if (window.gamification) { window.gamification.addXP('wheel_spin', 0); window.gamification.trackAction('wheel_spin'); }
                } catch (e) { console.error(e); }

                showResult(result);
            }, 4200);
        }

        // ‚îÄ‚îÄ‚îÄ PREMƒ∞UM √ñD√úL OLASILIK Sƒ∞STEMƒ∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // %15 ‚Üí 1 g√ºn, %5 ‚Üí 5 g√ºn, %2 ‚Üí 10 g√ºn, %78 ‚Üí √∂d√ºl yok
        function rollPremiumReward() {
            var roll = Math.random() * 100;
            if (roll < 2) return 10;
            if (roll < 7) return 5;    // 2-7 arasƒ± = %5
            if (roll < 22) return 1;   // 7-22 arasƒ± = %15
            return 0;
        }

        function activatePremiumReward(days) {
            if (days <= 0) return;
            // Premium sim√ºle et
            if (window.premium && window.premium.simulate) {
                window.premium.simulate(days);
            }
            // Supabase'e kaydet
            try {
                window.auth.getSession().then(function(session) {
                    if (!session) return;
                    window.supabaseClient.from('wheel_spins').update({
                        premium_days: days
                    }).eq('user_id', session.user.id).order('created_at', { ascending: false }).limit(1);
                });
            } catch(e) { console.warn('[Wheel] Premium kayƒ±t hatasƒ±:', e); }
        }

        function highlightRewardBox(days) {
            var boxId = days === 1 ? 'reward-1' : (days === 5 ? 'reward-2' : 'reward-3');
            var box = document.getElementById(boxId);
            if (!box) return;
            box.style.background = 'linear-gradient(135deg, rgba(191,149,63,0.3), rgba(252,246,186,0.15))';
            box.style.borderColor = '#cd7f32';
            box.style.boxShadow = '0 0 20px rgba(205,127,50,0.4)';
            box.style.transform = 'scale(1.08)';
            // ƒ∞√ßindeki icon'u parlat
            var icon = box.querySelector('.material-symbols-outlined');
            if (icon) icon.style.color = '#fcf6ba';
            // "Kazanƒ±ldƒ±!" etiketi ekle
            var badge = document.createElement('span');
            badge.textContent = '‚úì Kazanƒ±ldƒ±!';
            badge.style.cssText = 'display:block;font-size:9px;font-weight:800;color:#fcf6ba;margin-top:4px;letter-spacing:0.05em;';
            box.appendChild(badge);
        }

        function showResult(seg) {
            document.getElementById('result-icon').textContent = seg.icon;
            document.getElementById('result-number').textContent = 'Titre≈üim ' + seg.num;
            document.getElementById('result-text').textContent = seg.text;

            // Premium √∂d√ºl√º √ßek
            var premDays = rollPremiumReward();
            var banner = document.getElementById('premium-reward-banner');
            if (premDays > 0) {
                banner.style.display = 'block';
                document.getElementById('premium-reward-text').textContent = premDays + ' G√ºn Premium';
                activatePremiumReward(premDays);
                highlightRewardBox(premDays);
            } else {
                banner.style.display = 'none';
            }

            document.getElementById('result-overlay').style.display = 'flex';
        }

        function closeResult() {
            document.getElementById('result-overlay').style.display = 'none';
        }
    </script>
    <script src="js/numerology-context-engine.js"></script>
    <script src="js/decision-timing-engine.js"></script>
    <script src="js/numerology-ai.js"></script>
<script src="js/notification-engine.js"></script>
<script src="js/bottom-nav.js"></script>
</body>

</html>