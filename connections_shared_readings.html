<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Connections</title>
    <script src="js/theme-engine.js"></script>
    <script src="js/tailwind.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/play-billing.js"></script>
    <script src="js/premium.js"></script>
    <script src="js/gamification-engine.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/discovery-engine.js"></script>
    <script src="js/connection-engine.js"></script>
    <script src="js/avatar.js"></script>
    <script src="js/compatibility-engine.js"></script>
    <script id="tailwind-config">
        tailwind.config = { darkMode: "class", theme: { extend: {
            colors: {
                        "background-light": "#f8f8f5", primary:"#f2cc0d","background-dark":"#181711","surface-dark":"#221f10", "surface-light": "#ffffff","card-dark":"#393628", "card-light": "#f5f5f0","cosmic-violet":"#8b5cf6","cosmic-pink":"#ec4899" },
            fontFamily: { display:["Space Grotesk","sans-serif"] },
            borderRadius: { DEFAULT:"1rem",lg:"2rem",xl:"3rem",full:"9999px" }
        }}}
    </script>
    <style>
        .material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}
        .glow-border{box-shadow:0 0 12px rgba(242,204,13,0.35)}
        .cosmic-glow-border{box-shadow:0 0 12px rgba(139,92,246,0.35)}
        body{min-height:max(884px,100dvh);font-family:'Space Grotesk',sans-serif}
        .hide-scrollbar::-webkit-scrollbar{display:none}
        .hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
        @keyframes fade-in{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
        .fade-in{animation:fade-in 0.35s ease forwards}
        .card-hover{transition:transform 0.15s ease}
        .card-hover:active{transform:scale(0.97)}
        /* Notification inbox */
        .notif-inbox-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:16px;cursor:pointer;transition:background 0.15s,transform 0.1s}
        .notif-inbox-item:active{transform:scale(0.97)}
        html.dark .notif-inbox-item{background:rgba(139,92,246,0.06);border:1px solid rgba(139,92,246,0.12)}
        html:not(.dark) .notif-inbox-item{background:rgba(139,92,246,0.04);border:1px solid rgba(139,92,246,0.1)}
        html.dark .notif-inbox-item:hover{background:rgba(139,92,246,0.1)}
        html:not(.dark) .notif-inbox-item:hover{background:rgba(139,92,246,0.08)}
        .notif-inbox-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        html.dark .notif-inbox-icon{background:rgba(139,92,246,0.15)}
        html:not(.dark) .notif-inbox-icon{background:rgba(139,92,246,0.1)}
        .notif-inbox-dot{width:10px;height:10px;border-radius:50%;background:#8b5cf6;flex-shrink:0}
        @keyframes card-unread-pulse{
            0%,100%{box-shadow:0 0 0 0 transparent;border-color:var(--glow)}
            50%{box-shadow:0 0 22px 4px var(--glow);border-color:var(--glow-solid)}
        }
        .card-unread{animation:card-unread-pulse 1.8s ease-in-out infinite}
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen">
<div class="relative flex h-auto min-h-screen w-full flex-col max-w-[480px] mx-auto overflow-x-hidden pb-10">

    <!-- Header -->
    <header class="flex items-center p-4 pb-2 justify-between sticky top-0 z-50 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-slate-200 dark:border-white/5">
        <div onclick="window.location.href='mystic_numerology_home_1.html'"
            class="flex size-12 shrink-0 items-center justify-start cursor-pointer text-slate-700 dark:text-white">
            <span class="material-symbols-outlined">arrow_back_ios</span>
        </div>
        <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight flex-1 text-center">Connections</h2>
        <button onclick="window.location.href='data-ready_birth_form.html'"
            class="flex size-10 cursor-pointer items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-white/10 transition-colors text-slate-500 dark:text-white/60">
            <span class="material-symbols-outlined">person_add</span>
        </button>
    </header>

    <!-- Notification Inbox -->
    <div id="notif-inbox-section" style="display:none" class="px-4 pt-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-slate-900 dark:text-white text-sm font-bold tracking-tight flex items-center gap-2">
                <span class="material-symbols-outlined text-base" style="color:#8b5cf6">notifications_active</span>
                Bildirimler
            </h3>
            <button id="notif-inbox-mark-all" class="text-slate-400 dark:text-white/30 text-[10px] font-bold uppercase tracking-wider hover:text-slate-600 dark:hover:text-white/50 transition-colors">
                Tümünü okundu işaretle
            </button>
        </div>
        <div id="notif-inbox-list" class="flex flex-col gap-2"></div>
    </div>

    <!-- Soul Connections Yatay Scroll -->
    <div class="flex flex-col gap-2 pt-6 pb-2">
        <div class="flex items-center justify-between px-5">
            <h3 class="text-slate-900 dark:text-white text-base font-bold tracking-tight">Soul Connections</h3>
            <p class="text-slate-400 dark:text-white/30 text-xs" id="connections-count"></p>
        </div>
        <div id="connections-row" class="flex gap-4 overflow-x-auto px-5 hide-scrollbar pb-2">
            <!-- Ekle butonu her zaman -->
            <div class="flex flex-col items-center gap-2 shrink-0">
                <button onclick="window.location.href='data-ready_birth_form.html'"
                    class="size-16 rounded-full border-2 border-dashed border-primary/40 flex items-center justify-center text-primary/60 hover:border-primary/60 transition-colors">
                    <span class="material-symbols-outlined text-3xl">add</span>
                </button>
                <span class="text-slate-500 dark:text-white/40 text-xs font-medium">Ekle</span>
            </div>
        </div>
    </div>

    <!-- Match-based Connections -->
    <div id="match-connections-section" style="display:none" class="px-4 pb-2">
        <div class="flex items-center justify-between py-4">
            <h3 class="text-slate-900 dark:text-white text-base font-bold tracking-tight">Match Connections</h3>
            <span id="match-conn-count" class="text-slate-400 dark:text-white/30 text-xs"></span>
        </div>
        <div id="match-connections-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Recent Analyses Liste -->
    <div class="flex-1 px-4">
        <div class="flex items-center justify-between py-4">
            <h3 class="text-slate-900 dark:text-white text-base font-bold tracking-tight">Recent Analyses</h3>
            <span id="analyses-count" class="text-slate-400 dark:text-white/30 text-xs"></span>
        </div>
        <div id="analyses-list" class="flex flex-col gap-3"></div>

        <!-- Boş durum -->
        <div id="empty-state" style="display:none"
            class="text-center py-16 text-slate-400 dark:text-white/25 text-sm italic">
            Henüz analiz yapılmadı.<br/>
            <button onclick="window.location.href='data-ready_birth_form.html'"
                class="mt-4 text-primary font-bold text-sm">+ Yeni Analiz Başlat</button>
        </div>
    </div>

    <!-- CTA -->
    <div class="px-4 pt-4">
        <button onclick="window.location.href='data-ready_birth_form.html'"
            class="w-full bg-primary text-[#181711] py-4 rounded-full font-bold text-base shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
            <span class="material-symbols-outlined">person_add</span>
            New Analysis for Someone
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Auth hazır olana kadar bekle (Supabase'den veri çekilsin)
    if (window.auth && window.auth.whenReady) await window.auth.whenReady();

    // ─── Pisagor ──────────────────────────────────────────────
    var TABLE = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:4,W:5,X:6,Y:7,Z:8,'Ş':1,'Ç':3,'Ü':3,'Ö':6,'Ğ':7,'İ':9};
    function reduce(n){if(n===11||n===22||n===33)return n;while(n>9){n=String(n).split('').reduce(function(a,d){return a+parseInt(d);},0);if(n===11||n===22||n===33)break;}return n;}
    function calcLP(d){if(!d)return null;return reduce(d.replace(/\D/g,'').split('').reduce(function(a,x){return a+parseInt(x);},0));}
    function calcExp(name){var s=0,c=(name||'').toUpperCase().replace(/[^A-ZÇĞİIÖŞÜ]/g,'');for(var i=0;i<c.length;i++)s+=(TABLE[c[i]]||0);return reduce(s);}

    var ARCH = {1:'The Leader',2:'The Diplomat',3:'The Creator',4:'The Builder',5:'The Adventurer',6:'The Nurturer',7:'The Seeker',8:'The Achiever',9:'The Humanitarian',11:'The Illuminator',22:'The Master Builder',33:'The Teacher'};

    // ─── Kullanıcı bazlı benzersiz renkler ──────────────────
    var COLOR_PALETTE = [
        '#ec4899', // Neon Rose
        '#38bdf8', // Cyan Blue
        '#34d399', // Emerald
        '#f59e0b', // Warm Amber
        '#a78bfa', // Soft Purple
        '#fb7185', // Coral
        '#2dd4bf', // Teal
        '#e879f9'  // Magenta
    ];
    function hashStr(s, len) {
        var h = 0;
        for (var i = 0; i < (s||'').length; i++) h = (h * 31 + s.charCodeAt(i)) & 0xFFFFFFFF;
        return Math.abs(h) % len;
    }
    function hexToRgba(hex, a) {
        var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
        return 'rgba(' + r + ',' + g + ',' + b + ',' + a + ')';
    }
    function getUserColor(idOrName) {
        var c = COLOR_PALETTE[hashStr(idOrName || 'x', COLOR_PALETTE.length)];
        return { border: c, borderMuted: hexToRgba(c, 0.35), glow: hexToRgba(c, 0.35), badge: c };
    }
    function getPhoto(name, gender, avatarUrl) {
        return window.avatarUtil.getAvatarUrl({ avatarUrl: avatarUrl, name: name, gender: gender });
    }
    function shortDate(s){try{return new Date(s).toLocaleDateString('tr-TR',{day:'numeric',month:'short'});}catch(e){return '';}}

    // ─── Session ────────────────────────────────────────────
    var session = null;
    var currentUserId = null;
    try {
        session = await window.auth.getSession();
        if (session && session.user) currentUserId = session.user.id;
    } catch(e) {}

    // ─── Match-based connections (from Supabase) ────────────
    if (currentUserId && window.connectionEngine) {
        var matchConns = await window.connectionEngine.getConnections(currentUserId);
        if (matchConns.length > 0) {
            var mcSection = document.getElementById('match-connections-section');
            var mcList = document.getElementById('match-connections-list');
            var mcCount = document.getElementById('match-conn-count');
            var rowEl = document.getElementById('connections-row');

            mcSection.style.display = 'block';
            mcCount.textContent = matchConns.length + ' connected';

            matchConns.forEach(function(mc, idx) {
                var p = mc.profile || {};
                var name = p.full_name || 'Kullanıcı';
                var lp = p.life_path || calcLP(p.birth_date) || '?';
                var photo = getPhoto(name, p.gender, p.avatar_url);
                var firstName = name.split(' ')[0];
                var arch = ARCH[lp] || 'Soul';
                var exp = p.expression_num || calcExp(name);
                var uc = getUserColor(mc.user_id || name);

                // Add to horizontal scroll row
                var avatarDiv = document.createElement('div');
                avatarDiv.className = 'flex flex-col items-center gap-2 shrink-0 cursor-pointer fade-in';
                avatarDiv.style.animationDelay = (idx * 0.05) + 's';
                avatarDiv.innerHTML =
                    '<div class="relative">' +
                        '<div class="size-16 rounded-full border-2 overflow-hidden bg-slate-100 dark:bg-surface-dark" style="border-color:' + uc.border + ';box-shadow:0 0 12px ' + uc.glow + '">' +
                            '<img src="' + photo + '" alt="' + name + '" class="w-full h-full object-cover">' +
                        '</div>' +
                        '<div class="absolute -bottom-1 -right-1 text-white text-[10px] font-black h-5 w-5 rounded-full flex items-center justify-center border-2 border-background-light dark:border-[#181711]" style="background:' + uc.badge + '">' + lp + '</div>' +
                    '</div>' +
                    '<span class="text-slate-600 dark:text-white/70 text-xs font-medium max-w-[60px] text-center truncate">' + firstName + '</span>';
                avatarDiv.addEventListener('click', function() {
                    window.location.href = 'kisi_profil.html?kisi=' + encodeURIComponent(name);
                });
                rowEl.insertBefore(avatarDiv, rowEl.lastElementChild);

                // Add to match connections list
                var card = document.createElement('div');
                card.className = 'card-hover flex items-center gap-4 p-4 bg-white dark:bg-card-dark rounded-2xl border cursor-pointer fade-in';
                card.style.borderColor = hexToRgba(uc.border, 0.15);
                card.style.setProperty('--glow', hexToRgba(uc.border, 0.35));
                card.style.setProperty('--glow-solid', uc.border);
                card.setAttribute('data-chat-uid', mc.user_id || '');
                card.style.animationDelay = (0.05 + idx * 0.07) + 's';
                card.innerHTML =
                    '<div class="relative shrink-0">' +
                        '<div class="size-14 rounded-full overflow-hidden border-2" style="border-color:' + uc.borderMuted + '">' +
                            '<img src="' + photo + '" alt="' + name + '" class="w-full h-full object-cover">' +
                        '</div>' +
                        '<div class="absolute -bottom-1 -right-1 text-white text-[9px] font-black h-5 w-5 rounded-full flex items-center justify-center border-2 border-background-light dark:border-[#181711]" style="background:' + uc.badge + '">' + lp + '</div>' +
                    '</div>' +
                    '<div class="flex-1 min-w-0">' +
                        '<p class="text-slate-900 dark:text-white font-bold truncate">' + name + '</p>' +
                        '<p class="text-slate-500 dark:text-white/40 text-xs mt-0.5">' + arch + ' · Exp: ' + exp + '</p>' +
                        '<p class="text-slate-400 dark:text-white/25 text-xs">' + shortDate(mc.created_at) + '</p>' +
                    '</div>' +
                    '<span class="material-symbols-outlined shrink-0" style="color:' + hexToRgba(uc.border, 0.5) + '">chat</span>' +
                    '<span class="material-symbols-outlined text-slate-300 dark:text-white/20 shrink-0">chevron_right</span>';

                card.addEventListener('click', function() {
                    window.location.href = 'messaging.html?uid=' + encodeURIComponent(mc.user_id);
                });
                mcList.appendChild(card);
            });
        }
    }

    // ─── Local connections (existing localStorage) ──────────
    var rawConns = [];
    try { rawConns = await window.profile.getConnections(); } catch(e) {}

    // İsme göre deduplicate — aynı isim varsa en son kaydı tut
    var seen = {};
    rawConns.forEach(function(c) {
        var key = (c.fullName||'').trim().toLowerCase();
        if (!seen[key] || new Date(c.createdAt) > new Date(seen[key].createdAt)) {
            seen[key] = c;
        }
    });
    var connections = Object.values(seen);
    connections.sort(function(a,b){return new Date(b.createdAt)-new Date(a.createdAt);});

    var rowEl = document.getElementById('connections-row');
    var listEl = document.getElementById('analyses-list');
    var emptyEl = document.getElementById('empty-state');
    var countEl = document.getElementById('connections-count');
    var aCountEl = document.getElementById('analyses-count');

    // Update total count (local + match-based)
    var matchConnCount = 0;
    try { if (currentUserId && window.connectionEngine) { var mc = await window.connectionEngine.getConnections(currentUserId); matchConnCount = mc.length; } } catch(e){}
    var totalCount = connections.length + matchConnCount;
    countEl.textContent = totalCount + ' kişi';

    if (connections.length === 0 && matchConnCount === 0) {
        emptyEl.style.display = 'block';
        return;
    }

    if (connections.length > 0) {
        aCountEl.textContent = connections.length + ' analiz';
    }

    // Local connections için Supabase'den avatar_url çek — profiles HER ZAMAN öncelikli
    if (connections.length > 0 && window.supabaseClient) {
        try {
            var connNames = connections.map(function(c) { return c.fullName; }).filter(Boolean);
            // discovery_profiles'dan user_id ve avatar çek
            var dpRes = await window.supabaseClient.from('discovery_profiles')
                .select('full_name, avatar_url, user_id, gender')
                .in('full_name', connNames);
            var dpMap = {};
            var allUserIds = [];
            if (dpRes.data) {
                dpRes.data.forEach(function(dp) {
                    dpMap[dp.full_name.toLowerCase()] = dp;
                    if (dp.user_id) allUserIds.push(dp.user_id);
                });
            }
            // profiles tablosundan TÜM user_id'lerin avatar'larını çek (her zaman öncelikli)
            var profAvatarMap = {};
            if (allUserIds.length > 0) {
                var profRes = await window.supabaseClient.from('profiles')
                    .select('id, avatar_url')
                    .in('id', allUserIds);
                if (profRes.data) {
                    profRes.data.forEach(function(p) { if (p.avatar_url) profAvatarMap[p.id] = p.avatar_url; });
                }
            }
            // connections'lara avatar_url ekle — profiles öncelikli
            connections.forEach(function(conn) {
                var key = (conn.fullName || '').toLowerCase();
                var dp = dpMap[key];
                if (dp) {
                    // profiles tablosu HER ZAMAN öncelikli
                    if (dp.user_id && profAvatarMap[dp.user_id]) {
                        conn.avatar_url = profAvatarMap[dp.user_id];
                    } else if (dp.avatar_url) {
                        conn.avatar_url = dp.avatar_url;
                    }
                    if (!conn.gender && dp.gender) conn.gender = dp.gender;
                }
            });
        } catch(e) { console.warn('[Connections] Avatar enrich error:', e); }
    }

    // Supabase'den uyumluluk skorlarını çek
    var compatMap = {};
    if (window.CompatEngine && window.CompatEngine.loadReadingsFromSupabase) {
        try {
            var readings = await window.CompatEngine.loadReadingsFromSupabase();
            readings.forEach(function(r) {
                compatMap[(r.partner_name||'').toLowerCase()] = r;
            });
        } catch(e) { console.warn('[Connections] CompatEngine load error:', e); }
    }

    connections.forEach(function(conn, idx) {
        var lp = conn.lifePath || calcLP(conn.birthDate) || '?';
        var exp = calcExp(conn.fullName);
        var photo = getPhoto(conn.fullName, conn.gender, conn.avatar_url);
        var firstName = (conn.fullName||'').split(' ')[0];
        var arch = ARCH[lp] || 'Soul';
        var uc = getUserColor(conn.fullName);
        var reading = compatMap[(conn.fullName||'').toLowerCase()];

        // ── Avatar satırı ──────────────────────────────────────
        var avatarDiv = document.createElement('div');
        avatarDiv.className = 'flex flex-col items-center gap-2 shrink-0 cursor-pointer fade-in';
        avatarDiv.style.animationDelay = (idx * 0.05) + 's';
        avatarDiv.innerHTML =
            '<div class="relative">' +
                '<div class="size-16 rounded-full border-2 overflow-hidden bg-slate-100 dark:bg-surface-dark" style="border-color:' + uc.border + ';box-shadow:0 0 12px ' + uc.glow + '">' +
                    '<img src="' + photo + '" alt="' + conn.fullName + '" class="w-full h-full object-cover">' +
                '</div>' +
                '<div class="absolute -bottom-1 -right-1 text-[#181711] text-[10px] font-black h-5 w-5 rounded-full flex items-center justify-center border-2 border-background-light dark:border-[#181711]" style="background:' + uc.badge + '">' + lp + '</div>' +
            '</div>' +
            '<span class="text-slate-600 dark:text-white/70 text-xs font-medium max-w-[60px] text-center truncate">' + firstName + '</span>';
        avatarDiv.addEventListener('click', function() {
            window.location.href = 'kisi_profil.html?kisi=' + encodeURIComponent(conn.fullName);
        });
        rowEl.insertBefore(avatarDiv, rowEl.lastElementChild);

        // ── Analiz kartı ───────────────────────────────────────
        var card = document.createElement('div');
        card.className = 'card-hover flex items-center gap-4 p-4 bg-white dark:bg-card-dark rounded-2xl border fade-in';
        card.style.borderColor = hexToRgba(uc.border, 0.08);
        card.style.animationDelay = (0.05 + idx * 0.07) + 's';
        card.innerHTML =
            '<div class="relative shrink-0 cursor-pointer" data-action="view">' +
                '<div class="size-14 rounded-full overflow-hidden border-2" style="border-color:' + uc.borderMuted + '">' +
                    '<img src="' + photo + '" alt="' + conn.fullName + '" class="w-full h-full object-cover">' +
                '</div>' +
                '<div class="absolute -bottom-1 -right-1 text-[#181711] text-[9px] font-black h-5 w-5 rounded-full flex items-center justify-center border-2 border-background-light dark:border-[#181711]" style="background:' + uc.badge + '">' + lp + '</div>' +
            '</div>' +
            '<div class="flex-1 min-w-0 cursor-pointer" data-action="view">' +
                '<p class="text-slate-900 dark:text-white font-bold truncate">' + conn.fullName + '</p>' +
                '<p class="text-slate-500 dark:text-white/40 text-xs mt-0.5">' + arch + (reading ? ' · <span class="text-primary font-bold">' + reading.overall_score + '% uyum</span>' : ' · Exp: ' + exp) + '</p>' +
                '<p class="text-slate-400 dark:text-white/25 text-xs">' + shortDate(reading ? (reading.updated_at || reading.created_at) : conn.createdAt) + '</p>' +
            '</div>' +
            '<button class="flex items-center justify-center size-10 rounded-full hover:bg-red-500/20 transition-colors shrink-0 group" data-action="delete" data-name="' + conn.fullName + '">' +
                '<span class="material-symbols-outlined text-slate-300 dark:text-white/30 group-hover:text-red-500 transition-colors">delete</span>' +
            '</button>' +
            '<span class="material-symbols-outlined text-slate-300 dark:text-white/20 shrink-0 cursor-pointer" data-action="view">chevron_right</span>';

        card.addEventListener('click', function(e) {
            var target = e.target.closest('[data-action]');
            if (!target) return;

            var action = target.getAttribute('data-action');

            if (action === 'view') {
                window.location.href = 'kisi_profil.html?kisi=' + encodeURIComponent(conn.fullName);
            } else if (action === 'delete') {
                e.stopPropagation();
                var name = target.getAttribute('data-name');
                if (confirm('"' + name + '" profilini silmek istediğinize emin misiniz?\n\nBu işlem geri alınamaz.')) {
                    deleteConnection(name);
                }
            }
        });

        listEl.appendChild(card);
    });

    // ─── Okunmamış mesaj blink ─────────────────────────────
    function refreshChatBlinks() {
        if (!window.notificationEngine || !window.notificationEngine.getUnreadMessageSenders) return;
        var senders = window.notificationEngine.getUnreadMessageSenders();
        var cards = document.querySelectorAll('[data-chat-uid]');
        for (var i = 0; i < cards.length; i++) {
            var uid = cards[i].getAttribute('data-chat-uid');
            if (senders.indexOf(uid) !== -1) {
                cards[i].classList.add('card-unread');
            } else {
                cards[i].classList.remove('card-unread');
            }
        }
    }
    // notification-engine.js bu script'ten SONRA yükleniyor,
    // bu yüzden retry ile beklememiz gerekiyor
    function initBlinks() {
        if (!window.notificationEngine || !window.notificationEngine.onNewNotification) {
            setTimeout(initBlinks, 500);
            return;
        }
        // Realtime: yeni bildirim geldiğinde kartı yanıp söndür
        window.notificationEngine.onNewNotification(function(notif) {
            if (notif && notif.type === 'new_message') {
                refreshChatBlinks();
            }
        });
        // İlk yükleme: bildirimlerin Supabase'den yüklenmesini bekle
        refreshChatBlinks();
        setTimeout(refreshChatBlinks, 1500);
        setTimeout(refreshChatBlinks, 4000);
    }
    setTimeout(initBlinks, 300);

    // ─── Bildirim Kutucukları (Notification Inbox) ─────────
    (function() {
        if (!currentUserId || !window.supabaseClient) return;

        var NOTIF_ICON_MAP = {
            'connection_request': 'person_add',
            'connection_accepted': 'how_to_reg',
            'new_message': 'chat'
        };
        var NOTIF_TYPES = ['connection_request', 'connection_accepted', 'new_message'];

        function formatAgo(ts) {
            try {
                var diff = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
                if (diff < 60) return 'şimdi';
                if (diff < 3600) return Math.floor(diff / 60) + 'dk';
                if (diff < 86400) return Math.floor(diff / 3600) + 'sa';
                return Math.floor(diff / 86400) + 'g';
            } catch(e) { return ''; }
        }

        function getNotifText(n) {
            var p = n.payload || {};
            if (n.type === 'connection_request' && p.sender_name && p.sender_name !== 'User')
                return p.sender_name + ' bağlantı isteği gönderdi';
            if (n.type === 'connection_accepted' && p.accepter_name && p.accepter_name !== 'User')
                return p.accepter_name + ' isteğinizi kabul etti';
            if (n.type === 'new_message' && p.sender_name && p.sender_name !== 'User')
                return p.sender_name + ' mesaj gönderdi';
            if (n.type === 'connection_request') return 'Yeni bağlantı isteği';
            if (n.type === 'connection_accepted') return 'Bağlantı kabul edildi';
            if (n.type === 'new_message') return 'Yeni mesaj';
            return 'Bildirim';
        }

        function getNotifHref(n) {
            var p = n.payload || {};
            if (n.type === 'connection_request') return 'profile_soul_journey.html';
            if (n.type === 'connection_accepted') return null; // zaten bu sayfadayız
            if (n.type === 'new_message' && p.sender_id) return 'messaging.html?uid=' + encodeURIComponent(p.sender_id);
            return null;
        }

        function renderInbox(notifications) {
            var section = document.getElementById('notif-inbox-section');
            var list = document.getElementById('notif-inbox-list');
            if (!section || !list) return;

            list.innerHTML = '';
            if (!notifications || notifications.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            notifications.forEach(function(n) {
                var icon = NOTIF_ICON_MAP[n.type] || 'notifications';
                var text = getNotifText(n);
                var time = formatAgo(n.created_at);
                var isUnread = !n.is_read;

                var item = document.createElement('div');
                item.className = 'notif-inbox-item fade-in';
                item.setAttribute('data-notif-id', n.id);
                item.innerHTML =
                    '<div class="notif-inbox-icon">' +
                        '<span class="material-symbols-outlined" style="font-size:20px;color:#8b5cf6">' + icon + '</span>' +
                    '</div>' +
                    '<div class="flex-1 min-w-0">' +
                        '<p class="text-sm leading-snug ' + (isUnread ? 'text-slate-900 dark:text-white font-bold' : 'text-slate-600 dark:text-white/60') + '">' + text + '</p>' +
                        '<p class="text-[10px] mt-1 text-slate-400 dark:text-white/25">' + time + '</p>' +
                    '</div>' +
                    (isUnread ? '<div class="notif-inbox-dot"></div>' : '');

                item.addEventListener('click', function() {
                    // Okundu işaretle
                    if (isUnread && window.notificationEngine && window.notificationEngine.markAsRead) {
                        window.notificationEngine.markAsRead(n.id);
                        var dot = item.querySelector('.notif-inbox-dot');
                        if (dot) dot.remove();
                        var txt = item.querySelector('p');
                        if (txt) { txt.className = txt.className.replace('text-slate-900 dark:text-white font-bold', 'text-slate-600 dark:text-white/60'); }
                    }
                    var href = getNotifHref(n);
                    if (href) window.location.href = href;
                });

                list.appendChild(item);
            });
        }

        // Bildirimleri yükle
        async function loadInboxNotifs() {
            try {
                var res = await window.supabaseClient.from('notifications')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .in('type', NOTIF_TYPES)
                    .order('created_at', { ascending: false })
                    .limit(20);
                renderInbox(res.data || []);
            } catch(e) {
                console.warn('[ConnPage] Inbox load error:', e);
            }
        }

        // Tümünü okundu işaretle
        var markAllBtn = document.getElementById('notif-inbox-mark-all');
        if (markAllBtn) {
            markAllBtn.addEventListener('click', async function() {
                try {
                    await window.supabaseClient.from('notifications')
                        .update({ is_read: true })
                        .eq('user_id', currentUserId)
                        .eq('is_read', false)
                        .in('type', NOTIF_TYPES);
                    // UI güncelle
                    var dots = document.querySelectorAll('.notif-inbox-dot');
                    for (var d = 0; d < dots.length; d++) dots[d].remove();
                    var txts = document.querySelectorAll('#notif-inbox-list .notif-inbox-item p:first-child');
                    for (var t = 0; t < txts.length; t++) {
                        txts[t].className = txts[t].className
                            .replace('text-slate-900', 'text-slate-600')
                            .replace('dark:text-white font-bold', 'dark:text-white/60');
                    }
                } catch(e) { console.warn('[ConnPage] Mark all error:', e); }
            });
        }

        // Realtime: yeni bildirim gelince inbox'ı yenile
        function initRealtimeInbox() {
            try {
                window.supabaseClient.channel('conn-inbox-' + currentUserId)
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'notifications',
                        filter: 'user_id=eq.' + currentUserId
                    }, function() {
                        loadInboxNotifs();
                    })
                    .subscribe();
            } catch(e) {}
        }

        loadInboxNotifs();
        initRealtimeInbox();
    })();

    // ─── Silme fonksiyonu ──────────────────────────────────
    async function deleteConnection(fullName) {
        try {
            if (window.profile && window.profile.deleteConnection) {
                await window.profile.deleteConnection(fullName);
            } else {
                var userData = JSON.parse(localStorage.getItem('numerael_user_data') || '{}');
                var userId = userData.userId || 'default';
                var key = 'numerael_connections_' + userId;
                var conns = JSON.parse(localStorage.getItem(key) || '[]');
                conns = conns.filter(function(c) {
                    return c.fullName !== fullName;
                });
                localStorage.setItem(key, JSON.stringify(conns));
            }
            window.location.reload();
        } catch (error) {
            console.error('Delete error:', error);
        }
    }
});
</script>
<script src="js/notification-engine.js"></script>
<script src="js/bottom-nav.js"></script>
</body>
</html>
