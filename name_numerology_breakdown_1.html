<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Name Numerology Breakdown</title>
    <script src="js/theme-engine.js"></script>
    <script src="js/api-base.js"></script>
    <script src="js/tailwind.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;family=Noto+Sans:wght@400;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/play-billing.js"></script>
    <script src="js/premium.js"></script>
    <script src="js/gamification-engine.js"></script>
    <script src="js/profile.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f2cc0d",
                        "background-light": "#f8f8f5",
                        "background-dark": "#12110a",
                        "card-dark": "#221f10", "card-light": "#f5f5f0",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .cosmic-glow {
            box-shadow: 0 0 15px rgba(242, 204, 13, 0.3);
        }

        .letter-glow {
            text-shadow: 0 0 8px rgba(242, 204, 13, 0.6);
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            min-height: max(884px, 100dvh);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen">
    <header
        class="flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-50">
        <div onclick="window.location.href='mystic_numerology_home_1.html'"
            class="text-slate-900 dark:text-white flex size-12 shrink-0 items-center cursor-pointer">
            <span class="material-symbols-outlined">arrow_back_ios</span>
        </div>
        <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight flex-1 text-center">
            Name Analysis</h2>
        <div class="flex w-12 items-center justify-end">
            <button
                class="flex size-12 cursor-pointer items-center justify-center rounded-xl bg-transparent text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">info</span>
            </button>
        </div>
    </header>
    <main class="max-w-md mx-auto pb-10">
        <!-- Pythagorean sistem kullanƒ±lƒ±yor -->
        <section class="mt-4 px-4">
            <div class="flex flex-wrap justify-center gap-2 py-6">
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">1</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold">
                        A</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">3</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold text-slate-400 dark:text-white/50">
                        L</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">5</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold">
                        E</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">6</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold text-slate-400 dark:text-white/50">
                        X</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">1</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold">
                        A</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">5</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold text-slate-400 dark:text-white/50">
                        N</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">4</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold text-slate-400 dark:text-white/50">
                        D</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">5</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold">
                        E</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-primary text-xs font-bold mb-1 letter-glow">2</span>
                    <div
                        class="w-10 h-14 flex items-center justify-center border border-primary/30 bg-primary/5 rounded-lg text-2xl font-bold text-slate-400 dark:text-white/50">
                        R</div>
                </div>
            </div>
            <h1 id="name-display"
                class="text-slate-900 dark:text-white tracking-widest text-4xl font-extrabold leading-tight text-center mt-2">
                ALEXANDER</h1>
        </section>
        <section id="expression-section" class="flex flex-col items-center justify-center py-10 relative">
            <div class="relative size-56 flex items-center justify-center cursor-pointer" id="expression-circle">
                <svg class="absolute inset-0 size-full -rotate-90">
                    <circle class="text-slate-200 dark:text-white/10" cx="112" cy="112" fill="transparent" r="100"
                        stroke="currentColor" stroke-width="8"></circle>
                    <circle class="drop-shadow-[0_0_10px_rgba(242,204,13,0.5)]" cx="112" cy="112" fill="transparent"
                        r="100" stroke="#f2cc0d" stroke-dasharray="628" stroke-dashoffset="157" stroke-linecap="round"
                        stroke-width="12"></circle>
                </svg>
                <div class="text-center z-10">
                    <p class="text-slate-500 dark:text-primary/70 text-sm font-bold tracking-widest uppercase">
                        Expression</p>
                    <h3 id="expression-number" class="text-slate-900 dark:text-white text-7xl font-bold py-1">32</h3>
                    <div class="bg-primary px-3 py-1 rounded-full text-background-dark text-sm font-bold">Number 5</div>
                </div>
            </div>
            <p class="mt-2 text-center text-primary/50 text-xs uppercase tracking-wider">Tap to see calculation</p>
            <p id="expression-slogan" class="mt-2 text-center text-slate-500 dark:text-[#bab59c] text-sm px-8 italic">
                "The Catalyst of Change and Freedom"
            </p>
            <!-- Expression detail -->
            <div id="expression-detail" style="display:none;width:100%;max-width:90%;margin:16px auto 0;padding:16px;background:rgba(0,0,0,0.2);border:1px solid rgba(242,204,13,0.2);border-radius:12px"></div>
        </section>
        <section class="px-4 space-y-3">
            <div
                class="flex flex-col rounded-xl border border-primary/20 bg-white dark:bg-card-dark shadow-sm overflow-hidden">
                <button
                    class="w-full flex items-center justify-between p-5 text-left active:bg-slate-50 dark:active:bg-white/5 transition-colors">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <div
                            class="p-2.5 rounded-lg bg-primary/20 text-primary flex items-center justify-center shrink-0">
                            <span class="material-symbols-outlined text-2xl">favorite</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1.5 flex-wrap">
                                <h2 class="text-slate-900 dark:text-white text-lg font-bold">Soul Urge</h2>
                                <span
                                    class="px-1.5 py-0.5 rounded bg-primary text-background-dark text-[10px] font-black leading-none uppercase tracking-tighter shrink-0">Inner</span>
                                <span
                                    class="px-1.5 py-0.5 rounded bg-primary/10 text-primary text-[10px] font-bold leading-none uppercase tracking-tight border border-primary/20 shrink-0">THE
                                    MYSTIC</span>
                            </div>
                            <p class="text-slate-500 dark:text-[#bab59c] text-sm mt-0.5 line-clamp-1">A deep seeker of
                                truth craving spiritual understanding.</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 ml-2 shrink-0">
                        <div class="text-primary text-3xl font-black">7</div>
                        <span class="material-symbols-outlined text-slate-400">expand_more</span>
                    </div>
                </button>
            </div>
            <div
                class="flex flex-col rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-card-dark shadow-sm overflow-hidden">
                <button
                    class="w-full flex items-center justify-between p-5 text-left active:bg-slate-50 dark:active:bg-white/5 transition-colors">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <div
                            class="p-2.5 rounded-lg bg-slate-100 dark:bg-white/10 text-slate-400 dark:text-white/60 flex items-center justify-center shrink-0">
                            <span class="material-symbols-outlined text-2xl">person</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1.5 flex-wrap">
                                <h2 class="text-slate-900 dark:text-white text-lg font-bold">Personality</h2>
                                <span
                                    class="px-1.5 py-0.5 rounded bg-slate-100 dark:bg-white/10 text-slate-400 dark:text-white/60 text-[10px] font-black leading-none uppercase tracking-tighter shrink-0">Outer</span>
                                <span
                                    class="px-1.5 py-0.5 rounded bg-primary/10 text-primary text-[10px] font-bold leading-none uppercase tracking-tight border border-primary/20 shrink-0">THE
                                    SCHOLAR</span>
                            </div>
                            <p class="text-slate-500 dark:text-[#bab59c] text-sm mt-0.5 line-clamp-1">Perceived as
                                reserved, analytical, and highly competent.</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 ml-2 shrink-0">
                        <div class="text-slate-900 dark:text-white text-3xl font-black">25<span
                                class="text-sm font-bold text-slate-500 ml-0.5">/7</span></div>
                        <span class="material-symbols-outlined text-slate-400">expand_more</span>
                    </div>
                </button>
            </div>
            <div id="life-path-card"
                class="flex flex-col rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-card-dark shadow-sm overflow-hidden">
                <button
                    class="w-full flex items-center justify-between p-5 text-left active:bg-slate-50 dark:active:bg-white/5 transition-colors">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <div
                            class="p-2.5 rounded-lg bg-primary/10 text-primary/80 flex items-center justify-center shrink-0">
                            <span class="material-symbols-outlined text-2xl">route</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1.5 flex-wrap">
                                <h2 class="text-slate-900 dark:text-white text-lg font-bold">Life Path</h2>
                                <span
                                    class="px-1.5 py-0.5 rounded bg-primary/20 text-primary text-[10px] font-black leading-none uppercase tracking-tighter shrink-0">Destiny</span>
                                <span
                                    class="px-1.5 py-0.5 rounded bg-primary/10 text-primary text-[10px] font-bold leading-none uppercase tracking-tight border border-primary/20 shrink-0">THE
                                    NOMAD</span>
                            </div>
                            <p class="text-slate-500 dark:text-[#bab59c] text-sm mt-0.5 line-clamp-1">Your destiny's
                                blueprint, guiding your ultimate purpose and growth.</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 ml-2 shrink-0">
                        <div class="text-slate-900 dark:text-white text-3xl font-black">11</div>
                        <span class="material-symbols-outlined text-slate-400">expand_more</span>
                    </div>
                </button>
            </div>
            <!-- ‚ïê‚ïê‚ïê KARMƒ∞C BOND KARTI ‚ïê‚ïê‚ïê -->
            <div id="karmic-bond-card"
                class="flex flex-col rounded-xl border border-red-500/30 bg-white dark:bg-card-dark shadow-sm overflow-hidden">
                <button id="karmic-bond-btn"
                    class="w-full flex items-center justify-between p-5 text-left active:bg-slate-50 dark:active:bg-white/5 transition-colors">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <div class="p-2.5 rounded-lg bg-red-500/15 text-red-400 flex items-center justify-center shrink-0">
                            <span class="material-symbols-outlined text-2xl">cycle</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1.5 flex-wrap">
                                <h2 class="text-slate-900 dark:text-white text-lg font-bold">Karmic Bond</h2>
                                <span class="px-1.5 py-0.5 rounded bg-red-500/20 text-red-400 text-[10px] font-black leading-none uppercase tracking-tighter shrink-0">Debt</span>
                                <span id="karmic-badge" class="px-1.5 py-0.5 rounded bg-red-500/10 text-red-400 text-[10px] font-bold leading-none uppercase tracking-tight border border-red-500/20 shrink-0">‚Äî</span>
                            </div>
                            <p class="text-slate-500 dark:text-[#bab59c] text-sm mt-0.5 line-clamp-1">Ge√ßmi≈ü ya≈üamdan gelen karmik bor√ß ve dersin analizi.</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 ml-2 shrink-0">
                        <div id="karmic-number" class="text-red-400 text-3xl font-black">‚Äî</div>
                        <span id="karmic-expand-icon" class="material-symbols-outlined text-slate-400">expand_more</span>
                    </div>
                </button>
                <!-- ƒ∞√ßerik alanƒ± -->
                <div id="karmic-content" style="display:none;">
                    <div style="padding:0 20px 20px;">
                        <!-- Transparency Box -->
                        <div id="karmic-transparency" style="background:rgba(239,68,77,0.1);border:1px solid rgba(239,68,77,0.3);border-radius:8px;padding:12px;margin-bottom:12px"></div>
                        <div id="karmic-ai-text" style="color:rgba(186,181,156,0.9);font-size:14px;line-height:1.75;"></div>
                        <!-- Numeroloji Ustasƒ± Butonu -->
                        <div id="karmic-master-btn-wrap" style="margin-top:16px;display:none;">
                            <button id="btn-goto-master"
                                style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#7f1313,#c0392b);color:white;border:none;border-radius:12px;padding:14px;font-size:13px;font-weight:800;letter-spacing:0.05em;cursor:pointer;text-transform:uppercase;">
                                <span class="material-symbols-outlined" style="font-size:18px;">psychology</span>
                                Numeroloji Ustasƒ±na Sor
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <div class="grid grid-cols-2 gap-3 p-4">
            <div class="flex flex-col gap-2 rounded-xl bg-primary/5 border border-primary/10 p-4">
                <span class="material-symbols-outlined text-primary">auto_awesome</span>
                <p class="text-xs font-bold text-primary tracking-widest uppercase">Key Energy</p>
                <p class="text-slate-900 dark:text-white text-base font-bold">Adaptability</p>
            </div>
            <div class="flex flex-col gap-2 rounded-xl bg-slate-100 dark:bg-white/5 border border-white/5 p-4">
                <span class="material-symbols-outlined text-slate-400">psychology</span>
                <p class="text-xs font-bold text-slate-400 tracking-widest uppercase">Focus</p>
                <p class="text-slate-900 dark:text-white text-base font-bold">Intellect</p>
            </div>
        </div>
        <!-- ‚ïê‚ïê‚ïê CONTEXT-AWARE INSIGHT ‚ïê‚ïê‚ïê -->
        <section id="context-insight-section" class="px-4 pb-4" style="display:none;">
            <div class="rounded-xl border border-primary/20 bg-card-light dark:bg-card-dark overflow-hidden">
                <div class="p-4 border-b border-slate-200 dark:border-white/5">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="material-symbols-outlined text-primary text-lg">neurology</span>
                        <h3 class="text-slate-900 dark:text-white font-bold text-sm tracking-wide">Baƒülamsal Analiz</h3>
                        <span class="px-1.5 py-0.5 rounded bg-primary/15 text-primary text-[9px] font-black uppercase tracking-wider">AI</span>
                    </div>
                    <p class="text-slate-500 dark:text-white/40 text-xs">Sayƒ±larƒ±n + zaman baƒülamƒ±nƒ±n birle≈üik yorumu</p>
                </div>
                <!-- Period Tags -->
                <div id="ctx-period-tags" class="flex flex-wrap gap-2 px-4 pt-3 pb-1" style="display:none;"></div>
                <!-- Intensity Bar -->
                <div id="ctx-intensity-bar" class="px-4 py-2" style="display:none;">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-slate-500 dark:text-white/30 text-[10px] font-bold uppercase tracking-widest">Yoƒüunluk</span>
                        <span id="ctx-intensity-val" class="text-primary text-xs font-bold"></span>
                    </div>
                    <div class="h-1.5 bg-slate-200 dark:bg-white/5 rounded-full overflow-hidden">
                        <div id="ctx-intensity-fill" class="h-full rounded-full transition-all" style="width:0%;background:linear-gradient(90deg,#f2cc0d,#ef4444);"></div>
                    </div>
                </div>
                <!-- Mod√ºller -->
                <div id="ctx-modules" class="p-4 space-y-4">
                    <div class="flex items-center gap-2 py-6 justify-center" style="color:rgba(242,204,13,0.4);font-size:13px;">
                        <span class="material-symbols-outlined" style="animation:spin 2s linear infinite;font-size:16px;">autorenew</span>
                        <span>Baƒülamsal analiz hazƒ±rlanƒ±yor...</span>
                    </div>
                </div>
            </div>
        </section>

        <div class="px-4 py-6">
            <button id="view-detailed-reading-btn"
                onclick="(function(){ var p = new URLSearchParams(window.location.search); var k = p.get('kisi'); var r = 'past_reading_archive_detail.html' + (k ? '?kisi=' + encodeURIComponent(k) : ''); if (window.premium && window.premium.isPremium()) { window.location.href = r; } else { window.location.href = 'premium_crystal_store.html?return=' + encodeURIComponent(r); } })();"
                class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-background-dark py-4 rounded-xl font-bold text-lg transition-transform active:scale-95">
                <span class="material-symbols-outlined">menu_book</span>
                View Detailed Reading
            </button>
        </div>
    </main>
    <div class="fixed top-0 left-0 w-full h-full pointer-events-none -z-10 overflow-hidden opacity-30 dark:opacity-20">
        <div class="absolute -top-20 -right-20 size-80 rounded-full bg-primary/20 blur-[100px]"></div>
        <div class="absolute bottom-40 -left-20 size-60 rounded-full bg-primary/10 blur-[80px]"></div>
    </div>





    <!-- ‚ïê‚ïê‚ïê NUMEROLOJƒ∞ USTASI CHAT MODAL ‚ïê‚ïê‚ïê -->
    <div id="master-modal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);flex-direction:column;">
        <div style="display:flex;flex-direction:column;height:100%;max-width:480px;margin:0 auto;position:relative;">
            <!-- Modal Header -->
            <div style="background:linear-gradient(135deg,#1a0808,#2d1010);border-bottom:1px solid rgba(192,57,43,0.3);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#7f1313,#c0392b);display:flex;align-items:center;justify-content:center;border:2px solid rgba(192,57,43,0.5);">
                        <span class="material-symbols-outlined" style="color:white;font-size:20px;">psychology</span>
                    </div>
                    <div>
                        <p style="color:white;font-weight:800;font-size:14px;letter-spacing:0.05em;">NUMEROLOJƒ∞ USTASI</p>
                        <p style="color:rgba(255,255,255,0.4);font-size:11px;">Karmik sorularƒ±nƒ±zƒ± yanƒ±tlƒ±yor</p>
                    </div>
                </div>
                <button onclick="closeMasterModal()" style="background:rgba(255,255,255,0.1);border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:white;">
                    <span class="material-symbols-outlined" style="font-size:20px;">close</span>
                </button>
            </div>
            <!-- Mesajlar -->
            <div id="master-messages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;"></div>
            <!-- Input -->
            <div style="padding:12px 16px;background:#1a1711;border-top:1px solid rgba(255,255,255,0.08);flex-shrink:0;display:flex;gap:8px;">
                <input id="master-input" type="text" placeholder="Karmik borcunuz hakkƒ±nda sorun..."
                    style="flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:12px 16px;color:white;font-size:14px;outline:none;font-family:'Space Grotesk',sans-serif;" />
                <button id="master-send"
                    style="background:linear-gradient(135deg,#7f1313,#c0392b);border:none;border-radius:12px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                    <span class="material-symbols-outlined" style="color:white;font-size:20px;">send</span>
                </button>
            </div>
        </div>
    </div>

    <script src="js/numerology-engine.js"></script>
    <script src="js/numerology-context-engine.js"></script>
    <script src="js/decision-timing-engine.js"></script>
    <script src="js/numerology-ai.js"></script>
    <script>
        // ‚îÄ‚îÄ‚îÄ Numeroloji hesaplamalarƒ± (PYTHAGOREAN Sƒ∞STEM) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var PYTHAGOREAN = { A: 1, B: 2, C: 3, D: 4, E: 5, F: 6, G: 7, H: 8, I: 9, J: 1, K: 2, L: 3, M: 4, N: 5, O: 6, P: 7, Q: 8, R: 9, S: 1, T: 2, U: 3, V: 4, W: 5, X: 6, Y: 7, Z: 8, '≈û': 1, '√á': 3, '√ú': 3, '√ñ': 6, 'ƒû': 7, 'ƒ∞': 9 };
        var VOWELS = 'AEIOUƒ∞I√ñ√ú';
        function reduce(n) { while (n > 9 && n !== 11 && n !== 22 && n !== 33) { n = String(n).split('').reduce(function (a, d) { return a + parseInt(d); }, 0); } return n; }

        // Theme-aware color helper for inline styles
        function _tc(darkColor, lightColor) {
            var isDark = document.documentElement.classList.contains('dark');
            return isDark ? darkColor : lightColor;
        }

        // Detaylƒ± hesaplama breakdown fonksiyonlarƒ±
        function getExpressionBreakdown(name) {
            var clean = name.toUpperCase().replace(/[^A-Z√áƒûƒ∞I√ñ≈û√ú]/g, '');
            var letters = clean.split('');
            var values = letters.map(function(c) { return PYTHAGOREAN[c] || 0; });
            var sum = values.reduce(function(a,x){return a+x;},0);
            var steps = [];
            var current = sum;
            steps.push(sum);
            while (current > 9 && current !== 11 && current !== 22 && current !== 33) {
                current = String(current).split('').reduce(function(a,d){return a+parseInt(d);},0);
                steps.push(current);
            }
            return {
                letters: letters,
                values: values,
                sum: sum,
                steps: steps,
                final: current
            };
        }
        
        function getSoulUrgeBreakdown(name) {
            var clean = name.toUpperCase().replace(/[^A-Z√áƒûƒ∞I√ñ≈û√ú]/g, '');
            var vowels = clean.split('').filter(function(c){ return VOWELS.includes(c); });
            var values = vowels.map(function(c) { return PYTHAGOREAN[c] || 0; });
            var sum = values.reduce(function(a,x){return a+x;},0);
            var steps = [];
            var current = sum;
            steps.push(sum);
            while (current > 9 && current !== 11 && current !== 22 && current !== 33) {
                current = String(current).split('').reduce(function(a,d){return a+parseInt(d);},0);
                steps.push(current);
            }
            return {
                vowels: vowels,
                values: values,
                sum: sum,
                steps: steps,
                final: current
            };
        }
        
        function getPersonalityBreakdown(name) {
            var clean = name.toUpperCase().replace(/[^A-Z√áƒûƒ∞I√ñ≈û√ú]/g, '');
            var consonants = clean.split('').filter(function(c){ return !VOWELS.includes(c); });
            var values = consonants.map(function(c) { return PYTHAGOREAN[c] || 0; });
            var sum = values.reduce(function(a,x){return a+x;},0);
            var steps = [];
            var current = sum;
            steps.push(sum);
            while (current > 9 && current !== 11 && current !== 22 && current !== 33) {
                current = String(current).split('').reduce(function(a,d){return a+parseInt(d);},0);
                steps.push(current);
            }
            return {
                consonants: consonants,
                values: values,
                sum: sum,
                steps: steps,
                final: current
            };
        }
        
        function getLifePathBreakdown(dateStr) {
            var digits = dateStr.replace(/\D/g, '').split('').map(Number);
            var sum = digits.reduce(function(a,x){return a+x;},0);
            var steps = [];
            var current = sum;
            steps.push(sum);
            while (current > 9 && current !== 11 && current !== 22 && current !== 33) {
                current = String(current).split('').reduce(function(a,d){return a+parseInt(d);},0);
                steps.push(current);
            }
            return {
                digits: digits,
                sum: sum,
                steps: steps,
                final: current
            };
        }
        
        function calcExpression(name) { return reduce(name.toUpperCase().replace(/[^A-Z√áƒûƒ∞I√ñ≈û√ú]/g, '').split('').reduce(function (s, c) { return s + (PYTHAGOREAN[c] || 0); }, 0)); }
        function calcSoulUrge(name) { return reduce(name.toUpperCase().replace(/[^A-Z√áƒûƒ∞I√ñ≈û√ú]/g, '').split('').reduce(function (s, c) { return s + (VOWELS.includes(c) ? PYTHAGOREAN[c] || 0 : 0); }, 0)); }
        function calcPersonality(name) { return reduce(name.toUpperCase().replace(/[^A-Z√áƒûƒ∞I√ñ≈û√ú]/g, '').split('').reduce(function (s, c) { return s + (!VOWELS.includes(c) && c != ' ' ? PYTHAGOREAN[c] || 0 : 0); }, 0)); }
        function calcLifePath(dateStr) { 
            // Doƒüru Life Path algoritmasƒ±: T√ºm rakamlarƒ± topla
            console.log('[Life Path Debug] Input:', dateStr);
            if (!dateStr) return 1;
            var digits = dateStr.replace(/\D/g, '').split('').map(Number);
            console.log('[Life Path Debug] Digits:', digits);
            if (digits.length === 0) return 1;
            var sum = digits.reduce(function(a, x) { return a + x; }, 0);
            console.log('[Life Path Debug] Sum:', sum);
            var result = reduce(sum);
            console.log('[Life Path Debug] Final:', result);
            return result;
        }

        // ‚îÄ‚îÄ‚îÄ Sayfa Ba≈ülatƒ±cƒ± ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.addEventListener('DOMContentLoaded', async function () {
            // Auth hazƒ±r olana kadar bekle (Supabase'den g√ºncel veri gelsin)
            if (window.auth && window.auth.whenReady) { await window.auth.whenReady(); }
            // 1. Veri Hazƒ±rlƒ±ƒüƒ±
            var params = new URLSearchParams(window.location.search);
            var kisiParam = params.get('kisi');
            var name, birthDate;

            if (kisiParam) {
                // ‚ïê‚ïê‚ïê BA≈ûKA Bƒ∞Rƒ∞Nƒ∞N PROFƒ∞Lƒ∞ ‚ïê‚ïê‚ïê
                name = kisiParam;
                birthDate = params.get('dt') || '';

                // Kaynak 1: numerael_kisi_temp (kisi_profil.html'den geliyorsa)
                try {
                    var tempKisi = JSON.parse(localStorage.getItem('numerael_kisi_temp') || 'null');
                    if (tempKisi && tempKisi.isTemp && tempKisi.birthDate) {
                        name = tempKisi.name || tempKisi.fullName || kisiParam;
                        birthDate = tempKisi.birthDate;
                        console.log('[Breakdown] Ki≈üi temp verisi bulundu:', name, birthDate);
                    }
                } catch(e) {}

                // Kaynak 2: Supabase discovery_profiles
                if (!birthDate && window.supabaseClient) {
                    try {
                        var dpRes = await window.supabaseClient.from('discovery_profiles')
                            .select('full_name, birth_date, gender')
                            .ilike('full_name', '%' + kisiParam + '%')
                            .limit(1).maybeSingle();
                        if (dpRes.data && dpRes.data.birth_date) {
                            name = dpRes.data.full_name || kisiParam;
                            birthDate = dpRes.data.birth_date;
                            console.log('[Breakdown] Supabase discovery_profiles:', name, birthDate);
                        }
                    } catch(e) {}
                }

                // Kaynak 3: Supabase profiles tablosu
                if (!birthDate && window.supabaseClient) {
                    try {
                        var profRes = await window.supabaseClient.from('profiles')
                            .select('full_name, birth_date, gender')
                            .ilike('full_name', '%' + kisiParam + '%')
                            .limit(1).maybeSingle();
                        if (profRes.data && profRes.data.birth_date) {
                            name = profRes.data.full_name || kisiParam;
                            birthDate = profRes.data.birth_date;
                            console.log('[Breakdown] Supabase profiles:', name, birthDate);
                        }
                    } catch(e) {}
                }

                // Kaynak 4: localStorage connections
                if (!birthDate && window.profile) {
                    try {
                        var conn = await window.profile.getConnectionDetail(kisiParam);
                        if (conn && conn.birthDate) {
                            name = conn.fullName || kisiParam;
                            birthDate = conn.birthDate;
                        }
                    } catch(e) {}
                }

                if (!birthDate) birthDate = '1990-01-01';
            } else {
                // ‚ïê‚ïê‚ïê ANA KULLANICININ PROFƒ∞Lƒ∞ ‚ïê‚ïê‚ïê
                var userData = {};
                try { userData = JSON.parse(localStorage.getItem('numerael_user_data') || '{}'); } catch (e) {}
                name = userData.name || 'Alexander';
                birthDate = userData.birthDate || '1990-01-01';
            }
            
            console.log('[Main Debug] Name:', name);
            console.log('[Main Debug] BirthDate:', birthDate);

            // 2. Hesaplamalar
            var lpNum = calcLifePath(birthDate);
            var expNum = calcExpression(name);
            var soulNum = calcSoulUrge(name);
            var persNum = calcPersonality(name);
            
            console.log('[Main Debug] Life Path:', lpNum);
            console.log('[Main Debug] Expression:', expNum);
            console.log('[Main Debug] Soul Urge:', soulNum);
            console.log('[Main Debug] Personality:', persNum);

            // 3. UI G√ºncelleme (Statik Alanlar)
            var nameUpper = name.toUpperCase();
            var nameTitle = document.querySelector('h1.tracking-widest.text-4xl, h1.font-extrabold');
            if (nameTitle) nameTitle.textContent = nameUpper;

            var bigExp = document.querySelector('h3.text-7xl');
            if (bigExp) bigExp.textContent = expNum;
            
            // Expression calculation detail
            var expBreakdown = getExpressionBreakdown(name);
            var expCircle = document.getElementById('expression-circle');
            var expDetail = document.getElementById('expression-detail');
            var expSlogan = document.getElementById('expression-slogan');
            
            if (expCircle && expDetail) {
                expCircle.addEventListener('click', function() {
                    var isHidden = expDetail.style.display === 'none';
                    if (isHidden) {
                        // Generate content
                        var html = '<div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid ' + _tc('rgba(255,255,255,0.05)','rgba(0,0,0,0.06)') + '">';
                        html += '<div style="color:#f2cc0d;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px">üìä EXPRESSION NUMBER CALCULATION</div>';
                        html += '<div style="color:' + _tc('rgba(255,255,255,0.6)','rgba(51,65,85,0.7)') + ';font-size:12px;margin-bottom:8px">Source: ALL LETTERS (Full Name)</div>';
                        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
                        expBreakdown.letters.forEach(function(letter, idx) {
                            html += '<div style="background:rgba(242,204,13,0.15);border:1px solid rgba(242,204,13,0.3);border-radius:6px;padding:4px 8px;display:flex;gap:4px;align-items:center">';
                            html += '<span style="color:#f2cc0d;font-weight:700;font-size:13px">' + letter + '</span>';
                            html += '<span style="color:' + _tc('rgba(255,255,255,0.4)','rgba(100,116,139,0.6)') + ';font-size:11px">‚Üí</span>';
                            html += '<span style="color:' + _tc('rgba(255,255,255,0.7)','#334155') + ';font-size:12px">' + expBreakdown.values[idx] + '</span>';
                            html += '</div>';
                        });
                        html += '</div>';

                        // Reduction steps
                        if (expBreakdown.steps.length > 1) {
                            html += '<div style="margin-top:8px">';
                            html += '<div style="color:' + _tc('rgba(255,255,255,0.5)','rgba(100,116,139,0.7)') + ';font-size:11px;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px">Reduction Steps:</div>';
                            html += '<div style="font-family:monospace;color:#f2cc0d;font-size:13px;font-weight:600">';
                            expBreakdown.steps.forEach(function(step, idx) {
                                html += step;
                                if (idx < expBreakdown.steps.length - 1) {
                                    html += ' ‚Üí ';
                                }
                            });
                            html += '</div>';
                            html += '</div>';
                        }
                        
                        html += '</div>';
                        html += '<div style="color:rgba(186,181,156,0.8);font-size:13px;line-height:1.6">Final Result: <strong style="color:#f2cc0d;font-size:18px">' + expBreakdown.final + '</strong></div>';
                        expDetail.innerHTML = html;
                        expDetail.style.display = 'block';
                    } else {
                        expDetail.style.display = 'none';
                    }
                });
            }
            var expBadge = document.querySelector('.bg-primary.px-3.py-1.rounded-full');
            if (expBadge) expBadge.textContent = 'Number ' + expNum;

            // Harf kutularƒ±nƒ± g√ºncelle
            var letterContainer = document.querySelector('.flex.flex-wrap.justify-center.gap-2.py-6');
            if (letterContainer) {
                var chars = nameUpper.replace(/[^A-Z√áƒûƒ∞I√ñ≈û√ú]/g, '').split('');
                letterContainer.innerHTML = chars.map(function (c) {
                    var v = PYTHAGOREAN[c] || 0;
                    var isVowel = VOWELS.includes(c);
                    return '<div class="flex flex-col items-center">' +
                        '<span class="text-primary text-xs font-bold mb-1 letter-glow">' + v + '</span>' +
                        '<div class="w-10 h-14 flex items-center justify-center border ' + (isVowel ? 'border-primary bg-primary/10' : 'border-primary/30 bg-primary/5') + ' rounded-lg text-2xl font-bold">' + c + '</div>' +
                        '</div>';
                }).join('');
            }

            // Kartlardaki sayƒ±larƒ± g√ºncelle VE hesaplama detaylarƒ± ekle
            var accordionSection = document.querySelector('section.px-4.space-y-3');
            console.log('[Accordion Debug] Section found:', accordionSection);
            if (accordionSection) {
                var cards = accordionSection.querySelectorAll(':scope > div');
                console.log('[Accordion Debug] Cards found:', cards.length);
                
                // Hesaplama breakdownlarƒ±
                var soulBreakdown = getSoulUrgeBreakdown(name);
                var persBreakdown = getPersonalityBreakdown(name);
                var lpBreakdown = getLifePathBreakdown(birthDate);
                
                console.log('[Accordion Debug] Breakdowns:', { soul: soulBreakdown, pers: persBreakdown, lp: lpBreakdown });
                
                var cardMapping = [
                    { num: soulNum, breakdown: soulBreakdown, type: 'soul' },
                    { num: persNum, breakdown: persBreakdown, type: 'personality' },
                    { num: lpNum, breakdown: lpBreakdown, type: 'lifepath' }
                ];
                
                cards.forEach(function (card, i) {
                    if (cardMapping[i]) {
                        // Sayƒ±yƒ± g√ºncelle
                        var numDisplay = card.querySelector('.text-3xl.font-black');
                        if (numDisplay) {
                            numDisplay.innerHTML = cardMapping[i].num + (i === 1 && cardMapping[i].num > 9 ? '<span class="text-sm font-bold text-slate-500 ml-0.5">/' + reduce(cardMapping[i].num) + '</span>' : '');
                        }
                        
                        // Hesaplama detayƒ± accordion i√ßeriƒüi olu≈ütur
                        var breakdown = cardMapping[i].breakdown;
                        var contentHTML = '<div style="padding:16px 20px;border-top:1px solid ' + _tc('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + ';background:' + _tc('rgba(0,0,0,0.2)','rgba(0,0,0,0.03)') + '">';
                        contentHTML += '<div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid ' + _tc('rgba(255,255,255,0.05)','rgba(0,0,0,0.06)') + '">';
                        contentHTML += '<div style="color:#f2cc0d;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px">üìä CALCULATION TRANSPARENCY</div>';

                        if (cardMapping[i].type === 'soul') {
                            contentHTML += '<div style="color:' + _tc('rgba(255,255,255,0.6)','rgba(51,65,85,0.7)') + ';font-size:12px;margin-bottom:8px">Source: VOWELS ONLY (A,E,I,O,U)</div>';
                            contentHTML += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
                            breakdown.vowels.forEach(function(v, idx) {
                                contentHTML += '<div style="background:rgba(242,204,13,0.15);border:1px solid rgba(242,204,13,0.3);border-radius:6px;padding:4px 8px;display:flex;gap:4px;align-items:center">';
                                contentHTML += '<span style="color:#f2cc0d;font-weight:700;font-size:13px">' + v + '</span>';
                                contentHTML += '<span style="color:' + _tc('rgba(255,255,255,0.4)','rgba(100,116,139,0.6)') + ';font-size:11px">‚Üí</span>';
                                contentHTML += '<span style="color:' + _tc('rgba(255,255,255,0.7)','#334155') + ';font-size:12px">' + breakdown.values[idx] + '</span>';
                                contentHTML += '</div>';
                            });
                            contentHTML += '</div>';
                            if (breakdown.vowels.length === 0) {
                                contentHTML += '<div style="color:#ef4444;font-size:13px;font-weight:600">‚ö† No vowels detected</div>';
                            }
                        } else if (cardMapping[i].type === 'personality') {
                            contentHTML += '<div style="color:' + _tc('rgba(255,255,255,0.6)','rgba(51,65,85,0.7)') + ';font-size:12px;margin-bottom:8px">Source: CONSONANTS ONLY</div>';
                            contentHTML += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
                            breakdown.consonants.forEach(function(c, idx) {
                                contentHTML += '<div style="background:' + _tc('rgba(255,255,255,0.08)','rgba(0,0,0,0.05)') + ';border:1px solid ' + _tc('rgba(255,255,255,0.15)','rgba(0,0,0,0.1)') + ';border-radius:6px;padding:4px 8px;display:flex;gap:4px;align-items:center">';
                                contentHTML += '<span style="color:' + _tc('rgba(255,255,255,0.9)','#0f172a') + ';font-weight:700;font-size:13px">' + c + '</span>';
                                contentHTML += '<span style="color:' + _tc('rgba(255,255,255,0.4)','rgba(100,116,139,0.6)') + ';font-size:11px">‚Üí</span>';
                                contentHTML += '<span style="color:' + _tc('rgba(255,255,255,0.7)','#334155') + ';font-size:12px">' + breakdown.values[idx] + '</span>';
                                contentHTML += '</div>';
                            });
                            contentHTML += '</div>';
                        } else if (cardMapping[i].type === 'lifepath') {
                            contentHTML += '<div style="color:' + _tc('rgba(255,255,255,0.6)','rgba(51,65,85,0.7)') + ';font-size:12px;margin-bottom:8px">Source: ALL DATE DIGITS</div>';
                            contentHTML += '<div style="font-family:monospace;background:' + _tc('rgba(0,0,0,0.3)','rgba(0,0,0,0.04)') + ';border:1px solid ' + _tc('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + ';border-radius:6px;padding:10px;margin-bottom:8px">';
                            contentHTML += '<div style="color:' + _tc('rgba(255,255,255,0.9)','#0f172a') + ';font-size:13px">' + breakdown.digits.join(' + ') + ' = ' + breakdown.sum + '</div>';
                            contentHTML += '</div>';
                        }

                        // Reduction steps
                        if (breakdown.steps.length > 1) {
                            contentHTML += '<div style="margin-top:8px">';
                            contentHTML += '<div style="color:' + _tc('rgba(255,255,255,0.5)','rgba(100,116,139,0.7)') + ';font-size:11px;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px">Reduction Steps:</div>';
                            contentHTML += '<div style="font-family:monospace;color:#f2cc0d;font-size:13px;font-weight:600">';
                            breakdown.steps.forEach(function(step, idx) {
                                contentHTML += step;
                                if (idx < breakdown.steps.length - 1) {
                                    contentHTML += ' ‚Üí ';
                                }
                            });
                            contentHTML += '</div>';
                            contentHTML += '</div>';
                        }
                        
                        contentHTML += '</div>';
                        contentHTML += '<div style="color:rgba(186,181,156,0.8);font-size:13px;line-height:1.6">Final Result: <strong style="color:#f2cc0d;font-size:16px">' + breakdown.final + '</strong></div>';
                        contentHTML += '</div>';
                        
                        // Accordion contentDiv olu≈ütur ve ekle
                        var existingContent = card.querySelector('[data-accordion-content]');
                        if (!existingContent) {
                            var contentDiv = document.createElement('div');
                            contentDiv.setAttribute('data-accordion-content', 'true');
                            contentDiv.style.display = 'none';
                            contentDiv.innerHTML = contentHTML;
                            card.appendChild(contentDiv);
                            
                            // Button click handler
                            var btn = card.querySelector('button');
                            if (btn) {
                                btn.style.cursor = 'pointer';
                                btn.addEventListener('click', function() {
                                    var icon = btn.querySelector('.material-symbols-outlined:last-child');
                                    var isHidden = contentDiv.style.display === 'none';
                                    contentDiv.style.display = isHidden ? 'block' : 'none';
                                    if (icon) icon.textContent = isHidden ? 'expand_less' : 'expand_more';
                                });
                            }
                        }
                    }
                });
            }

            // 4. Dinamik Slogan
            var descMap = {
                1: "The Independent Force and Pioneer",
                2: "The Harmonious Partner and Diplomat",
                3: "The Creative Soul and Communicator",
                4: "The Practical Master and Builder",
                5: "The Catalyst of Change and Freedom",
                6: "The Nurturing Heart and Caretaker",
                7: "The Seeker of Wisdom and Truth",
                8: "The Powerful Manifestor and Leader",
                9: "The Universal Soul and Philanthropist",
                11: "The Intuitive Visionary and Guide",
                22: "The Master Architect of Reality",
                33: "The Compassionate Spiritual Teacher"
            };
            var slogan = document.querySelector('p.italic');
            if (slogan) slogan.textContent = '"' + (descMap[expNum] || "A Soul Guided by Eternal Vibration") + '"';

            // 5. Navigasyon
            document.querySelectorAll('button, span, div').forEach(function (el) {
                var txt = el.textContent || '';
                var html = el.innerHTML || '';
                if (html.includes('arrow_back_ios')) {
                    el.onclick = function () { window.location.href = 'mystic_numerology_home_1.html'; };
                }
            });
            
            // View Detailed Reading butonu artƒ±k inline onclick ile √ßalƒ±≈üƒ±yor
        });
    </script>
    <!-- accordion-ai.js kaldƒ±rƒ±ldƒ± ‚Äî numerology-engine.js tarafƒ±ndan y√∂netiliyor -->


    <!-- ‚ïê‚ïê‚ïê KARMƒ∞C BOND MOTORU ‚ïê‚ïê‚ïê -->
    <script>
    (function() {
        // Karmik bor√ß sayƒ±larƒ±
        var KARMIC_DEBTS = [13, 14, 16, 19];
        var KARMIC_INFO = {
            13: { label: '13/4', theme: 'Tembellik & Disiplin', desc: 'Ge√ßmi≈üte sorumluluktan ka√ßƒ±≈ü. Bu ya≈üamda disiplin ve √ßalƒ±≈ükanlƒ±k ders.' },
            14: { label: '14/5', theme: '√ñzg√ºrl√ºƒü√ºn K√∂t√ºye Kullanƒ±mƒ±', desc: 'A≈üƒ±rƒ±lƒ±k ve baƒüƒ±mlƒ±lƒ±k d√∂ng√ºs√º. Denge ve √∂z-kontrol bu ya≈üamƒ±n anahtarƒ±.' },
            16: { label: '16/7', theme: 'Ego & Kibir', desc: 'Ego kaynaklƒ± yƒ±kƒ±m. Al√ßakg√∂n√ºll√ºl√ºk ve manevi arayƒ±≈ü bu ya≈üamƒ±n dersi.' },
            19: { label: '19/1', theme: 'G√º√ß & Baƒüƒ±msƒ±zlƒ±k', desc: 'G√ºc√ºn yanlƒ±≈ü kullanƒ±mƒ±. Payla≈üƒ±mcƒ± liderlik ve yardƒ±m istemek bu ya≈üamƒ±n dersi.' }
        };

        function reduceNum(n) {
            if (n===11||n===22||n===33) return n;
            while (n > 9) { n = String(n).split('').reduce(function(a,d){return a+parseInt(d);},0); if(n===11||n===22||n===33)break; }
            return n;
        }
        function calcLP(d) {
            if (!d) return null;
            return reduceNum(d.replace(/\D/g,'').split('').reduce(function(a,x){return a+parseInt(x);},0));
        }
        function getRawLP(d) {
            if (!d) return null;
            return d.replace(/\D/g,'').split('').reduce(function(a,x){return a+parseInt(x);},0);
        }
        // Hesap adƒ±mlarƒ±nƒ± metin olarak √ºret (ChatGPT gibi g√∂ster)
        function buildCalcSteps(birthDate) {
            if (!birthDate) return { digits: '', sum1: 0, sum2: 0, final: 0, steps: '' };
            var digits = birthDate.replace(/\D/g,'').split('').map(Number);
            var sum1 = digits.reduce(function(a,x){return a+x;},0);
            var reduced1 = sum1;
            while (reduced1 > 9 && reduced1 !== 11 && reduced1 !== 22 && reduced1 !== 33) {
                reduced1 = String(reduced1).split('').reduce(function(a,d){return a+parseInt(d);},0);
            }
            var digitStr = birthDate.replace(/-/g,'').split('').join('+');
            var steps = digitStr + ' = ' + sum1;
            if (sum1 !== reduced1) {
                var mid = String(sum1).split('').join('+');
                steps += ' ‚Üí ' + mid + ' = ' + reduced1;
            }
            return { digitStr: digitStr, sum1: sum1, final: reduced1, steps: steps };
        }
        function detectKarmicDebt(birthDate, name) {
            var debts = [];
            // Doƒüum tarihinden ham sayƒ±lar
            var rawLP = getRawLP(birthDate);
            KARMIC_DEBTS.forEach(function(k) { if (rawLP === k) debts.push(k); });
            // Doƒüum tarihinin par√ßalarƒ± (g√ºn, ay karmik olabilir)
            if (birthDate) {
                var parts = birthDate.split('-');
                var day = parseInt(parts[2]);
                var month = parseInt(parts[1]);
                [day, month].forEach(function(v) { if (KARMIC_DEBTS.includes(v) && !debts.includes(v)) debts.push(v); });
            }
            return debts;
        }

        // ‚îÄ‚îÄ‚îÄ Kullanƒ±cƒ± verisi ‚Äî birden fazla kaynaktan √ßek ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.addEventListener('load', async function() {
            if (window.auth && window.auth.whenReady) { await window.auth.whenReady(); }
            var params = new URLSearchParams(window.location.search);
            var kisiName = params.get('kisi');

            if (kisiName) {
                // Ba≈ükasƒ±nƒ±n profili ‚Äî √ßoklu kaynak
                var karmicName = kisiName, karmicBD = '';

                // Kaynak 1: numerael_kisi_temp
                try {
                    var tempKisi2 = JSON.parse(localStorage.getItem('numerael_kisi_temp') || 'null');
                    if (tempKisi2 && tempKisi2.isTemp && tempKisi2.birthDate) {
                        karmicName = tempKisi2.name || tempKisi2.fullName || kisiName;
                        karmicBD = tempKisi2.birthDate;
                    }
                } catch(e) {}

                // Kaynak 2: Supabase discovery_profiles
                if (!karmicBD && window.supabaseClient) {
                    try {
                        var dpRes2 = await window.supabaseClient.from('discovery_profiles')
                            .select('full_name, birth_date')
                            .ilike('full_name', '%' + kisiName + '%')
                            .limit(1).maybeSingle();
                        if (dpRes2.data && dpRes2.data.birth_date) {
                            karmicName = dpRes2.data.full_name || kisiName;
                            karmicBD = dpRes2.data.birth_date;
                        }
                    } catch(e) {}
                }

                // Kaynak 3: Supabase profiles
                if (!karmicBD && window.supabaseClient) {
                    try {
                        var profRes2 = await window.supabaseClient.from('profiles')
                            .select('full_name, birth_date')
                            .ilike('full_name', '%' + kisiName + '%')
                            .limit(1).maybeSingle();
                        if (profRes2.data && profRes2.data.birth_date) {
                            karmicName = profRes2.data.full_name || kisiName;
                            karmicBD = profRes2.data.birth_date;
                        }
                    } catch(e) {}
                }

                // Kaynak 4: localStorage connections
                if (!karmicBD && window.profile) {
                    try {
                        var conn2 = await window.profile.getConnectionDetail(kisiName);
                        if (conn2 && conn2.birthDate) {
                            karmicName = conn2.fullName || kisiName;
                            karmicBD = conn2.birthDate;
                        }
                    } catch(e) {}
                }

                if (karmicBD) initKarmic({ name: karmicName, birthDate: karmicBD });
                return;
            }

            // Ana kullanƒ±cƒ± ‚Äî 3 kaynaktan dene
            var name = '', birthDate = '';

            // 1. numerael_user_data
            try {
                var ud = JSON.parse(localStorage.getItem('numerael_user_data') || 'null');
                if (ud) { name = ud.name || ''; birthDate = ud.birthDate || ''; }
            } catch(e) {}

            // 2. Supabase profiles tablosu (birthDate hala yoksa)
            if (name && !birthDate && window.supabaseClient) {
                try {
                    var sess = await window.supabaseClient.auth.getUser();
                    if (sess && sess.data && sess.data.user) {
                        var { data: prof } = await window.supabaseClient
                            .from('profiles')
                            .select('birth_date, full_name')
                            .eq('id', sess.data.user.id)
                            .single();
                        if (prof) {
                            // Supabase'de alan adƒ± birth_date (snake_case)
                            birthDate = prof.birth_date || prof.birthDate || prof.dob || '';
                            if (!name) name = prof.full_name || prof.name || '';
                            console.log('[Karmic] Supabase prof:', prof, '‚Üí birthDate:', birthDate);
                            // numerael_user_data'yƒ± g√ºncelle ‚Äî bir daha sormasƒ±n
                            if (birthDate) {
                                try {
                                    var existing = JSON.parse(localStorage.getItem('numerael_user_data') || '{}');
                                    existing.birthDate = birthDate;
                                    if (!existing.name) existing.name = name;
                                    localStorage.setItem('numerael_user_data', JSON.stringify(existing));
                                } catch(e2) {}
                            }
                        }
                    }
                } catch(e) {}
            }

            // 3. numerael_connections'dan kendi kaydƒ±nƒ± bul (saveConnection'da da kaydediliyor)
            if (name && !birthDate) {
                try {
                    var allKeys = Object.keys(localStorage).filter(function(k){ return k.startsWith('numerael_connections_'); });
                    allKeys.forEach(function(k) {
                        var conns = JSON.parse(localStorage.getItem(k) || '[]');
                        conns.forEach(function(c) {
                            if (!birthDate && c.fullName && c.fullName.toLowerCase() === name.toLowerCase() && c.birthDate) {
                                birthDate = c.birthDate;
                            }
                        });
                    });
                } catch(e) {}
            }

            if (name) initKarmic({ name: name, birthDate: birthDate });
        });

        function initKarmic(data) {
            var name = (data && data.name) ? data.name : '';
            var birthDate = (data && data.birthDate) ? data.birthDate : '';
            console.log('[Karmic] initKarmic called:', { name: name, birthDate: birthDate });
            if (!name) return;
            
            // birthDate yoksa kartƒ± tƒ±klanabilir bƒ±rak ama uyarƒ± g√∂ster
            if (!birthDate) {
                var numEl2 = document.getElementById('karmic-number');
                var badgeEl2 = document.getElementById('karmic-badge');
                if (numEl2) { numEl2.textContent = '?'; numEl2.style.fontSize = '22px'; }
                if (badgeEl2) { badgeEl2.textContent = 'TARƒ∞H GEREKLƒ∞'; }
                var btn2 = document.getElementById('karmic-bond-btn');
                var content2 = document.getElementById('karmic-content');
                var icon2 = document.getElementById('karmic-expand-icon');
                var aiText2 = document.getElementById('karmic-ai-text');
                if (btn2) btn2.addEventListener('click', function() {
                    var isOpen = content2.style.display !== 'none';
                    content2.style.display = isOpen ? 'none' : 'block';
                    icon2.textContent = isOpen ? 'expand_more' : 'expand_less';
                    if (!isOpen) aiText2.innerHTML = '<p style="color:#ef4444;font-size:13px;padding:8px 0;">‚ö† Doƒüum tarihi bulunamadƒ±. L√ºtfen <a href="data-ready_birth_form.html" style="color:#f2cc0d;text-decoration:underline;">profil formunu</a> doldurun.</p>';
                });
                return;
            }
            var lp = calcLP(birthDate);
            var rawLP = getRawLP(birthDate);
            var calcSteps = buildCalcSteps(birthDate);
            var debts = detectKarmicDebt(birthDate, name);
            var primaryDebt = debts.length > 0 ? debts[0] : null;
            // G√ºn ve ay numaralarƒ±
            var birthParts = (birthDate||'').split('-');
            var birthDay = parseInt(birthParts[2]||0);
            var birthMonth = parseInt(birthParts[1]||0);
            var birthYear = parseInt(birthParts[0]||0);
            // Karmik tespit sebebi
            var debtSource = [];
            if (KARMIC_DEBTS.includes(birthDay)) debtSource.push('g√ºn sayƒ±sƒ± ' + birthDay);
            if (KARMIC_DEBTS.includes(birthMonth)) debtSource.push('ay sayƒ±sƒ± ' + birthMonth);
            if (KARMIC_DEBTS.includes(rawLP)) debtSource.push('doƒüum tarihi toplamƒ± ' + rawLP);

            // Kart √ºzerinde ba≈ülangƒ±√ßta yƒ±ldƒ±z g√∂ster, AI analiz edince detay √ßƒ±kar
            var numEl = document.getElementById('karmic-number');
            var badgeEl = document.getElementById('karmic-badge');
            if (numEl) { numEl.textContent = '‚ú¶'; numEl.style.fontSize = '22px'; }
            if (badgeEl) badgeEl.textContent = 'ANALƒ∞Z ET';

            // Cache key
            var cacheKey = 'numerael_karmic_v12__' + name.toLowerCase().replace(/\s+/g,'_') + '__' + (birthDate||'').replace(/-/g,'') + '__' + (primaryDebt||0);

            // Accordion tƒ±klama
            var btn = document.getElementById('karmic-bond-btn');
            var content = document.getElementById('karmic-content');
            var icon = document.getElementById('karmic-expand-icon');
            var aiText = document.getElementById('karmic-ai-text');
            var masterWrap = document.getElementById('karmic-master-btn-wrap');
            var loaded = false;

            if (btn) {
                btn.addEventListener('click', function() {
                    var isOpen = content.style.display !== 'none';
                    content.style.display = isOpen ? 'none' : 'block';
                    icon.textContent = isOpen ? 'expand_more' : 'expand_less';

                    if (!loaded && !isOpen) {
                        loaded = true;
                        // Cache kontrol
                        var cached = null;
                        try { cached = localStorage.getItem(cacheKey); } catch(e) {}
                        if (cached) {
                            renderKarmicText(aiText, cached);
                            masterWrap.style.display = 'block';
                            return;
                        }
                        // Loading
                        aiText.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:12px 0;color:rgba(255,100,100,0.6);"><span class=\"material-symbols-outlined\" style=\"animation:spin 1s linear infinite;font-size:18px;\">cycle</span><span style=\"font-size:13px;\">Karmik bor√ß hesaplanƒ±yor...</span></div>';
                        // AI √ßaƒürƒ±sƒ± ‚Äî API key /api/openai proxy'si tarafƒ±ndan server-side ekleniyor
                        // Sadece doƒüum tarihini ver ‚Äî ChatGPT'nin kendisi hesaplar ve analiz eder
                        if (!birthDate) {
                            aiText.innerHTML = '<p style="color:#ef4444;font-size:13px;padding:8px 0;">‚ö† Doƒüum tarihi bulunamadƒ±. L√ºtfen profil formunu doldurun.</p>';
                            loaded = false;
                            return;
                        }
                        var birthDisplay = birthDate.split('-').reverse().join('/'); // YYYY-MM-DD ‚Üí DD/MM/YYYY
                        var prompt = birthDisplay + ' i√ßin en baskƒ±n ve yorucu karma';
                        // Timeout ile fetch
                        var controller = new AbortController();
                        var timeoutId = setTimeout(function() {
                            controller.abort();
                            aiText.innerHTML = '<p style="color:#ef4444;font-size:13px;padding:8px 0;">‚ö† Baƒülantƒ± zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.</p>';
                            loaded = false; // tekrar denenebilsin
                        }, 30000);

                        fetch((window.__NUMERAEL_API_BASE||'') + '/api/openai', {
                            method: 'POST',
                            signal: controller.signal,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'gpt-4o-mini',
                                messages: [
                                    { role: 'system', content: 'Sen Pisagor numerolojisi karmik bor√ß uzmanƒ±sƒ±n. T√ºrk√ße yaz, net ve pratik ol. Karmik bor√ß sayƒ±larƒ± SADECE 13,14,16,19. G√ºn sayƒ±sƒ±nƒ± ASLA indirgeme.\n\nZORUNLU FORMAT ‚Äî her yanƒ±tta a≈üaƒüƒ±daki 5 ba≈ülƒ±ƒüƒ± **kalƒ±n** i≈üaretiyle (**) ve tam bu sƒ±rayla kullan. Ba≈ülƒ±klarƒ± DEƒûƒ∞≈ûTƒ∞RME, aynen yaz:\n\n**Karmik Bor√ß Tespiti**\n[Tespit edilen bor√ß sayƒ±sƒ± ve 1-2 c√ºmle a√ßƒ±klama]\n\n**Neden Bu Karma?**\n[Numerolojik sebep ‚Äî neden bu sayƒ±, neyin i≈üareti]\n\n**Pratik Etkileri**\n* [en az 4, en fazla 6 madde]\n\n**Bu Karmanƒ±n Dersi**\n* [en az 3, en fazla 4 madde]\n\n**Net Ger√ßek**\n[Tek c√ºmle, sert ve ger√ßek√ßi]\n\nBa≈ülƒ±klar HER KULLANICI ƒ∞√áƒ∞N AYNI olmalƒ±. Sadece i√ßerikler ki≈üiye g√∂re deƒüi≈ümeli.' },
                                    { role: 'user', content: '19/10/1997 i√ßin en baskƒ±n ve yorucu karma' },
                                    { role: 'assistant', content: '**Karmik Bor√ß Tespiti**\n19/1 karmik borcu tespit edildi. Doƒüum tarihindeki 19 sayƒ±sƒ±, g√º√ß ve otoritenin yanlƒ±≈ü kullanƒ±mƒ±na i≈üaret eden klasik bir karmik bor√ß sayƒ±sƒ±dƒ±r.\n\n**Neden Bu Karma?**\nNumerolojide 19; g√º√ß√ºn, otoritenin ve bireyselliƒüin yanlƒ±≈ü kullanƒ±mƒ±yla ili≈ükilendirilen karmik bor√ß sayƒ±sƒ±dƒ±r. Ge√ßmi≈ü ya≈üamda bencil liderlik ve ba≈ükalarƒ±nƒ± yok sayma kalƒ±plarƒ± bu borca yol a√ßmƒ±≈ütƒ±r.\n\n**Pratik Etkileri**\n* Yalnƒ±z ilerlemek zorunda kalma\n* Ego-tevazu √ßatƒ±≈ümasƒ±\n* Otoriteyle s√ºrt√º≈üme\n* Erken sorumluluk y√ºklenme\n* Ba≈üarƒ± gecikmesi\n\n**Bu Karmanƒ±n Dersi**\n* G√ºc√º ba≈ükalarƒ±yla payla≈üarak kullanmak\n* Yardƒ±m istemeyi zayƒ±flƒ±k g√∂rmemek\n* Liderliƒüi √∂rnek olarak g√∂stermek\n\n**Net Ger√ßek**\nBu karma ≈üanssƒ±zlƒ±k deƒüil; yanlƒ±≈ü g√º√ß kullanƒ±mƒ±nƒ± d√ºzeltmeye zorlayan bir mekanizma.' },
                                    { role: 'user', content: prompt }
                                ],
                                temperature: 0.75,
                                max_tokens: 400
                            })
                        }).then(function(r) {
                            clearTimeout(timeoutId);
                            return r.json();
                        }).then(function(d) {
                            if (d.error) {
                                aiText.innerHTML = '<p style="color:#ef4444;font-size:13px;padding:8px 0;">‚ö† API hatasƒ±: ' + (d.error.message || 'Bilinmeyen hata') + '</p>';
                                loaded = false;
                                return;
                            }
                            var text = d.choices && d.choices[0] ? d.choices[0].message.content.trim() : null;
                            if (text) {
                                aiText.style.animation = 'karmic-fade 0.5s ease';
                                renderKarmicText(aiText, text);
                                try { localStorage.setItem(cacheKey, text); } catch(e) {}
                                masterWrap.style.display = 'block';
                            } else {
                                aiText.innerHTML = '<p style="color:#ef4444;font-size:13px;padding:8px 0;">‚ö† Yanƒ±t alƒ±namadƒ±. Tekrar deneyin.</p>';
                                loaded = false;
                            }
                        }).catch(function(err) {
                            clearTimeout(timeoutId);
                            if (err.name === 'AbortError') return; // timeout zaten halletti
                            aiText.innerHTML = '<p style="color:#ef4444;font-size:13px;padding:8px 0;">‚ö† Baƒülantƒ± hatasƒ±: ' + (err.message||'ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.') + '</p>';
                            loaded = false; // tekrar denenebilsin
                        });
                    }
                });
            }

            // Ustaya sor butonu
            var masterBtn = document.getElementById('btn-goto-master');
            if (masterBtn) {
                masterBtn.addEventListener('click', function() {
                    openMasterModal(name, birthDate, lp, primaryDebt);
                });
            }
        }

        function renderKarmicText(el, text) {
            // Markdown-lite: **bold**, - veya * maddeler, \n\n paragraf
            var html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#f2cc0d;">$1</strong>')
                .split('\n\n')
                .map(function(block) {
                    block = block.trim();
                    if (!block) return '';
                    // Satƒ±rlarƒ± i≈üle
                    var lines = block.split('\n');
                    var hasBullets = lines.some(function(l){ var t = l.trim(); return t.startsWith('-') || t.startsWith('*'); });
                    if (hasBullets) {
                        var items = lines.map(function(l) {
                            l = l.trim();
                            if (l.startsWith('-') || l.startsWith('*')) {
                                return '<li style="margin-bottom:6px;list-style:none;padding-left:16px;position:relative;">' +
                                    '<span style="position:absolute;left:0;color:#c0392b;">‚ú¶</span>' +
                                    l.slice(1).trim() + '</li>';
                            }
                            return '<p style="margin-bottom:8px;font-weight:700;">' + l + '</p>';
                        }).join('');
                        return '<ul style="margin:0 0 14px;padding:0;">' + items + '</ul>';
                    }
                    // Normal paragraf veya ba≈ülƒ±k
                    var firstLine = lines[0];
                    var isTitle = !firstLine.endsWith('.') && firstLine.length < 60 && lines.length === 1;
                    if (isTitle) {
                        return '<p style="margin-bottom:8px;font-weight:800;color:' + _tc('rgba(255,255,255,0.95)','#0f172a') + ';font-size:13px;letter-spacing:0.03em;">' + block + '</p>';
                    }
                    return '<p style="margin-bottom:12px;color:' + _tc('rgba(186,181,156,0.9)','#475569') + ';">' + block.replace(/\n/g,'<br>') + '</p>';
                }).join('');
            el.innerHTML = html || '<p style="color:' + _tc('rgba(186,181,156,0.6)','#94a3b8') + ';">Analiz hazƒ±rlanamadƒ±.</p>';
        }

        // ‚îÄ‚îÄ‚îÄ NUMEROLOJƒ∞ USTASI CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var chatHistory = [];
        var chatContext = {};

        window.openMasterModal = function(name, birthDate, lp, primaryDebt) {
            var DEBT_THEMES = {13:'Tembellik ve Disiplin',14:'√ñzg√ºrl√ºƒü√ºn K√∂t√ºye Kullanƒ±mƒ±',16:'Ego ve Kibir',19:'G√º√ß ve Baƒüƒ±msƒ±zlƒ±k'};
            chatContext = { name: name, birthDate: birthDate, lp: lp, primaryDebt: primaryDebt, debtTheme: primaryDebt ? (DEBT_THEMES[primaryDebt]||'') : '' };
            chatHistory = [];
            var modal = document.getElementById('master-modal');
            modal.style.display = 'flex';
            // Bottom nav'ƒ± gizle ‚Äî chat input'u kapatmasƒ±n
            var nav = document.getElementById('numerael-bottom-nav');
            if (nav) nav.style.display = 'none';
            var msgEl = document.getElementById('master-messages');
            msgEl.innerHTML = '';

            // A√ßƒ±lƒ±≈ü mesajƒ±
            var KARMIC_INFO_local = {
                13: '13/4', 14: '14/5', 16: '16/7', 19: '19/1'
            };
            var karmicLabel = primaryDebt ? (KARMIC_INFO_local[primaryDebt] || primaryDebt) : 'yok';
            var DEBT_THEMES_LOCAL2 = {13:'Tembellik & Disiplin',14:'√ñzg√ºrl√ºƒü√ºn K√∂t√ºye Kullanƒ±mƒ±',16:'Ego & Kibir',19:'G√º√ß & Baƒüƒ±msƒ±zlƒ±k'};
            var openingMsg = (primaryDebt
                ? karmicLabel + ' karmik borcunuz tespit edildi. Hangi ba≈ülƒ±ktan a√ßayƒ±m?\n\n‚Ä¢ para/i≈ü\n‚Ä¢ ili≈üki\n‚Ä¢ saƒülƒ±k\n\nYa da mevcut durumunuzu yazƒ±n (sekt√∂r, i≈ü modeli, ili≈üki sorunu) ‚Äî o alana √∂zel analiz yaparƒ±m.'
                : 'Doƒüum tarihinizde klasik karmik bor√ß sayƒ±sƒ± tespit edilmedi. Ya≈üam Yolu ' + lp + ' derslerinizi konu≈üabiliriz. Ne sormak istersiniz?');

            addMessage('assistant', openingMsg);
            chatHistory.push({ role: 'system', content: `Sen Pisagor numerolojisi karmik bor√ß uzmanƒ±sƒ±n. T√ºrk√ße yaz, net ve pratik ol.

Analiz ettiƒüin ki≈üi:
- ƒ∞sim: ${name}
- Doƒüum: ${birthDate}
- Ya≈üam Yolu: ${lp}
- Karmik bor√ß: ${primaryDebt ? karmicLabel : 'yok'}

KURALLAR:
- Mistik dil yok, astroloji yok, motivasyonel laf yok.
- Kullanƒ±cƒ± "para/i≈ü", "ili≈üki", "saƒülƒ±k" veya meslek/sekt√∂r yazarsa o ba≈ülƒ±k altƒ±nda analiz yap.
- Kullanƒ±cƒ± sekt√∂r belirtirse (otomasyon, yazƒ±lƒ±m, gƒ±da vs.) o sekt√∂re √∂zel karmik etkiyi a√ßƒ±kla.
- Her yanƒ±tƒ±n sonunda ba≈üka bir ba≈ülƒ±k √∂ner.

PARA/ƒ∞≈û BA≈ûLIƒûI ƒ∞STENƒ∞RSE bu formatta yaz:
[TARƒ∞H] ‚Äì Para & ƒ∞≈ü karmasƒ± ([BOR√á]) net analizi

Temel problem
* [madde]
* [madde]

ƒ∞≈ü hayatƒ±nda tipik d√∂ng√º
[numaralƒ± liste]

Para kaybƒ±na a√ßƒ±k alanlar
* [madde]

Para kazanmanƒ±n doƒüru yolu
* [madde]

Uygun i≈ü modelleri
* [madde]

Zamanlama ger√ßeƒüi
* [madde]

Altƒ±n kural
[tek c√ºmle]

ƒ∞Lƒ∞≈ûKƒ∞ BA≈ûLIƒûI ƒ∞STENƒ∞RSE benzer yapƒ±da ili≈üki odaklƒ± analiz yap.
SAƒûLIK BA≈ûLIƒûI ƒ∞STENƒ∞RSE saƒülƒ±k ve psikoloji odaklƒ± analiz yap.` });
            chatHistory.push({ role: 'assistant', content: openingMsg });

            document.getElementById('master-input').focus();
        };

        window.closeMasterModal = function() {
            document.getElementById('master-modal').style.display = 'none';
            // Bottom nav'ƒ± geri getir
            var nav = document.getElementById('numerael-bottom-nav');
            if (nav) nav.style.display = 'flex';
        };

        function addMessage(role, text) {
            var msgEl = document.getElementById('master-messages');
            var isUser = role === 'user';
            var div = document.createElement('div');
            div.style.cssText = 'display:flex;' + (isUser ? 'justify-content:flex-end;' : 'justify-content:flex-start;');
            var bubble = document.createElement('div');
            bubble.style.cssText = 'max-width:80%;padding:12px 16px;border-radius:' + (isUser ? '16px 16px 4px 16px' : '16px 16px 16px 4px') + ';font-size:14px;line-height:1.65;' +
                (isUser ? 'background:linear-gradient(135deg,#7f1313,#c0392b);color:white;' : 'background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.88);border:1px solid rgba(255,255,255,0.1);');
            bubble.textContent = text;
            div.appendChild(bubble);
            msgEl.appendChild(div);
            msgEl.scrollTop = msgEl.scrollHeight;
        }

        function addLoadingBubble() {
            var msgEl = document.getElementById('master-messages');
            var div = document.createElement('div');
            div.id = 'master-loading';
            div.style.cssText = 'display:flex;justify-content:flex-start;';
            div.innerHTML = '<div style="padding:12px 16px;border-radius:16px 16px 16px 4px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.4);font-size:13px;">‚ú¶ d√º≈ü√ºn√ºyor...</div>';
            msgEl.appendChild(div);
            msgEl.scrollTop = msgEl.scrollHeight;
        }

        async function sendMasterMessage() {
            var input = document.getElementById('master-input');
            var text = (input.value || '').trim();
            if (!text) return;
            input.value = '';
            addMessage('user', text);
            chatHistory.push({ role: 'user', content: text });
            addLoadingBubble();

            // API key /api/openai proxy'si tarafƒ±ndan server-side ekleniyor
            // Few-shot: ChatGPT'nin para/i≈ü cevabƒ±nƒ± √∂rnek olarak ekle
            var messagesWithExamples = chatHistory.slice(); // kopyala
            // Sadece para/i≈ü sorusu i√ßin √∂rnek enjekte et
            var lastUserMsg = (messagesWithExamples[messagesWithExamples.length-1]||{}).content||'';
            if (lastUserMsg.match(/para|i≈ü|kariyer|meslek|sekt√∂r|√ßalƒ±≈ü|kazan√ß|gelir|i≈üim|≈üirket/i)) {
                var exampleIdx = messagesWithExamples.findIndex(function(m){ return m.role==='system'; });
                if (exampleIdx !== -1) {
                    messagesWithExamples.splice(exampleIdx+1, 0,
                        { role: 'user', content: '19/10/1997 para/i≈ü' },
                        { role: 'assistant', content: '19/10/1997 Para ve Is karmasi (19/1):\n* Para kolay gelmez.\n* Ortakliklar yorar.\n* Emek-kazanc dengesi gec kurulur.\n\nDogru yol:\n* Tek lider modeli\n* Somut cikti ureten isler\n* Proje bazli calisma\n\nAltin kural: Parayi sisteme bagla.' }
                    );
                }
            }

            try {
                var r = await fetch((window.__NUMERAEL_API_BASE||'') + '/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'gpt-4o-mini', messages: messagesWithExamples, temperature: 0.75, max_tokens: 600 })
                });
                var d = await r.json();
                var reply = d.choices && d.choices[0] ? d.choices[0].message.content.trim() : 'Yanƒ±t alƒ±namadƒ±.';
                document.getElementById('master-loading').remove();
                addMessage('assistant', reply);
                chatHistory.push({ role: 'assistant', content: reply });
            } catch(e) {
                document.getElementById('master-loading').remove();
                addMessage('assistant', 'Baƒülantƒ± hatasƒ±.');
            }
        }

        // Send butonu ve Enter tu≈üu
        document.addEventListener('DOMContentLoaded', function() {
            var sendBtn = document.getElementById('master-send');
            var input = document.getElementById('master-input');
            if (sendBtn) sendBtn.addEventListener('click', sendMasterMessage);
            if (input) input.addEventListener('keydown', function(e) { if (e.key === 'Enter') sendMasterMessage(); });
        });

    })();
    </script>
    <!-- accordion-ai.js kaldƒ±rƒ±ldƒ± ‚Äî numerology-engine.js tarafƒ±ndan y√∂netiliyor -->

    <!-- Context-Aware Insight Integration -->
    <script>
    (function() {
        if (!window.NumerologyContext) return;

        window.addEventListener('load', async function() {
            // Kullanƒ±cƒ± verisini topla
            var params = new URLSearchParams(window.location.search);
            var kisiName = params.get('kisi');
            var data = null;

            if (kisiName) {
                // Ba≈ükasƒ±nƒ±n profili ‚Äî √ßoklu kaynak
                // Kaynak 1: numerael_kisi_temp
                try {
                    var tempCtx = JSON.parse(localStorage.getItem('numerael_kisi_temp') || 'null');
                    if (tempCtx && tempCtx.isTemp && tempCtx.birthDate) {
                        data = { name: tempCtx.name || tempCtx.fullName || kisiName, birthDate: tempCtx.birthDate };
                    }
                } catch(e) {}

                // Kaynak 2: Supabase discovery_profiles
                if (!data && window.supabaseClient) {
                    try {
                        var dpCtx = await window.supabaseClient.from('discovery_profiles')
                            .select('full_name, birth_date')
                            .ilike('full_name', '%' + kisiName + '%')
                            .limit(1).maybeSingle();
                        if (dpCtx.data && dpCtx.data.birth_date) {
                            data = { name: dpCtx.data.full_name || kisiName, birthDate: dpCtx.data.birth_date };
                        }
                    } catch(e) {}
                }

                // Kaynak 3: Supabase profiles
                if (!data && window.supabaseClient) {
                    try {
                        var profCtx = await window.supabaseClient.from('profiles')
                            .select('full_name, birth_date')
                            .ilike('full_name', '%' + kisiName + '%')
                            .limit(1).maybeSingle();
                        if (profCtx.data && profCtx.data.birth_date) {
                            data = { name: profCtx.data.full_name || kisiName, birthDate: profCtx.data.birth_date };
                        }
                    } catch(e) {}
                }

                // Kaynak 4: localStorage connections
                if (!data && window.profile) {
                    try {
                        var connCtx = await window.profile.getConnectionDetail(kisiName);
                        if (connCtx && connCtx.birthDate) {
                            data = { name: connCtx.fullName || kisiName, birthDate: connCtx.birthDate };
                        }
                    } catch(e) {}
                }
            }
            if (!data) {
                try { data = JSON.parse(localStorage.getItem('numerael_user_data')); } catch(e) {}
            }
            if (!data || !data.name || !data.birthDate) return;

            var name = data.name.trim();
            var birthDate = data.birthDate;

            // Mevcut hesaplamalarƒ± kullan (DEƒûƒ∞≈ûTƒ∞RME)
            var lp = NumerologyEngine.calcLifePath(birthDate);
            var expr = NumerologyEngine.calcNameNumber(name, 'pythagorean');
            var soul = NumerologyEngine.calcSoulUrge(name, 'pythagorean');
            var pers = NumerologyEngine.calcPersonality(name, 'pythagorean');

            // Karmik bor√ß algƒ±la
            var KARMIC_DEBTS_CTX = [13,14,16,19];
            var rawLP = birthDate.replace(/\D/g,'').split('').reduce(function(a,x){return a+parseInt(x);},0);
            var karmicDebt = null;
            KARMIC_DEBTS_CTX.forEach(function(k) { if (rawLP === k) karmicDebt = k; });
            if (!karmicDebt && birthDate) {
                var bp = birthDate.split('-');
                var bDay = parseInt(bp[2]||0);
                var bMonth = parseInt(bp[1]||0);
                if (KARMIC_DEBTS_CTX.includes(bDay)) karmicDebt = bDay;
                else if (KARMIC_DEBTS_CTX.includes(bMonth)) karmicDebt = bMonth;
            }

            // Context Build (Step 1)
            var weightedCtx = NumerologyContext.buildContext({
                life_path: lp,
                personality_number: pers,
                expression_number: expr,
                soul_urge: soul,
                karmic_debt: karmicDebt,
                birthDate: birthDate
            });

            // Section'ƒ± g√∂ster
            var section = document.getElementById('context-insight-section');
            if (!section) return;
            section.style.display = 'block';

            // Period tags
            if (weightedCtx.period) {
                var tagsEl = document.getElementById('ctx-period-tags');
                if (tagsEl) {
                    tagsEl.style.display = 'flex';
                    var tags = [
                        { label: 'Ki≈üisel Yƒ±l', val: weightedCtx.period.personal_year, color: '#f2cc0d' },
                        { label: 'Ki≈üisel Ay', val: weightedCtx.period.personal_month, color: '#a78bfa' },
                        { label: 'Ki≈üisel G√ºn', val: weightedCtx.period.personal_day, color: '#60a5fa' }
                    ];
                    tagsEl.innerHTML = tags.map(function(t) {
                        return '<div style="display:flex;align-items:center;gap:4px;background:' + _tc('rgba(255,255,255,0.04)','rgba(0,0,0,0.04)') + ';border:1px solid ' + t.color + '30;border-radius:8px;padding:4px 10px;">' +
                            '<span style="color:' + t.color + ';font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;">' + t.label + '</span>' +
                            '<span style="color:' + _tc('white','#0f172a') + ';font-size:14px;font-weight:800;">' + t.val + '</span></div>';
                    }).join('');
                }
            }

            // Intensity bar
            var intBar = document.getElementById('ctx-intensity-bar');
            if (intBar) {
                intBar.style.display = 'block';
                var pct = Math.round((weightedCtx.intensity / 2.5) * 100);
                document.getElementById('ctx-intensity-val').textContent = weightedCtx.intensity + ' / 2.5';
                document.getElementById('ctx-intensity-fill').style.width = pct + '%';
            }

            // Mod√ºler yorumlarƒ± √ßek (Step 2 & 3)
            try {
                var result = await NumerologyContext.analyzeWithCache({
                    life_path: lp,
                    personality_number: pers,
                    expression_number: expr,
                    soul_urge: soul,
                    karmic_debt: karmicDebt,
                    birthDate: birthDate
                }, name);

                var modulesEl = document.getElementById('ctx-modules');
                if (!modulesEl) return;

                var modules = [];
                if (result.interpretation.core_personality) {
                    modules.push({ icon: 'person', title: 'Temel Ki≈üilik', text: result.interpretation.core_personality, color: '#f2cc0d' });
                }
                if (result.interpretation.current_period) {
                    modules.push({ icon: 'calendar_today', title: 'G√ºncel D√∂nem', text: result.interpretation.current_period, color: '#a78bfa' });
                }
                if (result.interpretation.karmic_layer) {
                    modules.push({ icon: 'cycle', title: 'Karmik Baskƒ±', text: result.interpretation.karmic_layer, color: '#ef4444' });
                }
                if (result.interpretation.guidance) {
                    modules.push({ icon: 'lightbulb', title: 'Bilin√ßli Kullanƒ±m', text: result.interpretation.guidance, color: '#22c55e' });
                }

                if (modules.length === 0) {
                    modulesEl.innerHTML = '<p style="color:' + _tc('rgba(255,255,255,0.3)','#94a3b8') + ';font-size:13px;text-align:center;padding:16px;">Analiz hazƒ±rlanamadƒ±.</p>';
                    return;
                }

                modulesEl.innerHTML = modules.map(function(m, idx) {
                    return '<div style="border-left:3px solid ' + m.color + ';padding:12px 16px;background:' + _tc('rgba(255,255,255,0.02)','rgba(0,0,0,0.02)') + ';border-radius:0 8px 8px 0;animation:acc-in 0.4s ease ' + (idx * 0.15) + 's both;">' +
                        '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">' +
                            '<span class="material-symbols-outlined" style="font-size:16px;color:' + m.color + ';">' + m.icon + '</span>' +
                            '<span style="color:' + m.color + ';font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;">' + m.title + '</span>' +
                        '</div>' +
                        '<p style="color:' + _tc('rgba(255,255,255,0.75)','#334155') + ';font-size:13px;line-height:1.7;">' + m.text + '</p>' +
                    '</div>';
                }).join('');

            } catch(e) {
                console.error('[ContextInsight] Error:', e);
                var modulesEl2 = document.getElementById('ctx-modules');
                if (modulesEl2) modulesEl2.innerHTML = '<p style="color:' + _tc('rgba(255,255,255,0.3)','#94a3b8') + ';font-size:13px;text-align:center;padding:16px;">Baƒülamsal analiz y√ºklenemedi.</p>';
            }
        });
    })();
    </script>

<script src="js/notification-engine.js"></script>
<script src="js/bottom-nav.js"></script>
</body>

</html>