<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport" />
    <title>Manifest Portal</title>
    <script src="js/api-base.js"></script>
    <script src="js/tailwind.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/play-billing.js"></script>
    <script src="js/premium.js"></script>
    <script src="js/gamification-engine.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/manifest-engine.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: #04040a;
            color: #fff;
            min-height: 100dvh;
            padding-bottom: 140px;
            position: relative;
        }
        /* ── Nebula Background (Horsehead-style) ──── */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background:
                /* Stars */
                radial-gradient(1px 1px at 12% 15%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 28% 8%, rgba(180,200,255,0.7), transparent),
                radial-gradient(1.5px 1.5px at 65% 12%, rgba(100,150,255,0.9), transparent),
                radial-gradient(1px 1px at 82% 22%, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 8% 42%, rgba(120,160,255,1), transparent),
                radial-gradient(1px 1px at 45% 35%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 72% 48%, rgba(255,220,200,0.6), transparent),
                radial-gradient(1.5px 1.5px at 92% 55%, rgba(200,200,255,0.7), transparent),
                radial-gradient(1px 1px at 35% 62%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 55% 78%, rgba(180,180,255,0.5), transparent),
                radial-gradient(2px 2px at 18% 85%, rgba(255,200,150,0.6), transparent),
                radial-gradient(1px 1px at 78% 88%, rgba(255,255,255,0.4), transparent),
                /* Red/crimson nebula cloud — main body */
                radial-gradient(ellipse 80% 60% at 60% 40%, rgba(140,20,40,0.35) 0%, transparent 70%),
                radial-gradient(ellipse 50% 40% at 70% 35%, rgba(180,30,50,0.25) 0%, transparent 60%),
                radial-gradient(ellipse 40% 50% at 45% 50%, rgba(120,15,35,0.2) 0%, transparent 55%),
                /* Blue star glow top-left */
                radial-gradient(circle at 15% 18%, rgba(40,80,200,0.35) 0%, transparent 40%),
                radial-gradient(circle at 10% 25%, rgba(30,60,160,0.2) 0%, transparent 35%),
                /* Teal/green wisp */
                radial-gradient(ellipse 30% 25% at 50% 45%, rgba(20,120,100,0.15) 0%, transparent 60%),
                /* Warm edge glow */
                radial-gradient(ellipse 60% 40% at 80% 60%, rgba(100,20,30,0.2) 0%, transparent 50%),
                /* Deep space base */
                radial-gradient(ellipse at 50% 50%, #0a0818 0%, #04040a 100%);
        }
        body > * { position: relative; z-index: 1; }

        /* ── Header title ────────────────────────────── */
        .page-title {
            background: linear-gradient(90deg, #c084fc, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 22px;
            font-weight: 700;
        }

        /* ── Sort Tabs ───────────────────────────────── */
        .sort-tabs {
            display: flex;
            gap: 0;
            background: rgba(255,255,255,0.06);
            border-radius: 9999px;
            padding: 3px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .sort-tab {
            flex: 1;
            padding: 9px 4px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: all 0.25s;
            text-align: center;
        }
        .sort-tab.active {
            background: rgba(124,58,237,0.85);
            color: #fff;
            box-shadow: 0 2px 12px rgba(124,58,237,0.35);
        }
        .sort-tab:not(.active) {
            background: transparent;
            color: rgba(255,255,255,0.3);
        }

        /* ── Category Chips ──────────────────────────── */
        .cat-row { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
        .cat-row::-webkit-scrollbar { display: none; }
        .cat-chip {
            padding: 7px 16px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            background: rgba(255,255,255,0.04);
            color: rgba(255,255,255,0.4);
        }
        .cat-chip.active {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border-color: rgba(255,255,255,0.2);
        }

        /* ── Weekly Champion ─────────────────────────── */
        .weekly-card {
            background: linear-gradient(160deg, rgba(26,16,48,0.85) 0%, rgba(14,8,32,0.9) 60%, rgba(18,8,42,0.85) 100%);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(124,58,237,0.25);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .weekly-card::before {
            content: '';
            position: absolute;
            top: -30%; right: -15%;
            width: 50%; height: 70%;
            background: radial-gradient(circle, rgba(124,58,237,0.12) 0%, transparent 70%);
            pointer-events: none;
        }
        .weekly-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(245,158,11,0.15);
            color: #f59e0b;
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid rgba(245,158,11,0.25);
        }
        .weekly-likes {
            color: rgba(255,255,255,0.3);
            font-size: 11px;
            font-weight: 500;
        }
        .weekly-quote {
            font-size: 20px;
            font-weight: 500;
            line-height: 1.4;
            color: #fff;
            letter-spacing: -0.01em;
        }
        .ritual-btn {
            background: rgba(124,58,237,0.25);
            color: #c084fc;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 7px 16px;
            border-radius: 10px;
            border: 1px solid rgba(124,58,237,0.35);
            cursor: pointer;
            transition: all 0.2s;
        }
        .ritual-btn:active { transform: scale(0.95); }
        .user-pill {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-avatar-sm {
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700;
            flex-shrink: 0;
        }

        /* ── Grid ────────────────────────────────────── */
        .manifest-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* ── Grid Cards ──────────────────────────────── */
        .grid-card {
            border-radius: 18px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 170px;
            cursor: pointer;
            transition: transform 0.15s;
            position: relative;
        }
        .grid-card:active { transform: scale(0.97); }

        /* Category tag */
        .cat-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 6px;
            width: fit-content;
        }
        .cat-tag .dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Warm gradient palettes matching design exactly */
        .grad-love {
            background: linear-gradient(145deg, #c44569 0%, #d4736c 40%, #e8a088 100%);
        }
        .grad-love .cat-tag { background: rgba(255,255,255,0.2); color: #fff; }
        .grad-love .cat-tag .dot { background: #ff6b8a; }

        .grad-money {
            background: linear-gradient(145deg, #2a7d5f 0%, #5a9e5a 35%, #c4b44a 100%);
        }
        .grad-money .cat-tag { background: rgba(255,255,255,0.2); color: #fff; }
        .grad-money .cat-tag .dot { background: #6ee7b7; }

        .grad-health {
            background: linear-gradient(145deg, #c87833 0%, #d4a04a 40%, #e8cc6a 100%);
        }
        .grad-health .cat-tag { background: rgba(255,255,255,0.2); color: #fff; }
        .grad-health .cat-tag .dot { background: #fbbf24; }

        .grad-spiritual {
            background: linear-gradient(145deg, #9a5a7c 0%, #c48a8a 40%, #e0b0a0 100%);
        }
        .grad-spiritual .cat-tag { background: rgba(255,255,255,0.2); color: #fff; }
        .grad-spiritual .cat-tag .dot { background: #c084fc; }

        .grad-career {
            background: linear-gradient(145deg, #8a6e2f 0%, #b89a4a 40%, #d4c06a 100%);
        }
        .grad-career .cat-tag { background: rgba(255,255,255,0.2); color: #fff; }
        .grad-career .cat-tag .dot { background: #fcd34d; }

        .grad-general {
            background: linear-gradient(145deg, #4a5a8a 0%, #6a7aaa 40%, #8a9aba 100%);
        }
        .grad-general .cat-tag { background: rgba(255,255,255,0.2); color: #fff; }
        .grad-general .cat-tag .dot { background: #93c5fd; }

        /* Card text */
        .card-quote {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.45;
            color: rgba(0,0,0,0.85);
            margin-top: 10px;
        }
        .card-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 10px;
        }
        .card-user {
            font-size: 10px;
            font-weight: 500;
            color: rgba(0,0,0,0.45);
        }
        .card-likes {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            font-weight: 600;
            color: rgba(0,0,0,0.4);
        }
        .card-likes .material-symbols-outlined {
            font-size: 13px;
            transition: all 0.2s;
        }
        .card-likes:active .material-symbols-outlined {
            transform: scale(1.3);
        }

        /* ── Real user badge ────────────────────────── */
        .real-user-badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            background: rgba(255,255,255,0.2);
            color: #fff;
            font-size: 8px;
            font-weight: 800;
            letter-spacing: 0.08em;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }
        .grid-card.real-user-card {
            border: 1.5px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 12px rgba(168,85,247,0.15);
        }

        /* ── My Manifests Button ────────────────────── */
        .my-manifests-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 14px;
            border-radius: 9999px;
            background: rgba(124,58,237,0.15);
            border: 1px solid rgba(124,58,237,0.3);
            color: #c084fc;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .my-manifests-btn:active { transform: scale(0.95); }
        .my-manifests-btn .material-symbols-outlined { font-size: 16px; }

        /* ── My Manifests Modal ─────────────────────── */
        .my-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 200;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .my-modal-panel {
            position: absolute;
            inset: 0;
            top: 40px;
            background: linear-gradient(180deg, #0c0a18 0%, #04040a 100%);
            border-radius: 24px 24px 0 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .my-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 20px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
        }
        .my-modal-title {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(90deg, #c084fc, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .my-modal-close {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: rgba(255,255,255,0.4);
        }
        .my-modal-close:active { transform: scale(0.9); }
        .my-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px 100px;
            -webkit-overflow-scrolling: touch;
        }
        .my-manifest-item {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }
        .my-manifest-cat {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(124,58,237,0.15);
            color: #c084fc;
            margin-bottom: 8px;
        }
        .my-manifest-text {
            font-size: 15px;
            font-weight: 500;
            line-height: 1.5;
            color: rgba(255,255,255,0.85);
            margin-bottom: 12px;
        }
        .my-manifest-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .my-manifest-date {
            font-size: 11px;
            color: rgba(255,255,255,0.25);
        }
        .my-manifest-likes {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: rgba(255,255,255,0.35);
        }
        .my-manifest-likes .material-symbols-outlined {
            font-size: 14px;
            color: #c084fc;
        }
        .my-manifest-delete {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px; height: 28px;
            border-radius: 50%;
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.2);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .my-manifest-delete:active { transform: scale(0.85); }
        .my-manifest-delete .material-symbols-outlined {
            font-size: 14px;
            color: rgba(239,68,68,0.6);
        }
        .my-modal-empty {
            text-align: center;
            padding: 60px 20px;
        }
        .my-modal-count {
            font-size: 12px;
            color: rgba(255,255,255,0.3);
            font-weight: 500;
        }

        /* ── FAB ─────────────────────────────────────── */
        .fab-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px; height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 24px rgba(124,58,237,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
            transition: transform 0.15s;
        }
        .fab-btn:active { transform: scale(0.9); }
        .fab-btn .material-symbols-outlined { font-size: 28px; color: #fff; }

        /* ── Animations ──────────────────────────────── */
        @keyframes fadeUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
        .fade-up { animation: fadeUp 0.35s ease forwards; opacity: 0; }
        .fd1 { animation-delay: 0.03s; }
        .fd2 { animation-delay: 0.08s; }
        .fd3 { animation-delay: 0.13s; }
        .fd4 { animation-delay: 0.18s; }
        .fd5 { animation-delay: 0.23s; }
        .fd6 { animation-delay: 0.28s; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="px-5 pt-12 pb-2">
        <div class="flex items-center justify-between mb-5">
            <h1 class="page-title">Manifest Portal</h1>
            <div class="flex items-center gap-2">
                <button class="my-manifests-btn" onclick="openMyManifests()">
                    <span class="material-symbols-outlined" style="font-variation-settings:'FILL' 1;">auto_awesome</span>
                    My Manifests
                </button>
                <button onclick="showInfoModal()" class="w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center">
                    <span class="material-symbols-outlined text-purple-400/60 text-base">info</span>
                </button>
            </div>
        </div>

        <!-- Sort Tabs -->
        <div class="sort-tabs mb-4">
            <button class="sort-tab active" data-sort="newest" onclick="switchSort(this)">Newest</button>
            <button class="sort-tab" data-sort="top_rated" onclick="switchSort(this)">Top Rated</button>
            <button class="sort-tab" data-sort="weekly" onclick="switchSort(this)">Weekly</button>
        </div>

        <!-- Category Chips -->
        <div class="cat-row pb-3">
            <button class="cat-chip active" data-cat="all" onclick="switchCat(this)">All</button>
            <button class="cat-chip" data-cat="love" onclick="switchCat(this)">Aşk</button>
            <button class="cat-chip" data-cat="money" onclick="switchCat(this)">Para</button>
            <button class="cat-chip" data-cat="health" onclick="switchCat(this)">Sağlık</button>
            <button class="cat-chip" data-cat="career" onclick="switchCat(this)">Kariyer</button>
            <button class="cat-chip" data-cat="spiritual" onclick="switchCat(this)">Ruh</button>
        </div>
    </div>

    <!-- Feed -->
    <div id="manifest-feed" class="px-5"></div>

    <!-- Info Modal -->
    <div id="info-modal" style="display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.7); backdrop-filter:blur(6px); align-items:center; justify-content:center;">
        <div style="background:rgba(16,12,30,0.98); border:1px solid rgba(124,58,237,0.3); border-radius:20px; padding:28px; max-width:320px; width:90%; text-align:center;">
            <span class="material-symbols-outlined text-4xl text-purple-400 mb-3" style="font-variation-settings:'FILL' 1;">auto_awesome</span>
            <h3 class="text-lg font-bold mb-2">Manifest Portal</h3>
            <p class="text-white/50 text-sm leading-relaxed mb-5">Topluluk manifestlerini keşfet, ilham al ve kendi niyetlerini evrene gönder. Birlikte manifest oluşturmak enerjinizi katlar!</p>
            <button onclick="closeInfoModal()" class="w-full py-3 rounded-full bg-purple-600 text-white font-semibold text-sm cursor-pointer">Anladım</button>
        </div>
    </div>

    <!-- My Manifests Modal -->
    <div id="my-manifests-modal" class="my-modal-overlay">
        <div class="my-modal-panel">
            <div class="my-modal-header">
                <div>
                    <span class="my-modal-title">My Manifests</span>
                    <span id="my-manifests-count" class="my-modal-count" style="margin-left:8px;"></span>
                </div>
                <button class="my-modal-close" onclick="closeMyManifests()">
                    <span class="material-symbols-outlined" style="font-size:18px;">close</span>
                </button>
            </div>
            <div id="my-manifests-body" class="my-modal-body"></div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab-btn" onclick="window.location.href='cosmic_manifest_portal.html'">
        <span class="material-symbols-outlined">add</span>
    </button>

    <script>
    (function() {
        'use strict';

        var currentSort = 'newest';
        var currentCat = 'all';
        var feedData = [];    // Supabase'den gelen manifest listesi
        var isLoading = false;

        // ─── Category Config ────────────────────────────
        var CAT_CFG = {
            love:      { label: 'LOVE',    grad: 'grad-love',      dot: '#ff6b8a' },
            money:     { label: 'WEALTH',  grad: 'grad-money',     dot: '#6ee7b7' },
            health:    { label: 'ENERGY',  grad: 'grad-health',    dot: '#fbbf24' },
            career:    { label: 'CAREER',  grad: 'grad-career',    dot: '#fcd34d' },
            spiritual: { label: 'SOUL',    grad: 'grad-spiritual', dot: '#c084fc' },
            general:   { label: 'GENERAL', grad: 'grad-general',   dot: '#93c5fd' }
        };

        // ─── Avatar colors ──────────────────────────────
        var AVATAR_COLS = ['#7c3aed','#a855f7','#ec4899','#f43f5e','#f59e0b','#10b981','#06b6d4','#3b82f6','#6366f1','#8b5cf6'];
        function avatarColor(name) {
            var h = 0;
            for (var i = 0; i < name.length; i++) h = name.charCodeAt(i) + ((h << 5) - h);
            return AVATAR_COLS[Math.abs(h) % AVATAR_COLS.length];
        }
        function initials(name) {
            var p = name.trim().split(/[\s_]+/);
            return p.length >= 2 ? (p[0][0] + p[1][0]).toUpperCase() : name.substring(0, 2).toUpperCase();
        }
        function fmtLikes(n) { return n >= 1000 ? (n/1000).toFixed(1) + 'k' : '' + n; }

        // ─── Fallback Data (Supabase baglanamazsa) ──────
        var FALLBACK = [
            { id:'f1', display_name:'Elif', life_path:7, text:'Evrenin bana gönderdiği sevgiyi açık kalplerle karşılıyorum.', likes:287, category:'love', liked:false },
            { id:'f2', display_name:'Burak', life_path:3, text:'Bolluk ve bereket hayatımın her alanına akıyor.', likes:214, category:'money', liked:false },
            { id:'f3', display_name:'Zeynep', life_path:11, text:'Ruhum her gün daha derin bir farkındalıkla uyanıyor.', likes:195, category:'spiritual', liked:false },
            { id:'f4', display_name:'Emre', life_path:5, text:'Kariyer yolculuğumda evrenin rehberliğine güveniyorum.', likes:178, category:'career', liked:false },
            { id:'f5', display_name:'Ayşe', life_path:9, text:'Bedenim sağlıkla dolu, her hücrem ışıkla titreşiyor.', likes:162, category:'health', liked:false }
        ];

        // ─── Supabase'den feed yükle ────────────────────
        async function loadFromSupabase() {
            if (!window.manifestEngine) return FALLBACK;
            try {
                var data = await window.manifestEngine.loadFeed(currentSort, currentCat, 100);
                if (data && data.length > 0) return data;
                return FALLBACK;
            } catch(e) {
                console.warn('[ManifestCommunity] Supabase load failed, using fallback:', e);
                return FALLBACK;
            }
        }

        // ─── RENDER ─────────────────────────────────────
        function render() {
            var feed = document.getElementById('manifest-feed');
            var all = feedData.slice(); // kopyala

            if (!all.length) {
                feed.innerHTML = '<div class="text-center py-16"><span class="material-symbols-outlined text-white/10" style="font-size:48px;font-variation-settings:\'FILL\' 1;">search_off</span><p class="text-white/20 text-sm mt-3">Bu kategoride manifest bulunamadı</p></div>';
                return;
            }

            var html = '';

            // ── Weekly Champion (newest + all kategorisinde en çok beğenilen) ──
            var weekly = null;
            if (currentSort === 'newest' && currentCat === 'all' && all.length > 0) {
                // En cok begenilen manifesti bul
                var topIdx = 0;
                for (var w = 1; w < all.length; w++) {
                    if ((all[w].likes || 0) > (all[topIdx].likes || 0)) topIdx = w;
                }
                if ((all[topIdx].likes || 0) >= 5) {
                    weekly = all[topIdx];
                    all.splice(topIdx, 1);
                }
            }

            if (weekly) {
                var wName = weekly.display_name || 'User';
                var wc = avatarColor(wName);
                var wi = initials(wName);
                var wIsReal = !weekly.isBot;
                html += '<div class="weekly-card fade-up fd1 mb-4"' + (wIsReal ? ' style="border-color:rgba(168,85,247,0.5);box-shadow:0 0 20px rgba(168,85,247,0.15);"' : '') + '>' +
                    '<div class="flex items-center justify-between mb-4">' +
                        '<div class="flex items-center gap-2"><span class="weekly-badge">⭐ WEEKLY CHAMPION</span>' + (wIsReal ? '<span class="real-user-badge" style="background:rgba(168,85,247,0.3);color:#c084fc;">✨ GERÇEK</span>' : '') + '</div>' +
                        '<span class="weekly-likes">' + fmtLikes(weekly.likes || 0) + ' Likes</span>' +
                    '</div>' +
                    '<p class="weekly-quote mb-5">"' + weekly.text + '"</p>' +
                    '<div class="flex items-center justify-between">' +
                        '<div class="user-pill">' +
                            '<div class="user-avatar-sm" style="background:' + wc + ';">' + wi + '</div>' +
                            '<div style="line-height:1.2;">' +
                                '<div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.8);">' + wName + '</div>' +
                                (weekly.life_path ? '<div style="font-size:9px;color:rgba(255,255,255,0.25);letter-spacing:0.06em;">Life Path ' + weekly.life_path + '</div>' : '') +
                            '</div>' +
                        '</div>' +
                        '<button class="ritual-btn" onclick="handleLike(\'' + weekly.id + '\')"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;font-variation-settings:\'FILL\' ' + (weekly.liked ? '1' : '0') + ';">favorite</span> ' + fmtLikes(weekly.likes || 0) + '</button>' +
                    '</div>' +
                '</div>';
            }

            // ── Grid Cards ──────────────────────────────
            html += '<div class="manifest-grid">';
            for (var i = 0; i < all.length; i++) {
                var m = all[i];
                var c = CAT_CFG[m.category] || CAT_CFG.general;
                var d = Math.min(i + 2, 6);
                var mName = m.display_name || 'User';
                var likedFill = m.liked ? '1' : '0';
                var isReal = !m.isBot;
                var realClass = isReal ? ' real-user-card' : '';

                html += '<div class="grid-card ' + c.grad + realClass + ' fade-up fd' + d + '">' +
                    '<div>' +
                        '<span class="cat-tag"><span class="dot" style="background:' + c.dot + '"></span> ' + c.label + '</span>' +
                        (isReal ? '<span class="real-user-badge">✨ GERÇEK</span>' : '') +
                        '<p class="card-quote">"' + m.text + '"</p>' +
                    '</div>' +
                    '<div class="card-bottom">' +
                        '<span class="card-user">@' + mName + '</span>' +
                        '<button class="card-likes" onclick="event.stopPropagation();handleLike(\'' + m.id + '\')" style="background:none;border:none;cursor:pointer;padding:2px 4px;border-radius:8px;">' +
                            '<span class="material-symbols-outlined" style="font-variation-settings:\'FILL\' ' + likedFill + ';' + (m.liked ? 'color:rgba(220,50,50,0.7);' : '') + '">favorite</span> ' + fmtLikes(m.likes || 0) +
                        '</button>' +
                    '</div>' +
                '</div>';
            }
            html += '</div>';

            feed.innerHTML = html;
        }

        // ─── Like Handler ───────────────────────────────
        window.handleLike = async function(manifestId) {
            if (!manifestId || manifestId.startsWith('f')) return; // fallback data — like desteklenmiyor
            if (!window.manifestEngine) return;

            // Optimistic UI update
            for (var i = 0; i < feedData.length; i++) {
                if (feedData[i].id === manifestId) {
                    feedData[i].liked = !feedData[i].liked;
                    feedData[i].likes = (feedData[i].likes || 0) + (feedData[i].liked ? 1 : -1);
                    if (feedData[i].likes < 0) feedData[i].likes = 0;
                    break;
                }
            }
            render();

            // Supabase'e kaydet
            var result = await window.manifestEngine.toggleLike(manifestId);
            if (result.success) {
                // Gercek sayiyi guncelle
                for (var j = 0; j < feedData.length; j++) {
                    if (feedData[j].id === manifestId) {
                        feedData[j].likes = result.newCount;
                        feedData[j].liked = (result.action === 'liked');
                        break;
                    }
                }
                render();
            }
        };

        // ─── Sort/Category değiştirince yeniden yükle ───
        async function reloadFeed() {
            if (isLoading) return;
            isLoading = true;
            var feed = document.getElementById('manifest-feed');
            feed.innerHTML = '<div class="text-center py-12"><div style="width:28px;height:28px;border:2px solid rgba(124,58,237,0.3);border-top-color:#a855f7;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto;"></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style><p class="text-white/20 text-xs mt-3">Yükleniyor...</p></div>';

            feedData = await loadFromSupabase();
            isLoading = false;
            render();
        }

        // ─── Global Handlers ────────────────────────────
        window.switchSort = function(btn) {
            currentSort = btn.getAttribute('data-sort');
            var t = document.querySelectorAll('.sort-tab');
            for (var i = 0; i < t.length; i++) t[i].classList.remove('active');
            btn.classList.add('active');
            reloadFeed();
        };
        window.switchCat = function(btn) {
            currentCat = btn.getAttribute('data-cat');
            var c = document.querySelectorAll('.cat-chip');
            for (var i = 0; i < c.length; i++) c[i].classList.remove('active');
            btn.classList.add('active');
            reloadFeed();
        };
        window.showInfoModal = function() { document.getElementById('info-modal').style.display = 'flex'; };
        window.closeInfoModal = function() { document.getElementById('info-modal').style.display = 'none'; };

        // ─── My Manifests Modal ───────────────────────
        var CAT_LABELS = { love: 'Love', money: 'Wealth', health: 'Energy', career: 'Career', spiritual: 'Soul', general: 'General' };

        window.openMyManifests = async function() {
            var modal = document.getElementById('my-manifests-modal');
            var body = document.getElementById('my-manifests-body');
            var countEl = document.getElementById('my-manifests-count');
            modal.style.display = 'block';

            // Loading state
            body.innerHTML = '<div class="text-center py-12"><div style="width:28px;height:28px;border:2px solid rgba(124,58,237,0.3);border-top-color:#a855f7;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto;"></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style><p class="text-white/20 text-xs mt-3">Loading...</p></div>';

            if (!window.manifestEngine) {
                body.innerHTML = '<div class="my-modal-empty"><span class="material-symbols-outlined text-white/10" style="font-size:48px;">cloud_off</span><p class="text-white/20 text-sm mt-3">Connection error</p></div>';
                countEl.textContent = '';
                return;
            }

            var myData = await window.manifestEngine.getMyManifests();
            countEl.textContent = myData.length > 0 ? '(' + myData.length + ')' : '';

            if (!myData.length) {
                body.innerHTML = '<div class="my-modal-empty"><span class="material-symbols-outlined text-white/10" style="font-size:48px;font-variation-settings:\'FILL\' 1;">edit_note</span><p class="text-white/20 text-sm mt-3">You have no manifests yet</p><p class="text-white/10 text-xs mt-1">Tap the + button to create your first one!</p></div>';
                return;
            }

            var html = '';
            for (var i = 0; i < myData.length; i++) {
                var m = myData[i];
                var catLabel = CAT_LABELS[m.category] || 'General';
                var dateStr = '';
                if (m.created_at) {
                    var d = new Date(m.created_at);
                    dateStr = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' });
                }

                html += '<div class="my-manifest-item fade-up" style="animation-delay:' + (i * 0.04) + 's;" id="my-m-' + m.id + '">' +
                    '<button class="my-manifest-delete" onclick="event.stopPropagation();deleteMyManifest(\'' + m.id + '\')" title="Delete">' +
                        '<span class="material-symbols-outlined">delete</span>' +
                    '</button>' +
                    '<span class="my-manifest-cat">' + catLabel + '</span>' +
                    '<p class="my-manifest-text">"' + m.text + '"</p>' +
                    '<div class="my-manifest-meta">' +
                        '<span class="my-manifest-date">' + dateStr + '</span>' +
                        '<span class="my-manifest-likes"><span class="material-symbols-outlined" style="font-variation-settings:\'FILL\' 1;">favorite</span> ' + (m.likes || 0) + ' likes</span>' +
                    '</div>' +
                '</div>';
            }
            body.innerHTML = html;
        };

        window.closeMyManifests = function() {
            document.getElementById('my-manifests-modal').style.display = 'none';
        };

        window.deleteMyManifest = async function(manifestId) {
            if (!window.manifestEngine) return;
            if (!confirm('Delete this manifest?')) return;

            var success = await window.manifestEngine.deleteMy(manifestId);
            if (success) {
                // Animasyonlu kaldır
                var el = document.getElementById('my-m-' + manifestId);
                if (el) {
                    el.style.transition = 'all 0.3s ease';
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(60px)';
                    setTimeout(function() { el.remove(); }, 300);
                }
                // Feed'den de kaldır
                for (var i = feedData.length - 1; i >= 0; i--) {
                    if (feedData[i].id === manifestId) {
                        feedData.splice(i, 1);
                        break;
                    }
                }
                render();
                // Count güncelle
                var countEl = document.getElementById('my-manifests-count');
                var remaining = document.querySelectorAll('.my-manifest-item');
                setTimeout(function() {
                    remaining = document.querySelectorAll('.my-manifest-item');
                    countEl.textContent = remaining.length > 0 ? '(' + remaining.length + ')' : '';
                    if (remaining.length === 0) {
                        document.getElementById('my-manifests-body').innerHTML = '<div class="my-modal-empty"><span class="material-symbols-outlined text-white/10" style="font-size:48px;font-variation-settings:\'FILL\' 1;">edit_note</span><p class="text-white/20 text-sm mt-3">You have no manifests yet</p><p class="text-white/10 text-xs mt-1">Tap the + button to create your first one!</p></div>';
                    }
                }, 350);
            }
        };

        // ─── Init ───────────────────────────────────────
        async function init() {
            if (window.auth && window.auth.whenReady) await window.auth.whenReady();
            if (window.gamification) window.gamification.trackAction('manifest_community_visit');
            feedData = await loadFromSupabase();
            render();
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
    <script src="js/notification-engine.js"></script>
    <script src="js/bottom-nav.js"></script>
</body>
</html>
