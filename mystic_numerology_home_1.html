<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <!-- Anti-cache meta tags for daily vibration refresh -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Mystic Numerology Home</title>
    <script src="js/api-base.js"></script>
    <script src="js/tailwind.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/play-billing.js"></script>
    <script src="js/premium.js"></script>
    <script src="js/gamification-engine.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/avatar.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#FAC638",
                        gold: "#D4AF37",
                        "background-light": "#f8f8f5",
                        "background-dark": "#231e0f"
                    },
                    fontFamily: {
                        display: "Montserrat"
                    },
                    borderRadius: {
                        DEFAULT: "1rem",
                        lg: "2rem",
                        xl: "3rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <style type="text/tailwindcss">
        .ethereal-glow {
            background: radial-gradient(circle at top right, rgba(127, 19, 236, 0.4), transparent),
                        radial-gradient(circle at bottom left, rgba(212, 175, 55, 0.1), transparent);
        }
        .cosmic-card {
            background: linear-gradient(135deg, rgba(33, 28, 39, 0.9) 0%, rgba(25, 16, 34, 1) 100%);
            border: 1px solid rgba(127, 19, 236, 0.3);
        }
        .galaxy-gradient {
            background: radial-gradient(circle at 30% 50%, rgba(127, 19, 236, 0.6), transparent 70%),
                        radial-gradient(circle at 70% 50%, rgba(236, 72, 153, 0.4), transparent 70%);
        }
        .indigo-gradient {
            background: radial-gradient(circle at 30% 50%, rgba(49, 46, 129, 0.7), transparent 70%),
                        radial-gradient(circle at 70% 50%, rgba(30, 58, 138, 0.5), transparent 70%),
                        linear-gradient(135deg, rgba(15, 12, 41, 0.95) 0%, rgba(10, 10, 35, 1) 100%);
        }
        .silver-blue-gradient {
            background: radial-gradient(circle at 30% 50%, rgba(148, 163, 184, 0.3), transparent 70%),
                        radial-gradient(circle at 70% 50%, rgba(56, 189, 248, 0.2), transparent 70%),
                        linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(7, 15, 30, 1) 100%);
        }
        .shimmer-border {
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        .shimmer-border::after {
            content: '';
            position: absolute;
            inset: -1px;
            padding: 1px;
            border-radius: inherit;
            background: linear-gradient(135deg, transparent 20%, rgba(255,255,255,0.2) 50%, transparent 80%);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: destination-out;
            pointer-events: none;
        }
        .aura-glow {
            background: radial-gradient(circle at center, rgba(250, 198, 56, 0.2) 0%, transparent 70%);
        }
        .celestial-glow-intense {
            background: radial-gradient(circle at center, rgba(250, 198, 56, 0.35) 0%, rgba(127, 19, 236, 0.1) 40%, transparent 80%);
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white min-h-screen flex flex-col pb-32">

    <!-- HEADER -->
    <header
        class="sticky top-0 z-50 flex items-center bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md p-4 justify-between border-b border-white/5">
        <!-- Sol: Bildirim -->
        <div class="flex w-12 shrink-0 items-center">
            <button id="btn-notif"
                class="relative flex size-10 cursor-pointer items-center justify-center rounded-full bg-white/5 text-white hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined text-xl">notifications</span>
            </button>
        </div>
        <!-- Orta: Logo -->
        <div class="flex flex-col items-center flex-1">
            <h2 class="text-white text-base font-bold leading-tight tracking-[0.15em] uppercase">SOULNUM</h2>
        </div>
        <!-- Sağ: Avatar Profil -->
        <div class="flex w-12 items-center justify-end">
            <button id="header-avatar-btn" onclick="window.location.href='profile_soul_journey.html'"
                class="size-10 rounded-full overflow-hidden border-2 border-primary/50 cursor-pointer active:scale-95 transition-transform">
                <div id="header-avatar-img" class="w-full h-full bg-white/10"></div>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto">

        <!-- Greeting -->
        <div class="px-6 pt-8 pb-4">
            <p class="text-gold text-xs font-medium tracking-widest uppercase mb-1">Celestial Guidance</p>
            <h1 class="text-white tracking-tight text-3xl font-bold leading-tight">The Universe is aligned, <span
                    id="home-user-name">Alex</span></h1>
        </div>

        <!-- Personal Vibration Card -->
        <div class="px-4 py-4">
            <div class="relative overflow-hidden rounded-xl ethereal-glow shadow-2xl border border-white/10">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20 pointer-events-none">
                </div>
                <div class="p-8 flex flex-col items-center text-center">
                    <p class="text-white/60 text-xs font-bold tracking-[0.3em] uppercase mb-6">Personal Vibration</p>
                    <div class="relative mb-6">
                        <div class="absolute inset-0 blur-3xl bg-primary/40 rounded-full scale-150"></div>
                        <span class="relative text-white text-8xl font-black leading-none drop-shadow-[0_0_20px_rgba(127,19,236,0.8)]"
                            id="vib-number">8</span>
                    </div>
                    <h3 class="text-gold text-2xl font-bold tracking-widest uppercase mb-2" id="vib-title">Abundance
                    </h3>
                    <p class="text-white/70 text-sm max-w-[240px] leading-relaxed mb-8" id="vib-desc">Your energy today
                        attracts prosperity and material balance. Focus on manifestation.</p>
                    <button id="btn-deep-insight"
                        class="flex min-w-[180px] cursor-pointer items-center justify-center rounded-full h-12 px-8 bg-primary text-white text-sm font-bold tracking-widest uppercase shadow-lg shadow-primary/30 hover:brightness-110 active:scale-95 transition-all">
                        Deep Insight
                    </button>
                </div>
            </div>
        </div>

        <!-- Section Title -->
        <div class="flex items-center justify-between px-6 pt-6 pb-4">
            <h3 class="text-white text-lg font-bold leading-tight tracking-tight">Personal Cosmic Navigator</h3>
            <button id="btn-details" class="text-gold text-xs font-bold uppercase tracking-widest">Explore Map</button>
        </div>

        <!-- Feature Cards -->
        <div class="flex flex-col gap-6 px-4 pb-8">

            <!-- Soul Mate Analysis -->
            <div id="card-soulmate"
                class="relative w-full rounded-3xl overflow-hidden cosmic-card cursor-pointer active:scale-[0.98] transition-all">
                <div class="absolute inset-0 galaxy-gradient opacity-30"></div>
                <div class="relative p-10 flex flex-col items-center text-center">
                    <div class="mb-6 relative">
                        <div class="absolute inset-0 blur-2xl bg-purple-500/30 rounded-full scale-125"></div>
                        <span class="material-symbols-outlined relative text-primary text-5xl drop-shadow-[0_0_15px_rgba(250,198,56,0.5)]">join_inner</span>
                    </div>
                    <h4 class="text-white text-2xl font-extrabold tracking-widest uppercase mb-4">Soul Mate Analysis</h4>
                    <p class="text-white/80 text-sm leading-relaxed max-w-[280px]">The stars are converging in a divine union of paths.</p>
                    <div class="mt-8 flex items-center justify-center gap-4">
                        <div class="h-px w-8 bg-purple-400/30"></div>
                        <span class="text-white text-[10px] font-bold tracking-[0.3em] uppercase border-b border-purple-400/40 pb-1">Unveil Twin Flame</span>
                        <div class="h-px w-8 bg-purple-400/30"></div>
                    </div>
                </div>
            </div>

            <!-- Cosmic Match -->
            <div id="card-cosmic-match"
                class="relative w-full rounded-3xl overflow-hidden indigo-gradient shimmer-border cursor-pointer active:scale-[0.98] transition-all">
                <div class="relative p-10 flex flex-col items-center text-center">
                    <div class="mb-6 relative">
                        <div class="absolute inset-0 blur-2xl bg-indigo-500/30 rounded-full scale-125"></div>
                        <span class="material-symbols-outlined relative text-indigo-300 text-5xl drop-shadow-[0_0_15px_rgba(129,140,248,0.5)]">settings_ethernet</span>
                    </div>
                    <h4 class="text-white text-2xl font-extrabold tracking-widest uppercase mb-4">Cosmic Match</h4>
                    <p class="text-white/80 text-sm leading-relaxed max-w-[280px]">An analytical deep-dive into the frequency of your celestial resonance.</p>
                    <div class="mt-8 flex items-center justify-center gap-4">
                        <div class="h-px w-8 bg-indigo-400/30"></div>
                        <span class="text-white text-[10px] font-bold tracking-[0.3em] uppercase border-b border-indigo-400/40 pb-1">Measure Resonance</span>
                        <div class="h-px w-8 bg-indigo-400/30"></div>
                    </div>
                </div>
            </div>

            <!-- Decision Sphere -->
            <div id="card-decision-sphere"
                class="relative w-full rounded-3xl overflow-hidden silver-blue-gradient shimmer-border cursor-pointer active:scale-[0.98] transition-all">
                <div class="relative p-10 flex flex-col items-center text-center">
                    <div class="mb-6 relative">
                        <div class="absolute inset-0 blur-2xl bg-blue-400/20 rounded-full scale-125"></div>
                        <span class="material-symbols-outlined relative text-slate-200 text-5xl drop-shadow-[0_0_15px_rgba(226,232,240,0.5)]">model_training</span>
                    </div>
                    <h4 class="text-white text-2xl font-extrabold tracking-widest uppercase mb-4">Decision Sphere</h4>
                    <p class="text-white/80 text-sm leading-relaxed max-w-[280px]">Clarity for your future paths through the lens of divine probability.</p>
                    <div class="mt-8 flex items-center justify-center gap-4">
                        <div class="h-px w-8 bg-slate-400/30"></div>
                        <span class="text-white text-[10px] font-bold tracking-[0.3em] uppercase border-b border-slate-400/40 pb-1">Cast Your Inquiry</span>
                        <div class="h-px w-8 bg-slate-400/30"></div>
                    </div>
                </div>
            </div>

            <!-- Lunar Insights -->
            <div id="card-lunar"
                class="relative w-full rounded-3xl overflow-hidden cosmic-card cursor-pointer active:scale-[0.98] transition-all">
                <div class="relative p-10 flex flex-col items-center text-center">
                    <div class="mb-6 relative">
                        <div class="absolute inset-0 blur-2xl bg-blue-300/20 rounded-full scale-125"></div>
                        <span class="material-symbols-outlined relative text-white text-5xl drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]">nights_stay</span>
                    </div>
                    <h4 class="text-white text-2xl font-extrabold tracking-widest uppercase mb-4">Lunar Insights</h4>
                    <p class="text-white/80 text-sm leading-relaxed max-w-[280px]">The waning crescent invites introspection. Release what no longer serves your higher purpose.</p>
                    <div class="mt-8 flex items-center justify-center gap-4">
                        <div class="h-px w-8 bg-blue-300/30"></div>
                        <span class="text-white text-[10px] font-bold tracking-[0.3em] uppercase border-b border-blue-300/40 pb-1">Explore Cycles</span>
                        <div class="h-px w-8 bg-blue-300/30"></div>
                    </div>
                </div>
            </div>

            <!-- Celestial Forecast -->
            <div id="card-celestial"
                class="relative w-full rounded-3xl overflow-hidden cosmic-card cursor-pointer active:scale-[0.98] transition-all">
                <div class="absolute inset-0 celestial-glow-intense"></div>
                <div class="relative p-10 flex flex-col items-center text-center">
                    <div class="mb-6 relative">
                        <div class="absolute inset-0 blur-2xl bg-primary/30 rounded-full scale-125"></div>
                        <span class="material-symbols-outlined relative text-primary text-5xl drop-shadow-[0_0_15px_rgba(250,198,56,0.6)]"
                            style="font-variation-settings: 'FILL' 1;">auto_awesome</span>
                    </div>
                    <h4 class="text-primary text-2xl font-extrabold tracking-widest uppercase mb-4">Celestial Forecast</h4>
                    <p class="text-white/80 text-sm leading-relaxed max-w-[280px]">Align with the upcoming planetary shifts to maximize your spiritual growth and manifesting power this week.</p>
                    <div class="mt-8 flex items-center justify-center gap-4">
                        <div class="h-px w-8 bg-primary/30"></div>
                        <span class="text-white text-[10px] font-bold tracking-[0.3em] uppercase border-b border-primary/40 pb-1">View Trajectory</span>
                        <div class="h-px w-8 bg-primary/30"></div>
                    </div>
                </div>
            </div>

            <!-- Manifest Portal -->
            <div id="card-manifest-portal"
                class="relative w-full rounded-3xl overflow-hidden cursor-pointer active:scale-[0.98] transition-all"
                style="background:linear-gradient(135deg,#0a0e2a 0%,#1a1040 40%,#0d1a3a 100%);border:1px solid rgba(99,102,241,0.2);">
                <div class="absolute inset-0 opacity-30"
                    style="background:radial-gradient(ellipse at 50% 30%, rgba(99,102,241,0.3), transparent 70%);"></div>
                <div class="relative p-10 flex flex-col items-center text-center">
                    <div class="mb-6 relative">
                        <div class="absolute inset-0 blur-2xl bg-indigo-500/20 rounded-full scale-125"></div>
                        <span class="material-symbols-outlined relative text-indigo-300 text-5xl drop-shadow-[0_0_15px_rgba(129,140,248,0.5)]"
                            style="font-variation-settings: 'FILL' 1;">flare</span>
                    </div>
                    <h4 class="text-white text-2xl font-extrabold tracking-widest uppercase mb-4">Manifest Portal</h4>
                    <p class="text-white/70 text-sm leading-relaxed max-w-[280px]">The Canvas of Space — Your intentions are the stars that light up your personal universe.</p>
                    <div class="mt-8 flex items-center justify-center gap-4">
                        <div class="h-px w-8 bg-indigo-400/30"></div>
                        <span class="text-indigo-300 text-[10px] font-bold tracking-[0.3em] uppercase border-b border-indigo-400/40 pb-1">Enter Portal</span>
                        <div class="h-px w-8 bg-indigo-400/30"></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Günlük Görevler Mini -->
        <div class="px-4 pb-4" id="home-quests-section">
            <div class="flex items-center justify-between mb-3">
                <p class="text-white/30 text-[10px] font-bold uppercase tracking-widest">Günlük Görevler</p>
                <div id="quest-bonus" class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-amber-400/50 text-xs">redeem</span>
                    <span class="text-white/20 text-[10px]">3/3 = Bonus Sandık</span>
                </div>
            </div>
            <div id="home-quests-list" class="space-y-2"></div>
        </div>

        <!-- Quote Section -->
        <div class="px-4 pb-8">
            <div class="rounded-2xl bg-white/5 border border-white/5 p-6 relative overflow-hidden">
                <div class="absolute -right-8 -top-8 size-32 bg-gold/5 rounded-full blur-3xl"></div>
                <span class="material-symbols-outlined text-gold opacity-50 mb-3">auto_awesome</span>
                <p class="text-white/90 text-lg italic leading-relaxed font-light mb-4">
                    "The soul speaks in the language of numbers. Today, listen to the silent vibrations of the world
                    around you."
                </p>
                <div class="flex items-center gap-2">
                    <div class="h-px w-8 bg-gold/30"></div>
                    <p class="text-gold text-[10px] font-bold uppercase tracking-[0.2em]">The Oracle</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Global Bottom Nav + Bubble Menu -->
    <script src="js/notification-engine.js"></script>
    <script src="js/bottom-nav.js"></script>

    <script>
        document.getElementById('btn-deep-insight').onclick = function () { window.location.href = 'name_numerology_breakdown_1.html'; };
        document.getElementById('btn-details').onclick = function () { window.location.href = 'numerology_meaning_chart.html'; };

        document.getElementById('card-celestial').onclick = function () { window.location.href = 'cosmic_energy_calendar_2.html'; };
        document.getElementById('card-lunar').onclick = function () { window.location.href = 'lunar_phase_energy_tracker.html'; };
        document.getElementById('card-soulmate').onclick = function () { window.location.href = 'compatibility_input_form.html'; };
        document.getElementById('card-cosmic-match').onclick = function () { window.location.href = 'cosmic_match.html'; };
        document.getElementById('card-decision-sphere').onclick = function () { if (window.aelOpen) window.aelOpen(); };
        document.getElementById('card-manifest-portal').onclick = function () { window.location.href = 'manifest_portal.html'; };
        // Gamification home entegrasyonu
        if (window.gamification) {
            var badge = document.getElementById('home-rank-badge');
            if (badge) badge.style.borderColor = rp.current.color + '40';

            // Günlük görevler
            var quests = window.gamification.getQuests();
            var ql = document.getElementById('home-quests-list');
            if (ql && quests) {
                ql.innerHTML = '';
                quests.forEach(function(q) {
                    var el = document.createElement('div');
                    el.className = 'flex items-center gap-3 px-4 py-3 rounded-xl border transition-all';
                    el.style.cssText = q.completed
                        ? 'background:rgba(34,197,94,0.05);border-color:rgba(34,197,94,0.15)'
                        : 'background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.05)';
                    el.innerHTML =
                        '<span class="material-symbols-outlined text-base" style="color:' + (q.completed ? '#22c55e' : 'rgba(255,255,255,0.2)') + ';font-variation-settings:\'FILL\' ' + (q.completed ? '1' : '0') + '">' + (q.completed ? 'check_circle' : q.icon) + '</span>' +
                        '<span class="flex-1 text-xs font-medium" style="color:' + (q.completed ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.6)') + ';' + (q.completed ? 'text-decoration:line-through' : '') + '">' + q.name + '</span>' +
                        '<span class="text-xs font-bold" style="color:' + (q.completed ? 'rgba(34,197,94,0.5)' : 'rgba(255,255,255,0.15)') + '">+' + q.xp + ' XP</span>';
                    ql.appendChild(el);
                });
            }
        }
    </script>

    <!-- ═══ GÜNLÜK KİŞİSEL VİBRASYON MOTORU ═══ -->
    <script>
    (async function() {
        // Auth hazır olana kadar bekle (Supabase'den güncel veri gelsin)
        if (window.auth && window.auth.whenReady) { await window.auth.whenReady(); }

        // ─── Numeroloji Yardımcıları ──────────────────────────
        function reduce(n) {
            if (n===11||n===22||n===33) return n;
            while (n > 9) {
                n = String(n).split('').reduce(function(a,d){return a+parseInt(d);},0);
                if (n===11||n===22||n===33) break;
            }
            return n;
        }
        function calcLP(dateStr) {
            if (!dateStr) return null;
            return reduce(dateStr.replace(/\D/g,'').split('').reduce(function(a,d){return a+parseInt(d);},0));
        }

        // Kişisel Yıl = reduce(doğum_gün + doğum_ay + mevcut_yıl)
        function calcPersonalYear(birthDate, year) {
            var parts = birthDate.split('-');
            if (parts.length < 3) return null;
            var bDay = parseInt(parts[2]);
            var bMonth = parseInt(parts[1]);
            return reduce(bDay + bMonth + parseInt(String(year).split('').reduce(function(a,d){return a+parseInt(d);},0)));
        }
        // Kişisel Ay = reduce(kişisel_yıl + mevcut_ay)
        function calcPersonalMonth(pyear, month) { return reduce(pyear + month); }
        // Kişisel Gün = reduce(kişisel_ay + mevcut_gün)
        function calcPersonalDay(pmonth, day) { return reduce(pmonth + day); }

        // ─── Vibrasyon Temaları ───────────────────────────────
        var VIB_THEMES = {
            1:  { title: 'INITIATION',        color: '#f2cc0d', glow: 'rgba(242,204,13,0.5)' },
            2:  { title: 'EVALUATION',        color: '#a78bfa', glow: 'rgba(167,139,250,0.5)' },
            3:  { title: 'EXPRESSION',        color: '#fb923c', glow: 'rgba(251,146,60,0.5)'  },
            4:  { title: 'STRUCTURE',         color: '#4ade80', glow: 'rgba(74,222,128,0.5)'  },
            5:  { title: 'CHANGE',            color: '#38bdf8', glow: 'rgba(56,189,248,0.5)'  },
            6:  { title: 'STABILITY',         color: '#f472b6', glow: 'rgba(244,114,182,0.5)' },
            7:  { title: 'ANALYSIS',          color: '#818cf8', glow: 'rgba(129,140,248,0.5)' },
            8:  { title: 'CONTROL',           color: '#f2cc0d', glow: 'rgba(242,204,13,0.5)'  },
            9:  { title: 'COMPLETION',        color: '#c084fc', glow: 'rgba(192,132,252,0.5)' },
            11: { title: 'HIGH INTENSITY',    color: '#e2e8f0', glow: 'rgba(226,232,240,0.5)' },
            22: { title: 'MASTER EXECUTION',  color: '#fbbf24', glow: 'rgba(251,191,36,0.5)'  },
            33: { title: 'MASTER GUIDANCE',   color: '#f9a8d4', glow: 'rgba(249,168,212,0.5)' }
        };

        // Fallback açıklamalar (AI yoksa kullanılır)
        var VIB_DESC = {
            1:  'Başlatma ve doğrudan karar için sayısal destek güçlü. Harekete geçin.',
            2:  'Değerlendirme ve koordinasyon için uygun kombinasyon. Dinleyin ve analiz edin.',
            3:  'İfade ve iletişim için sayısal eğilim güçlü. Paylaşın.',
            4:  'Sistematik çalışma ve yapısal kararlar destekleniyor. Disiplinli olun.',
            5:  'Değişim ve adaptasyon için sayısal etki aktif. Esnek olun.',
            6:  'Sorumluluk ve bakım eylemleri destekleniyor. Yakınlarınıza zaman ayırın.',
            7:  'Analiz ve iç değerlendirme destekleniyor. Araştırma için ideal.',
            8:  'Finansal kararlar ve otorite eylemleri destekleniyor. Kararlı olun.',
            9:  'Tamamlama ve kapatma eylemleri destekleniyor. Süreçleri sonlandırın.',
            11: 'Yüksek sayısal yoğunluk. Analitik derinlik artırılmış.',
            22: 'Büyük ölçekli projeler için sayısal destek güçlü. Yapısal kararlar alın.',
            33: 'Rehberlik ve büyük ölçekli sorumluluk destekleniyor.'
        };

        // ─── Bugünün Cache Key'i ─────────────────────────────
        var today = new Date();
        var todayStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

        // AGGRESSIVE CACHE BYPASS for Opera
        var lastVisit = localStorage.getItem('numerael_last_visit_date');

        if (!lastVisit || lastVisit !== todayStr) {
            console.log('[AGGRESSIVE CACHE FIX] Clearing old cache...', lastVisit, '->', todayStr);

            Object.keys(localStorage).forEach(function(key) {
                if (key.startsWith('numerael_daily_vib__')) {
                    console.log('[Cache Clear] Removing:', key);
                    localStorage.removeItem(key);
                }
            });

            localStorage.setItem('numerael_last_visit_date', todayStr);

            var urlParams = new URLSearchParams(window.location.search);
            var ts = urlParams.get('_t');
            if (!ts || ts !== todayStr) {
                var newUrl = window.location.pathname + '?_t=' + todayStr;
                console.log('[AGGRESSIVE CACHE FIX] Force reload with timestamp:', newUrl);
                window.location.replace(newUrl);
                return;
            }
        }

        localStorage.setItem('numerael_last_visit_date', todayStr);

        // DEBUG FUNCTION
        window.clearDailyCache = function() {
            console.log('[Manual Cache Clear] Clearing all daily vibration cache...');
            Object.keys(localStorage).forEach(function(key) {
                if (key.startsWith('numerael_daily_vib__') || key === 'numerael_last_visit_date') {
                    localStorage.removeItem(key);
                    console.log('[Manual Cache Clear] Removed:', key);
                }
            });
            console.log('[Manual Cache Clear] Done! Reloading page...');
            window.location.reload(true);
        };

        // ─── Kullanıcı Verisi ─────────────────────────────────
        var ud = null;
        try { ud = JSON.parse(localStorage.getItem('numerael_user_data') || 'null'); } catch(e) {}

        var firstName = 'Alex';
        if (ud && ud.name) firstName = ud.name.split(' ')[0];

        // Header avatar
        if (window.avatarUtil) {
            var avatarEl = document.getElementById('header-avatar-img');
            if (avatarEl) {
                window.avatarUtil.setAvatar(avatarEl, {
                    avatarUrl: (ud && ud.avatarUrl) || null,
                    name: (ud && ud.name) || '',
                    gender: (ud && ud.gender) || null
                });
            }
        }

        var nameEl = document.getElementById('home-user-name');
        if (nameEl) nameEl.textContent = firstName;

        if (!ud || !ud.name || !ud.birthDate) return;

        var lp = calcLP(ud.birthDate);
        var py = calcPersonalYear(ud.birthDate, today.getFullYear());
        var pm = calcPersonalMonth(py, today.getMonth()+1);
        var pd = calcPersonalDay(pm, today.getDate());

        console.log('[VIBRATION DEBUG]', {
            date: todayStr,
            birthDate: ud.birthDate,
            lifePath: lp,
            personalYear: py,
            personalMonth: pm,
            personalDay: pd,
            'Personal Day (TODAYS VIBRATION)': pd
        });

        var theme = VIB_THEMES[pd] || VIB_THEMES[8];
        var cacheKey = 'numerael_daily_vib__' + todayStr + '__lp' + lp + '__pd' + pd;

        console.log('[VIBRATION DEBUG] Cache key:', cacheKey);
        console.log('[VIBRATION DEBUG] Theme:', theme.title);

        // ─── UI: Vibrasyon sayısı ve tema ────────────────────
        var numEl  = document.getElementById('vib-number');
        var titEl  = document.getElementById('vib-title');
        var dscEl  = document.getElementById('vib-desc');

        if (numEl) {
            numEl.textContent = pd;
            numEl.style.filter = 'drop-shadow(0 0 20px ' + theme.glow + ')';
        }
        if (titEl) {
            titEl.textContent = theme.title;
            titEl.style.color = theme.color;
        }

        // ─── Cache kontrolü ───────────────────────────────────
        var cached = null;
        try { cached = localStorage.getItem(cacheKey); } catch(e) {}

        if (cached) {
            if (dscEl) dscEl.textContent = cached;
            return;
        }

        // ─── Fallback açıklamayı hemen göster ────────────────
        if (dscEl) dscEl.textContent = VIB_DESC[pd] || VIB_DESC[8];

        // ─── AI ile kişiselleştirilmiş içerik ────────────────
        var prompt = 'Sen Soulnum uygulamasının numeroloji yorumcususun. Türkçe yaz, 2 kısa cümle (max 25 kelime), mistik ve kişisel ton.' +
            ' Kullanıcı: ' + ud.name +
            '. Life Path: ' + lp +
            '. Kişisel Yıl: ' + py +
            '. Bugünkü Kişisel Gün: ' + pd + ' (' + (theme.title) + ')' +
            '. Doğum tarihi: ' + ud.birthDate +
            '. Bugünün enerjisini bu kişiye özel anlat. Başlık yok, madde işareti yok.';

        fetch((window.__NUMERAEL_API_BASE||'') + '/api/openai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.8,
                max_tokens: 80
            })
        }).then(function(r){ return r.json(); })
        .then(function(data) {
            var text = data.choices && data.choices[0] ? data.choices[0].message.content.trim() : null;
            if (text && dscEl) {
                dscEl.style.animation = 'fadeIn 0.6s ease';
                dscEl.textContent = text;
                try { localStorage.setItem(cacheKey, text); } catch(e) {}
            }
        }).catch(function(e){ console.warn('Daily vibration AI error:', e); });

    })();
    </script>
    <script src="js/numerology-context-engine.js"></script>
    <script src="js/decision-timing-engine.js"></script>
    <script src="js/numerology-ai.js"></script>
</body>

</html>
