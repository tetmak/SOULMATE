<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Cosmic Match</title>
    <script src="js/tailwind.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,400&display=swap" rel="stylesheet" />
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/play-billing.js"></script>
    <script src="js/premium.js"></script>
    <script src="js/gamification-engine.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/discovery-engine.js"></script>
    <script src="js/connection-engine.js"></script>
    <script src="js/avatar.js"></script>
    <script id="tailwind-config">
        tailwind.config = { darkMode:"class", theme:{ extend:{
            colors:{ primary:"#d4af37","background-dark":"#242424","surface-dark":"#3d3935","card-dark":"#33302d","cosmic-violet":"#d4af37","cosmic-pink":"#e0115f","cosmic-blue":"#1e90ff" },
            fontFamily:{ display:["Cinzel Decorative","serif"] },
            borderRadius:{ DEFAULT:"1rem",lg:"2rem",xl:"3rem",full:"9999px" }
        }}}
    </script>
    <style>
        :root {
            --temple-grey: #2C2C2C;
            --dawn-charcoal: #383838;
            --luminous-beige: #f5ead2;
            --gold-bright: #ffd700;
            --gold-rich: #d4af37;
            --gold-deep: #996515;
            --ruby-jewel: #e0115f;
            --emerald-jewel: #00fa9a;
            --sapphire-jewel: #1e90ff;
        }
        .material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}
        body {
            min-height:max(884px,100dvh);
            font-family:"Crimson Pro",serif;
            color:var(--luminous-beige);
            background-color:#242424;
            background-image:radial-gradient(circle at 50% 50%,rgba(212,175,55,0.08) 0%,transparent 80%);
        }
        .decorative-header{font-family:"Cinzel Decorative",serif}

        /* â•â•â• SCROLL BACKGROUND â•â•â• */
        .scroll-bg {
            background-color: var(--dawn-charcoal);
            background-image: linear-gradient(rgba(44,44,44,0.85),rgba(56,56,56,0.95));
            box-shadow: 0 0 70px rgba(0,0,0,0.6), inset 0 0 120px rgba(212,175,55,0.05);
            border-left: 8px solid #544a42;
            border-right: 8px solid #544a42;
            position: relative;
        }
        .scroll-bg::before,.scroll-bg::after {
            content:"";position:absolute;left:-12px;right:-12px;height:28px;
            background:linear-gradient(90deg,#6d5d54,#b08d57,#ffe59e,#b08d57,#6d5d54);
            border-radius:14px;box-shadow:0 4px 15px rgba(0,0,0,0.4);z-index:50;
        }
        .scroll-bg::before{top:-14px}
        .scroll-bg::after{bottom:-14px}

        /* â•â•â• MATCH RIBBON â•â•â• */
        .match-ribbon{display:flex;overflow-x:auto;scrollbar-width:none;gap:12px;padding:10px 0 20px 0;margin-bottom:10px;border-bottom:1px solid rgba(212,175,55,0.15)}
        .match-ribbon::-webkit-scrollbar{display:none}
        .scroll-fragment{flex:0 0 auto;width:55px;height:75px;background:rgba(60,60,60,0.6);border:1px solid var(--gold-deep);padding:4px;box-shadow:0 4px 8px rgba(0,0,0,0.3);display:flex;flex-direction:column;align-items:center;justify-content:center}
        .profile-silhouette{width:28px;height:28px;background:var(--gold-rich);mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");mask-size:contain;mask-repeat:no-repeat;opacity:0.5}
        .scroll-fragment{transition:all 0.3s ease;cursor:pointer}
        .scroll-fragment.ribbon-active{border-color:var(--gold-bright) !important;box-shadow:0 0 15px rgba(255,215,0,0.4);transform:scale(1.12)}

        /* â•â•â• CONFLUENCE ORB â•â•â• */
        .confluence-orb {
            width:260px;height:260px;border-radius:50%;position:relative;
            background:radial-gradient(circle at center,rgba(255,215,0,0.12) 0%,rgba(44,44,44,0.8) 100%);
            border:4px solid transparent;background-clip:padding-box;
            box-shadow:0 0 50px rgba(255,215,0,0.15),inset 0 0 80px rgba(0,0,0,0.4);
            display:flex;align-items:center;justify-content:center;overflow:visible;
        }
        .confluence-orb::before {
            content:"";position:absolute;inset:-4px;border-radius:50%;padding:4px;
            background:linear-gradient(135deg,#d4af37,#ffd700,#996515,#fff700,#d4af37);
            -webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
            mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
            -webkit-mask-composite:xor;mask-composite:exclude;
        }
        .filigree-overlay {
            position:absolute;inset:0;border-radius:50%;opacity:0.2;
            background-image:url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 0 C70 20 80 40 80 50 C80 60 70 80 50 100 C30 80 20 60 20 50 C20 40 30 20 50 0' fill='none' stroke='%23ffd700' stroke-width='0.8'/%3E%3C/svg%3E");
            background-size:50px;animation:rotate 80s linear infinite;
        }
        .soul-mote {
            position:absolute;width:14px;height:14px;border-radius:50%;background:white;
            filter:blur(0.5px);z-index:5;pointer-events:none;
        }
        .mote-1{top:25%;left:35%;background:#fffcf0;box-shadow:0 0 20px #fffcf0,0 0 40px var(--gold-bright)}
        .mote-2{top:55%;right:20%;background:#eef7ff;box-shadow:0 0 25px #eef7ff,0 0 45px var(--sapphire-jewel)}
        .mote-3{bottom:30%;left:25%;background:#fff1f1;box-shadow:0 0 25px #fff1f1,0 0 45px var(--ruby-jewel)}
        .mote-4{top:40%;right:45%;background:#f2fff6;box-shadow:0 0 25px #f2fff6,0 0 45px var(--emerald-jewel)}

        /* â•â•â• SOUL CARD â•â•â• */
        .soul-card {
            border:2px solid var(--gold-rich);padding:4px;background:#33302d;position:relative;
            box-shadow:0 15px 35px rgba(0,0,0,0.4);transition:all 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
        }
        .soul-card-inner {
            border:1px solid var(--gold-deep);padding:1.5rem;height:100%;
            display:flex;flex-direction:column;align-items:center;background:#3d3935;
        }

        /* â•â•â• METALLIC GOLD TEXT â•â•â• */
        .metallic-gold {
            background:linear-gradient(135deg,#bf953f,#fcf6ba,#b38728,#fbf5b7,#aa771c);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            filter:drop-shadow(0 0 5px rgba(255,215,0,0.3));
        }

        /* â•â•â• GOLD DIVIDER â•â•â• */
        .gold-divider{height:1px;background:linear-gradient(90deg,transparent,var(--gold-rich),transparent);margin:1.5rem 0;position:relative}
        .gold-divider::after{content:"â—ˆ";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--dawn-charcoal);padding:0 10px;color:var(--gold-bright);font-size:14px}

        /* â•â•â• ORACLE BUTTON â•â•â• */
        .btn-oracle{background:var(--temple-grey);color:var(--gold-bright);border:1px solid var(--gold-rich);font-family:"Cinzel Decorative",serif;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
        .btn-oracle:hover{background:var(--gold-rich);color:#2c2c2c}

        /* â•â•â• FUNCTIONAL CSS (adapted to oracle theme) â•â•â• */
        .cosmic-gradient{background:linear-gradient(135deg,#bf953f 0%,#ffd700 50%,#b38728 100%)}
        .cosmic-gradient-text{background:linear-gradient(135deg,#bf953f,#fcf6ba,#b38728);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .cosmic-glow{box-shadow:0 0 30px rgba(212,175,55,0.3),0 0 60px rgba(255,215,0,0.15)}
        .cosmic-border{border:1px solid rgba(212,175,55,0.2)}

        .glass{background:rgba(60,60,60,0.4);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.05)}
        .glass-cosmic{background:rgba(60,60,60,0.3);backdrop-filter:blur(12px);border:1px solid rgba(212,175,55,0.12)}

        /* â•â•â• ANIMATIONS â•â•â• */
        @keyframes fade-up{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse-glow{0%,100%{box-shadow:0 0 20px rgba(212,175,55,0.3)}50%{box-shadow:0 0 40px rgba(255,215,0,0.5)}}
        @keyframes radar-ping{0%{transform:scale(1);opacity:0.6}100%{transform:scale(2.5);opacity:0}}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        @keyframes reveal-flash{0%{opacity:0;transform:scale(0.8)}50%{opacity:1;transform:scale(1.05)}100%{opacity:1;transform:scale(1)}}
        @keyframes streak-fire{0%,100%{text-shadow:0 0 8px rgba(251,191,36,0.5)}50%{text-shadow:0 0 20px rgba(251,191,36,0.8)}}
        @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
        @keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

        .fade-up{animation:fade-up 0.5s ease forwards;opacity:0}
        .pulse-glow{animation:pulse-glow 3s ease-in-out infinite}
        .float-anim{animation:float 3s ease-in-out infinite}
        .streak-fire{animation:streak-fire 2s ease-in-out infinite}
        .shimmer-placeholder{background:linear-gradient(90deg,rgba(212,175,55,0.08) 25%,rgba(255,215,0,0.15) 50%,rgba(212,175,55,0.08) 75%);background-size:200% 100%;animation:shimmer 2s ease-in-out infinite}

        /* â•â•â• RADAR â•â•â• */
        .radar-ring{position:absolute;border-radius:50%;border:1px solid rgba(212,175,55,0.1);top:50%;left:50%;transform:translate(-50%,-50%)}
        .radar-ping{position:absolute;border-radius:50%;background:rgba(212,175,55,0.15);top:50%;left:50%;transform:translate(-50%,-50%);animation:radar-ping 3s ease-out infinite}
        .radar-dot{position:absolute;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;cursor:pointer;transition:all 0.3s;border:2px solid}
        .radar-dot:hover{transform:scale(1.3);z-index:10}

        /* â•â•â• MATCH CARD BLUR/REVEAL â•â•â• */
        .match-card-blur .blur-layer{filter:blur(8px);-webkit-filter:blur(8px);transition:filter 0.8s ease}
        .match-card-revealed .blur-layer{filter:none;-webkit-filter:none}

        /* â•â•â• STREAK BADGE â•â•â• */
        .streak-badge{background:linear-gradient(135deg,#d4af37,#996515);box-shadow:0 0 12px rgba(212,175,55,0.4)}

        /* â•â•â• DIVIDER â•â•â• */
        .cosmic-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(212,175,55,0.2),transparent)}

        /* â•â•â• SCROLLBAR â•â•â• */
        ::-webkit-scrollbar{width:4px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.2);border-radius:2px}

        /* â•â•â• ENGRAVING EFFECT â•â•â• */
        .engraving-effect{filter:grayscale(0.5) contrast(1.1) brightness(0.9) sepia(0.2)}
    </style>
</head>
<body class="min-h-screen py-6 flex justify-center">
<div class="max-w-[480px] w-full mx-auto min-h-[95vh] scroll-bg px-6 pb-24 pt-6 flex flex-col">

    <!-- â•â•â• MATCH RIBBON (bugÃ¼nÃ¼n eÅŸleÅŸmeleri) â•â•â• -->
    <div id="match-ribbon" class="match-ribbon">
        <!-- JS ile doldurulacak -->
    </div>

    <!-- â•â•â• HEADER â•â•â• -->
    <header class="text-center mb-4">
        <div class="flex justify-between items-center mb-4 px-2">
            <div onclick="window.location.href='mystic_numerology_home_1.html'" class="cursor-pointer">
                <span class="material-symbols-outlined text-[var(--gold-rich)]">arrow_back_ios</span>
            </div>
            <div id="streak-badge" class="streak-badge rounded-full px-2.5 py-1 flex items-center gap-1 cursor-default" title="Streak">
                <span class="text-white text-xs streak-fire">ğŸ”¥</span>
                <span id="streak-count" class="text-white text-xs font-black">0</span>
            </div>
        </div>
        <h1 class="decorative-header text-3xl font-black metallic-gold tracking-widest mb-2">The Oracle</h1>
        <p class="italic opacity-90 text-sm drop-shadow-sm">Kozmik EÅŸleÅŸme Â· RuhlarÄ±n BuluÅŸma NoktasÄ±</p>
    </header>

    <!-- â•â•â• OPT-IN EKRANI â•â•â• -->
    <div id="optin-screen" style="display:none" class="flex-1 flex flex-col items-center justify-center px-2 py-12 text-center">
        <div class="size-28 rounded-full flex items-center justify-center mb-8 pulse-glow" style="background:radial-gradient(circle,rgba(255,215,0,0.15),rgba(44,44,44,0.8));border:3px solid var(--gold-rich)">
            <span class="material-symbols-outlined text-5xl" style="color:var(--gold-bright)">auto_awesome</span>
        </div>
        <h2 class="decorative-header text-2xl font-black metallic-gold mb-3">Kozmik EÅŸleÅŸme</h2>
        <p class="opacity-60 text-sm leading-relaxed max-w-[300px] mb-8 italic">
            Numerolojik profilini diÄŸer kullanÄ±cÄ±larla paylaÅŸ ve evrenin senin iÃ§in seÃ§tiÄŸi ruh eÅŸlerini keÅŸfet.
            Her gÃ¼n yeni bir eÅŸleÅŸme, her 3 gÃ¼nde bir reveal hakkÄ±!
        </p>
        <div class="glass-cosmic rounded-lg p-4 mb-6 w-full max-w-[320px]" style="border:1px solid var(--gold-deep)">
            <div class="flex items-center gap-3 mb-3">
                <span class="material-symbols-outlined" style="color:var(--gold-bright)">visibility</span>
                <div class="flex-1 text-left">
                    <p class="text-sm font-bold">Ne paylaÅŸÄ±lÄ±r?</p>
                    <p class="opacity-50 text-xs">Sadece ismin, yaÅŸam yolu ve numerolojik sayÄ±larÄ±n</p>
                </div>
            </div>
            <div class="flex items-center gap-3 mb-3">
                <span class="material-symbols-outlined" style="color:var(--ruby-jewel)">lock</span>
                <div class="flex-1 text-left">
                    <p class="text-sm font-bold">Gizlilik</p>
                    <p class="opacity-50 text-xs">DoÄŸum tarihin ve kiÅŸisel verilerin paylaÅŸÄ±lmaz</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined" style="color:var(--emerald-jewel)">toggle_on</span>
                <div class="flex-1 text-left">
                    <p class="text-sm font-bold">Ä°stediÄŸin zaman kapat</p>
                    <p class="opacity-50 text-xs">Profil ayarlarÄ±ndan keÅŸfedilebilirliÄŸini kapat</p>
                </div>
            </div>
        </div>
        <button id="btn-optin" class="w-full max-w-[320px] py-4 btn-oracle rounded-none shadow-xl flex items-center justify-center gap-3 uppercase tracking-[0.2em] text-sm font-bold active:scale-95 transition-transform">
            <span class="material-symbols-outlined">rocket_launch</span>
            KeÅŸfe KatÄ±l
        </button>
        <p class="opacity-30 text-xs mt-4 italic">Ä°stediÄŸin zaman devre dÄ±ÅŸÄ± bÄ±rakabilirsin</p>
    </div>

    <!-- â•â•â• ANA Ä°Ã‡ERÄ°K â•â•â• -->
    <div id="main-content" style="display:none">

        <!-- Streak & Reveal Credits Bar -->
        <div class="px-5 pt-5 pb-2 fade-up" style="animation-delay:0.05s">
            <div class="flex items-center gap-3">
                <div class="flex-1 glass-cosmic rounded-lg p-3 flex items-center gap-3" style="border:1px solid var(--gold-deep)">
                    <div class="size-10 rounded-full flex items-center justify-center shrink-0" style="background:rgba(212,175,55,0.15)">
                        <span class="text-xl streak-fire">ğŸ”¥</span>
                    </div>
                    <div>
                        <p id="streak-label" class="text-sm font-black">0 GÃ¼n Streak</p>
                        <p id="streak-next" class="opacity-40 text-[10px]">Sonraki Ã¶dÃ¼l: 3 gÃ¼nde</p>
                    </div>
                </div>
                <div class="glass-cosmic rounded-lg p-3 flex items-center gap-3 shrink-0" style="border:1px solid var(--gold-deep)">
                    <div class="size-10 rounded-full flex items-center justify-center" style="background:rgba(212,175,55,0.15)">
                        <span class="material-symbols-outlined text-xl" style="color:var(--gold-bright)">visibility</span>
                    </div>
                    <div>
                        <p id="credits-count" class="text-sm font-black">3</p>
                        <p id="credits-label" class="opacity-40 text-[10px]">BugÃ¼n</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â• CONFLUENCE ORB (Uyumluluk RadarÄ±) â•â•â• -->
        <section class="mb-6 flex flex-col items-center relative fade-up" style="animation-delay:0.1s">
            <div class="flex items-center gap-2 mb-4">
                <span class="material-symbols-outlined text-base" style="color:var(--gold-bright)">radar</span>
                <p class="opacity-50 text-[10px] font-bold uppercase tracking-widest decorative-header">Uyumluluk RadarÄ±</p>
            </div>

            <div class="confluence-orb mb-4">
                <div class="filigree-overlay"></div>
                <!-- Decorative soul motes -->
                <div class="soul-mote mote-1"></div>
                <div class="soul-mote mote-2"></div>
                <div class="soul-mote mote-3"></div>
                <div class="soul-mote mote-4"></div>
                <!-- Radar rings -->
                <div class="radar-ring" style="width:200px;height:200px"></div>
                <div class="radar-ring" style="width:140px;height:140px"></div>
                <div class="radar-ring" style="width:80px;height:80px"></div>
                <!-- Radar ping -->
                <div class="radar-ping" style="width:80px;height:80px"></div>
                <!-- Center (user) -->
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20">
                    <div id="radar-center" class="size-14 rounded-full cosmic-gradient flex items-center justify-center border-2 cosmic-glow" style="border-color:var(--dawn-charcoal)">
                        <span id="radar-user-initial" class="text-white text-lg font-black">?</span>
                    </div>
                    <div id="radar-rank-label" class="absolute -bottom-5 left-1/2 -translate-x-1/2 whitespace-nowrap text-[8px] font-bold px-2 py-0.5 rounded-full" style="background:rgba(0,0,0,0.6)">â€”</div>
                </div>
                <!-- Radar dots (JS fills) -->
                <div id="radar-dots"></div>
            </div>

            <div id="radar-empty" style="display:none" class="text-center mt-2">
                <p class="opacity-40 text-xs italic">Radar etrafÄ±nda henÃ¼z ruh yok...</p>
            </div>
            <div id="radar-info" style="display:none" class="text-center mt-2">
                <p class="opacity-50 text-xs"><span id="radar-count">0</span> uyumlu ruh etrafÄ±nda âœ¦</p>
            </div>
        </section>

        <!-- â•â•â• BUGÃœNÃœN KOZMÄ°K EÅLEÅMESÄ° â€” SOUL CARD â•â•â• -->
        <div class="fade-up" style="animation-delay:0.15s">
            <div class="flex items-center gap-2 mb-3 px-2">
                <span class="material-symbols-outlined text-base" style="color:var(--ruby-jewel)">today</span>
                <p class="opacity-50 text-[10px] font-bold uppercase tracking-widest decorative-header">BugÃ¼nÃ¼n Kozmik EÅŸleÅŸmesi</p>
            </div>

            <div id="match-card" class="soul-card w-full max-w-[320px] mx-auto match-card-blur">
                <div class="soul-card-inner relative overflow-hidden">

                    <!-- Loading state -->
                    <div id="match-loading" class="flex flex-col items-center gap-4 py-8">
                        <div class="size-24 rounded-full shimmer-placeholder"></div>
                        <div class="h-4 w-32 rounded shimmer-placeholder"></div>
                        <div class="h-3 w-24 rounded shimmer-placeholder"></div>
                    </div>

                    <!-- Match content -->
                    <div id="match-content" style="display:none">
                        <!-- Avatar -->
                        <div class="relative mb-4 flex justify-center">
                            <div id="match-avatar" class="blur-layer size-28 rounded-full border-double border-4 overflow-hidden flex items-center justify-center" style="border-color:var(--gold-deep);background:rgba(0,0,0,0.1)">
                                <span style="color:var(--gold-rich)" class="text-4xl font-black">?</span>
                            </div>
                            <div class="absolute bottom-0 right-[calc(50%-4.5rem)] size-8 rounded-full cosmic-gradient flex items-center justify-center border-2" style="border-color:var(--dawn-charcoal)">
                                <span id="match-lp" class="text-white text-xs font-black">?</span>
                            </div>
                        </div>

                        <!-- Name -->
                        <h3 id="match-name" class="blur-layer decorative-header text-2xl text-center mb-1 drop-shadow-md">???</h3>
                        <p id="match-archetype" class="text-center text-xs font-bold uppercase tracking-widest mb-4" style="color:var(--ruby-jewel)">Life Path ?</p>

                        <div class="w-12 h-px mx-auto mb-3" style="background:var(--gold-deep)"></div>

                        <!-- Bond label -->
                        <div class="text-center px-4 mb-4">
                            <p id="match-bond" class="italic text-sm leading-relaxed metallic-gold">â€”</p>
                        </div>

                        <!-- Score -->
                        <div class="flex justify-between items-baseline w-full px-4 mb-2">
                            <span id="match-score" class="metallic-gold decorative-header text-3xl drop-shadow-sm">â€”%</span>
                            <span class="text-[10px] uppercase opacity-60 font-bold tracking-tighter" style="color:var(--luminous-beige)">Bond Strength</span>
                        </div>

                        <!-- Score bar -->
                        <div class="w-full h-1.5 rounded-full overflow-hidden mt-2 mb-4" style="background:rgba(255,255,255,0.05)">
                            <div id="match-bar" class="h-full rounded-full cosmic-gradient" style="width:0%;transition:width 1.5s cubic-bezier(0.34,1.56,0.64,1)"></div>
                        </div>

                        <!-- Reveal button -->
                        <button id="btn-reveal" style="display:none"
                            class="w-full py-4 btn-oracle rounded-none shadow-xl flex items-center justify-center gap-3 uppercase tracking-[0.2em] text-xs font-bold active:scale-95 transition-transform">
                            <span id="reveal-label">Profili AÃ§ (1 Reveal)</span>
                            <span class="material-symbols-outlined text-base">fluid</span>
                        </button>

                        <!-- Already revealed info -->
                        <div id="revealed-info" style="display:none" class="w-full text-center mt-2">
                            <p class="opacity-50 text-xs italic">âœ¦ BugÃ¼nkÃ¼ eÅŸleÅŸme aÃ§Ä±ldÄ±</p>
                        </div>

                        <!-- No credits message -->
                        <div id="no-credits-msg" style="display:none" class="w-full text-center p-3 glass rounded-lg mt-2">
                            <p class="opacity-50 text-xs">ğŸ”’ BugÃ¼nkÃ¼ reveal hakkÄ±n doldu</p>
                            <p class="opacity-30 text-[10px] mt-1">YarÄ±n 5 yeni hak gelecek</p>
                        </div>

                        <!-- Premium paywall -->
                        <div id="premium-paywall" style="display:none" class="w-full text-center mt-2">
                            <button onclick="window.location.href='premium_crystal_store.html'"
                                class="w-full py-4 btn-oracle rounded-none shadow-xl flex items-center justify-center gap-3 uppercase tracking-[0.2em] text-xs font-bold active:scale-95 transition-transform">
                                <span class="material-symbols-outlined text-base">workspace_premium</span>
                                Premium ile Profilleri AÃ§
                            </button>
                            <p class="opacity-30 text-[10px] mt-2 italic">Premium ile gÃ¼nde 5 profil aÃ§abilirsin</p>
                        </div>
                    </div>

                    <!-- No match state -->
                    <div id="match-empty" style="display:none" class="flex flex-col items-center gap-3 py-8">
                        <span class="material-symbols-outlined opacity-20 text-5xl">search_off</span>
                        <p class="opacity-40 text-sm text-center italic">HenÃ¼z eÅŸleÅŸecek profil yok.<br/>Daha fazla kullanÄ±cÄ± katÄ±ldÄ±kÃ§a eÅŸleÅŸmeler baÅŸlayacak!</p>
                    </div>

                </div>
            </div>

            <p class="mt-3 italic opacity-40 text-[10px] text-center tracking-widest uppercase">Kozmik titreÅŸimlere dokunarak yeni yollar keÅŸfet</p>
        </div>

        <!-- â•â•â• KOZMÄ°K ANALÄ°Z â€” TitreÅŸim Uyumu & Kaderin BaÄŸÄ± â•â•â• -->
        <div id="insight-section" style="display:none" class="fade-up" style="animation-delay:0.2s">
            <div class="gold-divider"></div>
            <div class="space-y-6 mb-2">
                <!-- TitreÅŸim Uyumu -->
                <div class="relative pl-6 border-l-2" style="border-color:var(--gold-deep)">
                    <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full border-2" style="background:var(--emerald-jewel);border-color:var(--temple-grey)"></div>
                    <h4 class="decorative-header text-sm font-black uppercase tracking-widest mb-2" style="color:var(--emerald-jewel)">TitreÅŸim Uyumu</h4>
                    <p id="insight-vibration" class="text-sm italic leading-relaxed opacity-90">â€”</p>
                </div>
                <!-- Kaderin BaÄŸÄ± -->
                <div class="relative pl-6 border-l-2" style="border-color:var(--gold-deep)">
                    <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full border-2" style="background:var(--sapphire-jewel);border-color:var(--temple-grey)"></div>
                    <h4 class="decorative-header text-sm font-black uppercase tracking-widest mb-2" style="color:var(--sapphire-jewel)">Kaderin BaÄŸÄ±</h4>
                    <p id="insight-destiny" class="text-sm italic leading-relaxed opacity-90">â€”</p>
                </div>
            </div>
        </div>

        <!-- Gold Divider -->
        <div class="gold-divider"></div>

        <!-- â•â•â• GEÃ‡MÄ°Å EÅLEÅMELER â•â•â• -->
        <div class="fade-up" style="animation-delay:0.25s">
            <div class="flex items-center gap-2 mb-4 px-2">
                <span class="material-symbols-outlined text-base" style="color:var(--gold-bright)">history</span>
                <p class="opacity-50 text-[10px] font-bold uppercase tracking-widest decorative-header">GeÃ§miÅŸ EÅŸleÅŸmeler</p>
            </div>
            <div id="history-list" class="space-y-2.5"></div>
            <div id="history-empty" style="display:none" class="text-center py-6 opacity-30 text-xs italic">
                EÅŸleÅŸme geÃ§miÅŸin burada gÃ¶rÃ¼necek
            </div>
        </div>

        <div class="h-6"></div>
    </div>

    <!-- Add Connection Popup -->
    <div id="conn-popup-overlay" style="display:none" class="fixed inset-0 bg-black/50 z-[100]"></div>
    <div id="conn-popup" style="display:none;background:#3d3935;border:1px solid #996515" class="fixed z-[101] rounded-lg p-4 shadow-xl max-w-[260px]">
        <p id="conn-popup-name" class="text-sm font-bold mb-3 truncate"></p>
        <button id="conn-popup-btn" class="w-full py-2.5 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all active:scale-95 cosmic-gradient text-white">
            <span class="material-symbols-outlined text-base">person_add</span>
            <span id="conn-popup-btn-label">Add Connection</span>
        </button>
        <p id="conn-popup-status" style="display:none" class="opacity-50 text-xs text-center mt-2"></p>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {

    function getPhoto(name, gender, avatarUrl) { return window.avatarUtil.getAvatarUrl({ avatarUrl: avatarUrl, name: name, gender: gender }); }
    function initial(name) { return (name||'?').charAt(0).toUpperCase(); }

    // â”€â”€â”€ SESSION & USER DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (window.auth && window.auth.whenReady) {
        await window.auth.whenReady();
    }

    var session = null;
    var userId = null;
    try {
        session = await window.auth.getSession();
        if (session && session.user) userId = session.user.id;
    } catch(e) {}

    if (!userId) { window.location.href = 'mystic_sign_up_screen.html'; return; }

    var ud = null;
    try { ud = JSON.parse(localStorage.getItem('numerael_user_data')||'null'); } catch(e){}
    if (!ud || !ud.name) { window.location.href = 'data-ready_birth_form.html'; return; }

    // User numerology profile
    var userProfile = {
        user_id: userId,
        full_name: ud.name,
        gender: ud.gender || 'unknown',
        life_path: window.discovery.calcLP(ud.birthDate),
        expression_num: window.discovery.calcExp(ud.name),
        soul_urge: window.discovery.calcSoul(ud.name),
        personality_num: window.discovery.calcPers(ud.name)
    };

    document.getElementById('radar-user-initial').textContent = initial(ud.name);

    // â”€â”€â”€ RIBBON STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var ribbonMatches = [];
    var activeRibbonIdx = 0;
    var storedRemaining = 0;
    var storedIsPrem = false;

    // Gamification entegrasyonu
    if (window.gamification) {
        var gRank = window.gamification.getRank();
        var gVis = window.gamification.getVisibility();
        var rlabel = document.getElementById('radar-rank-label');
        if (rlabel) {
            rlabel.textContent = gRank.name;
            rlabel.style.color = gRank.color;
        }
        var center = document.getElementById('radar-center');
        if (center && gRank.radarSize > 14) {
            var sz = Math.min(20, gRank.radarSize);
            center.style.width = (sz * 4) + 'px';
            center.style.height = (sz * 4) + 'px';
            center.style.boxShadow = '0 0 ' + (sz * 2) + 'px ' + gRank.color + '40';
        }
        window.gamification.addXP('cosmic_match_view', 0);
        window.gamification.trackAction('cosmic_match_view');
    }

    // â”€â”€â”€ OPT-IN KONTROLÃœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var optedIn = localStorage.getItem('numerael_discovery_opted_in') === 'true';

    if (!optedIn) {
        document.getElementById('optin-screen').style.display = 'flex';
        document.getElementById('main-content').style.display = 'none';

        document.getElementById('btn-optin').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> KatÄ±lÄ±nÄ±yor...';
            var success = await window.discovery.optIn(userId);
            if (success) {
                optedIn = true;
                document.getElementById('optin-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initMain();
            } else {
                this.disabled = false;
                this.innerHTML = '<span class="material-symbols-outlined">rocket_launch</span> KeÅŸfe KatÄ±l';
                alert('BaÄŸlantÄ± hatasÄ±. LÃ¼tfen tekrar dene.');
            }
        });
    } else {
        document.getElementById('optin-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        initMain();
    }

    // â”€â”€â”€ ANA Ä°Ã‡ERÄ°K YÃœKLEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function initMain() {
      try {
        await window.discovery.refreshOwnProfile(userId);

        var isPrem = false;
        if (window.premium) {
            isPrem = await window.premium.checkStatus();
        }
        var streak = null;
        if (!isPrem) {
            streak = await window.discovery.updateStreak(userId);
            renderStreak(streak);
        } else {
            document.querySelector('.px-5.pt-5.pb-2').style.display = 'none';
            document.getElementById('streak-badge').style.display = 'none';
        }

        storedIsPrem = isPrem;

        var match = await window.discovery.findDailyMatch(userId, userProfile);
        await renderDailyMatch(match, streak);

        var topMatches = await window.discovery.getTopMatches(userId, userProfile, 8);
        renderRadar(topMatches);

        // Ribbon'u doldur (gÃ¼nlÃ¼k eÅŸleÅŸme + radar eÅŸleÅŸmeleri)
        populateRibbon(match, topMatches);

        var history = await window.discovery.getMatchHistory(userId, 10);
        renderHistory(history, topMatches, isPrem);
      } catch(e) {
        console.error('[CosmicMatch] initMain hatasÄ±:', e);
      }
    }

    // â”€â”€â”€ STREAK RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderStreak(s) {
        if (!s) return;
        document.getElementById('streak-count').textContent = s.current_streak;
        document.getElementById('streak-label').textContent = s.current_streak + ' GÃ¼n Streak';

        if (s.current_streak >= 7) {
            document.getElementById('streak-next').textContent = 'ğŸ”¥ Harika gidiyorsun!';
        } else if (s.current_streak >= 3) {
            document.getElementById('streak-next').textContent = 'âœ¨ Streak\'ini sÃ¼rdÃ¼r!';
        } else {
            document.getElementById('streak-next').textContent = 'Her gÃ¼n gir, streak\'ini bÃ¼yÃ¼t!';
        }
    }

    // â”€â”€â”€ GÃœNLÃœK EÅLEÅME RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function renderDailyMatch(match, streak) {
        document.getElementById('match-loading').style.display = 'none';

        if (!match || !match.matched) {
            document.getElementById('match-empty').style.display = 'flex';
            return;
        }

        var m = match.matched;
        var score = match.match_score || 0;
        var revealed = match.revealed;
        var isPrem = window.premium && window.premium.isPremium();

        var todayReveals = await window.discovery.getDailyRevealCount(userId);
        var remaining = isPrem ? (window.discovery.PREMIUM_DAILY_REVEALS - todayReveals) : 0;
        storedRemaining = remaining;

        document.getElementById('credits-count').textContent = isPrem ? Math.max(0, remaining) : 'ğŸ”’';
        document.getElementById('credits-label').textContent = isPrem ? 'BugÃ¼n' : 'Premium';

        document.getElementById('match-content').style.display = 'block';

        document.getElementById('match-lp').textContent = m.life_path || '?';

        document.getElementById('match-score').textContent = score + '%';
        setTimeout(function() {
            document.getElementById('match-bar').style.width = score + '%';
        }, 300);

        document.getElementById('match-bond').textContent = window.discovery.bondLabel(score);

        var arch = window.discovery.ARCHETYPES[m.life_path] || 'Ruh';
        document.getElementById('match-archetype').textContent = 'Life Path ' + (m.life_path||'?') + ' Â· ' + arch;

        // Kozmik analiz gÃ¼ncelle
        generateInsights(m, score);

        if (revealed) {
            showRevealed(m);
        } else {
            document.getElementById('match-name').textContent = maskName(m.full_name);
            document.getElementById('match-avatar').innerHTML = '<span class="text-cosmic-violet text-4xl font-black">' + initial(m.full_name) + '</span>';
            document.getElementById('match-card').classList.add('match-card-blur');
            document.getElementById('match-card').classList.remove('match-card-revealed');

            if (!isPrem) {
                document.getElementById('btn-reveal').style.display = 'none';
                document.getElementById('no-credits-msg').style.display = 'none';
                document.getElementById('premium-paywall').style.display = 'block';
            } else if (remaining > 0) {
                document.getElementById('btn-reveal').style.display = 'flex';
                document.getElementById('no-credits-msg').style.display = 'none';
                document.getElementById('premium-paywall').style.display = 'none';
                document.getElementById('reveal-label').textContent = 'Profili AÃ§ (' + remaining + ' hak kaldÄ±)';
            } else {
                document.getElementById('btn-reveal').style.display = 'none';
                document.getElementById('no-credits-msg').style.display = 'block';
                document.getElementById('premium-paywall').style.display = 'none';
            }
        }

        document.getElementById('btn-reveal').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span>';

            var result = await window.discovery.revealMatch(userId, match.match_date, isPrem);
            if (result.success) {
                showRevealed(m);
                storedRemaining = Math.max(0, result.remaining);
                document.getElementById('credits-count').textContent = storedRemaining;
                // Ribbon'daki gÃ¼nlÃ¼k eÅŸleÅŸmeyi de aÃ§Ä±lmÄ±ÅŸ olarak gÃ¼ncelle
                if (ribbonMatches.length > 0 && ribbonMatches[0].isDailyMatch) {
                    ribbonMatches[0].revealed = true;
                    // Ribbon avatarÄ±nÄ± gÃ¼ncelle
                    var firstFrag = document.querySelector('#match-ribbon .scroll-fragment');
                    if (firstFrag) {
                        var avatarDiv = firstFrag.querySelector('div');
                        if (avatarDiv) avatarDiv.innerHTML = '<img src="' + getPhoto(m.full_name, m.gender, m.avatar_url) + '" style="width:100%;height:100%;object-fit:cover">';
                    }
                }
            } else if (result.reason === 'daily_limit') {
                this.disabled = false;
                this.innerHTML = '<span class="material-symbols-outlined">visibility</span> <span>Profili AÃ§</span>';
                document.getElementById('btn-reveal').style.display = 'none';
                document.getElementById('no-credits-msg').style.display = 'block';
                document.getElementById('credits-count').textContent = '0';
            } else if (result.reason === 'not_premium') {
                this.disabled = false;
                this.innerHTML = '<span class="material-symbols-outlined">visibility</span> <span>Profili AÃ§</span>';
                document.getElementById('btn-reveal').style.display = 'none';
                document.getElementById('premium-paywall').style.display = 'block';
            } else {
                this.disabled = false;
                this.innerHTML = '<span class="material-symbols-outlined">visibility</span> <span>Profili AÃ§</span>';
            }
        });
    }

    function showRevealed(m) {
        document.getElementById('match-card').classList.remove('match-card-blur');
        document.getElementById('match-card').classList.add('match-card-revealed');
        document.getElementById('match-name').textContent = m.full_name || '???';
        document.getElementById('match-avatar').innerHTML = '<img src="' + getPhoto(m.full_name, m.gender, m.avatar_url) + '" class="w-full h-full object-cover" alt="">';
        document.getElementById('btn-reveal').style.display = 'none';
        document.getElementById('no-credits-msg').style.display = 'none';
        document.getElementById('revealed-info').style.display = 'block';
    }

    function maskName(name) {
        if (!name) return '???';
        var parts = name.split(' ');
        return parts.map(function(p) {
            return p.charAt(0) + 'â€¢'.repeat(Math.max(p.length - 1, 2));
        }).join(' ');
    }

    // â”€â”€â”€ RIBBON: BugÃ¼nÃ¼n eÅŸleÅŸmelerini Ã¼st Ã§erÃ§evelere koy â”€â”€
    function populateRibbon(dailyMatch, topMatches) {
        var ribbonEl = document.getElementById('match-ribbon');
        ribbonEl.innerHTML = '';
        ribbonMatches = [];
        activeRibbonIdx = 0;

        // GÃ¼nlÃ¼k eÅŸleÅŸmeyi ilk sÄ±raya koy
        if (dailyMatch && dailyMatch.matched) {
            ribbonMatches.push({
                profile: dailyMatch.matched,
                score: dailyMatch.match_score || 0,
                isDailyMatch: true,
                revealed: dailyMatch.revealed,
                matchDate: dailyMatch.match_date
            });
        }

        // Radar eÅŸleÅŸmelerini ekle (gÃ¼nlÃ¼k eÅŸleÅŸme hariÃ§)
        var dailyUid = dailyMatch && dailyMatch.matched ? dailyMatch.matched.user_id : null;
        (topMatches || []).forEach(function(item) {
            if (item.profile && item.profile.user_id !== dailyUid) {
                ribbonMatches.push({
                    profile: item.profile,
                    score: item.score,
                    isDailyMatch: false,
                    revealed: false
                });
            }
        });

        if (!ribbonMatches.length) return;

        // Ribbon item'larÄ±nÄ± oluÅŸtur
        ribbonMatches.forEach(function(item, idx) {
            var frag = document.createElement('div');
            frag.className = 'scroll-fragment';
            if (idx === 0) frag.classList.add('ribbon-active');

            var p = item.profile;
            var showFace = storedIsPrem || item.revealed;

            frag.innerHTML =
                '<div style="width:30px;height:30px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;border:1px solid var(--gold-deep);background:rgba(0,0,0,0.2)">' +
                    (showFace
                        ? '<img src="' + getPhoto(p.full_name, p.gender, p.avatar_url) + '" style="width:100%;height:100%;object-fit:cover">'
                        : '<span style="color:var(--gold-rich);font-size:12px;font-weight:800">' + initial(p.full_name) + '</span>') +
                '</div>' +
                '<span style="color:var(--gold-bright);font-size:8px;font-weight:800;margin-top:3px">' + (p.life_path || '?') + '</span>';

            frag.addEventListener('click', function() {
                selectRibbonItem(idx);
            });

            ribbonEl.appendChild(frag);
        });
    }

    function selectRibbonItem(idx) {
        if (idx === activeRibbonIdx || idx >= ribbonMatches.length) return;
        activeRibbonIdx = idx;

        // Aktif ribbon'u gÃ¼ncelle
        var frags = document.querySelectorAll('#match-ribbon .scroll-fragment');
        frags.forEach(function(f, i) {
            if (i === idx) f.classList.add('ribbon-active');
            else f.classList.remove('ribbon-active');
        });

        // Soul card'Ä± gÃ¼ncelle
        var item = ribbonMatches[idx];
        updateCardDisplay(item);
    }

    function updateCardDisplay(item) {
        var m = item.profile;
        var score = item.score;

        // Loading/empty gizle, content gÃ¶ster
        document.getElementById('match-loading').style.display = 'none';
        document.getElementById('match-empty').style.display = 'none';
        document.getElementById('match-content').style.display = 'block';

        // LP badge
        document.getElementById('match-lp').textContent = m.life_path || '?';

        // Skor animasyonu
        document.getElementById('match-score').textContent = score + '%';
        document.getElementById('match-bar').style.width = '0%';
        setTimeout(function() {
            document.getElementById('match-bar').style.width = score + '%';
        }, 50);

        // Bond label
        document.getElementById('match-bond').textContent = window.discovery.bondLabel(score);

        // Archetype
        var arch = window.discovery.ARCHETYPES[m.life_path] || 'Ruh';
        document.getElementById('match-archetype').textContent = 'Life Path ' + (m.life_path||'?') + ' Â· ' + arch;

        // Kozmik analiz gÃ¼ncelle
        generateInsights(m, score);

        // Reveal / blur durumu
        var isRevealed = item.revealed || (storedIsPrem && !item.isDailyMatch);

        if (isRevealed) {
            // AÃ§Ä±k profil
            document.getElementById('match-card').classList.remove('match-card-blur');
            document.getElementById('match-card').classList.add('match-card-revealed');
            document.getElementById('match-name').textContent = m.full_name || '???';
            document.getElementById('match-avatar').innerHTML = '<img src="' + getPhoto(m.full_name, m.gender, m.avatar_url) + '" class="w-full h-full object-cover" alt="">';
            document.getElementById('btn-reveal').style.display = 'none';
            document.getElementById('no-credits-msg').style.display = 'none';
            document.getElementById('premium-paywall').style.display = 'none';
            document.getElementById('revealed-info').style.display = (item.isDailyMatch && item.revealed) ? 'block' : 'none';
        } else {
            // BulanÄ±k profil
            document.getElementById('match-card').classList.add('match-card-blur');
            document.getElementById('match-card').classList.remove('match-card-revealed');
            document.getElementById('match-name').textContent = maskName(m.full_name);
            document.getElementById('match-avatar').innerHTML = '<span class="text-cosmic-violet text-4xl font-black">' + initial(m.full_name) + '</span>';
            document.getElementById('revealed-info').style.display = 'none';

            if (!storedIsPrem) {
                // Free kullanÄ±cÄ± â€” paywall
                document.getElementById('btn-reveal').style.display = 'none';
                document.getElementById('no-credits-msg').style.display = 'none';
                document.getElementById('premium-paywall').style.display = 'block';
            } else if (item.isDailyMatch && storedRemaining > 0) {
                // Premium + gÃ¼nlÃ¼k eÅŸleÅŸme + hakkÄ± var
                document.getElementById('btn-reveal').style.display = 'flex';
                document.getElementById('no-credits-msg').style.display = 'none';
                document.getElementById('premium-paywall').style.display = 'none';
                document.getElementById('reveal-label').textContent = 'Profili AÃ§ (' + storedRemaining + ' hak kaldÄ±)';
            } else if (item.isDailyMatch) {
                // Premium + gÃ¼nlÃ¼k eÅŸleÅŸme + hakkÄ± doldu
                document.getElementById('btn-reveal').style.display = 'none';
                document.getElementById('no-credits-msg').style.display = 'block';
                document.getElementById('premium-paywall').style.display = 'none';
            } else {
                // Radar eÅŸleÅŸmesi (premium ama gÃ¼nlÃ¼k deÄŸil)
                document.getElementById('btn-reveal').style.display = 'none';
                document.getElementById('no-credits-msg').style.display = 'none';
                document.getElementById('premium-paywall').style.display = 'none';
            }
        }
    }

    // â”€â”€â”€ KOZMÄ°K ANALÄ°Z RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // SayÄ± bazlÄ± enerji tanÄ±mlarÄ± â€” her sayÄ±nÄ±n Ã¶zgÃ¼n niteliÄŸi
    var NUM_ENERGY = {
        1: {name:'Ã–ncÃ¼',element:'ateÅŸ',quality:'baÄŸÄ±msÄ±z irade ve liderlik enerjisi',verb:'yÃ¶n verir',shadow:'inatÃ§Ä±lÄ±k'},
        2: {name:'Ayna',element:'su',quality:'sezgisel denge ve diplomasi enerjisi',verb:'birleÅŸtirir',shadow:'kararsÄ±zlÄ±k'},
        3: {name:'YaratÄ±cÄ±',element:'Ä±ÅŸÄ±k',quality:'ifade gÃ¼cÃ¼ ve ilham enerjisi',verb:'dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r',shadow:'daÄŸÄ±nÄ±klÄ±k'},
        4: {name:'Ã‡Ä±pa',element:'toprak',quality:'yapÄ± ve gÃ¼venilirlik enerjisi',verb:'inÅŸa eder',shadow:'katÄ±lÄ±k'},
        5: {name:'RÃ¼zgÃ¢r',element:'hava',quality:'Ã¶zgÃ¼rlÃ¼k ve deÄŸiÅŸim enerjisi',verb:'geniÅŸletir',shadow:'huzursuzluk'},
        6: {name:'ÅifacÄ±',element:'su',quality:'sevgi ve sorumluluk enerjisi',verb:'iyileÅŸtirir',shadow:'aÅŸÄ±rÄ± fedakÃ¢rlÄ±k'},
        7: {name:'Mistik',element:'eter',quality:'derin bilgelik ve iÃ§ gÃ¶rÃ¼ enerjisi',verb:'aydÄ±nlatÄ±r',shadow:'yalnÄ±zlÄ±k'},
        8: {name:'Kral',element:'ateÅŸ',quality:'gÃ¼Ã§ ve bolluk enerjisi',verb:'yÃ¶netir',shadow:'kontrol tutkusu'},
        9: {name:'Bilge',element:'Ä±ÅŸÄ±k',quality:'evrensel sevgi ve tamamlanma enerjisi',verb:'aÅŸar',shadow:'idealleÅŸtirme'},
        11: {name:'Ä°lhamcÄ±',element:'eter',quality:'yÃ¼ksek sezgi ve ruhsal aydÄ±nlanma enerjisi',verb:'ilham verir',shadow:'aÅŸÄ±rÄ± duyarlÄ±lÄ±k'},
        22: {name:'Usta Mimar',element:'toprak',quality:'vizyoner inÅŸa ve manifestasyon enerjisi',verb:'ÅŸekillendirir',shadow:'mÃ¼kemmeliyetÃ§ilik'},
        33: {name:'Kozmik Ã–ÄŸretmen',element:'Ä±ÅŸÄ±k',quality:'koÅŸulsuz sevgi ve yÃ¼kseltme enerjisi',verb:'yÃ¼celtir',shadow:'kendini feda etme'}
    };

    // Ruh GÃ¼dÃ¼sÃ¼ Ã§ift dinamikleri â€” ikili etkileÅŸim kalÄ±plarÄ±
    var SOUL_DYNAMICS = {
        same:    'RuhlarÄ±nÄ±z aynÄ± frekansta titre\u015Fiyor â€” birbirinizi aynada gÃ¶rmek gibi. Bu yansÄ±ma hem derin bir tanÄ±nmÄ±ÅŸlÄ±k hem de gÃ¶lge alanlarÄ±nÄ±zla yÃ¼zleÅŸme getirir.',
        fire:    'Ä°ki ateÅŸli ruh yan yana geldiÄŸinde enerjiniz katlanarak yÃ¼kselir. Birbirinizin tutkusunu besliyor, motivasyonunu ateÅŸliyorsunuz.',
        water:   'Su elementinin buluÅŸmasÄ± sezgisel bir akÄ±ÅŸ yaratÄ±yor. Kelimeler olmadan anlayÄ±ÅŸÄ±n mÃ¼mkÃ¼n olduÄŸu nadir bir ruhsal baÄŸÄ±nÄ±z var.',
        earth:   'Toprak enerjileri bir araya gelince sarsÄ±lmaz bir gÃ¼ven zemini oluÅŸuyor. Bu baÄŸ, hayatÄ±n fÄ±rtÄ±nalarÄ±nda sÄ±ÄŸÄ±nacaÄŸÄ±nÄ±z liman.',
        light:   'IÅŸÄ±k enerjilerinin birleÅŸimi yaratÄ±cÄ±lÄ±ÄŸÄ±nÄ±zÄ± sÄ±nÄ±rsÄ±z kÄ±lÄ±yor. Birlikte hayal ettiÄŸiniz her ÅŸey parlamaya baÅŸlÄ±yor.',
        complement: 'Ruh gÃ¼dÃ¼leriniz birbirini tamamlayan elemanlarda â€” birinin eksik bÄ±raktÄ±ÄŸÄ±nÄ± diÄŸeri dolduruyor. Bu kozmik denge tesadÃ¼f deÄŸil.',
        contrast: 'Ruhsal gÃ¼dÃ¼leriniz farklÄ± elementlerden besleniyor. Bu gerilim, birbirinizi alÄ±ÅŸkanlÄ±klarÄ±nÄ±zdan koparÄ±p bÃ¼yÃ¼meye itiyor.'
    };

    // Element etkileÅŸim haritasÄ±
    var ELEMENT_MATCH = {
        'ateÅŸ-ateÅŸ':'fire','su-su':'water','toprak-toprak':'earth','Ä±ÅŸÄ±k-Ä±ÅŸÄ±k':'light','eter-eter':'water',
        'ateÅŸ-Ä±ÅŸÄ±k':'complement','su-toprak':'complement','eter-Ä±ÅŸÄ±k':'complement','ateÅŸ-hava':'complement',
        'su-eter':'complement','toprak-Ä±ÅŸÄ±k':'complement','hava-eter':'complement','hava-Ä±ÅŸÄ±k':'complement'
    };

    function getElementDynamic(el1, el2) {
        if (el1 === el2) return ELEMENT_MATCH[el1 + '-' + el2] || 'same';
        var key1 = el1 + '-' + el2;
        var key2 = el2 + '-' + el1;
        return ELEMENT_MATCH[key1] || ELEMENT_MATCH[key2] || 'contrast';
    }

    // Kader yolu Ã§ift yorumlarÄ± â€” LP kombinasyonuna Ã¶zel
    var LP_PAIR_INSIGHTS = {
        'same': 'AynÄ± Kader Yolu Ã¼zerinde yÃ¼rÃ¼yen iki ruh â€” ortak derslerin, ortak zaferlerin ve aynÄ± kozmik sÄ±navlarÄ±n iÃ§indesiniz. Bu ayna etkisi, en derin Ã¶z farkÄ±ndalÄ±ÄŸÄ± getirir.',
        'next': 'ArdÄ±ÅŸÄ±k Kader YollarÄ±, evrimsel bir zincirin halkalarÄ±sÄ±nÄ±z. Biriniz diÄŸerinin bir sonraki dersinin habercisi â€” birlikte hÄ±zlanmÄ±ÅŸ bir ruhsal bÃ¼yÃ¼me dÃ¶ngÃ¼sÃ¼ yaÅŸÄ±yorsunuz.',
        'mirror': 'Kader YollarÄ±nÄ±z 10\'a tamamlanÄ±yor â€” kozmik ayna Ã§iftisiniz. Birinin fazlasÄ± diÄŸerinin eksiÄŸini tamamlÄ±yor, evren sizi bilinÃ§li bir denge iÃ§in buluÅŸturdu.',
        'master_meets': 'Bir Ãœstat SayÄ± ile buluÅŸuyorsunuz â€” bu karÅŸÄ±laÅŸma sÄ±radan bir uyum deÄŸil. Ãœstat enerjisi, diÄŸer ruhun potansiyelini yÃ¼kseltmek iÃ§in katalizÃ¶r gÃ¶revi gÃ¶rÃ¼yor.'
    };

    function getLPPairType(lp1, lp2) {
        if (lp1 === lp2) return 'same';
        if (lp1 >= 11 || lp2 >= 11) return 'master_meets';
        if (Math.abs(lp1 - lp2) === 1) return 'next';
        if (lp1 + lp2 === 10) return 'mirror';
        return null; // Ã¶zel kalÄ±p yok, generic Ã¼ret
    }

    function generateInsights(matchProfile, score) {
        var section = document.getElementById('insight-section');
        var vibEl = document.getElementById('insight-vibration');
        var destEl = document.getElementById('insight-destiny');

        if (!matchProfile) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        // â”€â”€â”€ KullanÄ±cÄ± & eÅŸleÅŸme sayÄ±larÄ± â”€â”€â”€
        var uLP = userProfile.life_path;
        var mLP = matchProfile.life_path;
        var uSoul = userProfile.soul_urge;
        var mSoul = matchProfile.soul_urge;
        var uPers = userProfile.personality_num;
        var mPers = matchProfile.personality_num;
        var uExp = userProfile.expression_num;
        var mExp = matchProfile.expression_num;

        var uE = NUM_ENERGY[uSoul] || NUM_ENERGY[5];
        var mE = NUM_ENERGY[mSoul] || NUM_ENERGY[5];

        // â”€â”€â”€ TÄ°TREÅÄ°M UYUMU â€” Ruh GÃ¼dÃ¼sÃ¼ + KiÅŸilik bazlÄ± â”€â”€â”€
        var soulScore = window.discovery.getScore(uSoul, mSoul);
        var persScore = window.discovery.getScore(uPers, mPers);

        var dynamic = (uSoul === mSoul) ? 'same' : getElementDynamic(uE.element, mE.element);
        var baseSoulText = SOUL_DYNAMICS[dynamic];

        // KiÅŸilik katmanÄ± â€” derinleÅŸtirme
        var persLayer = '';
        if (persScore >= 90) {
            persLayer = ' DÄ±ÅŸa yansÄ±ttÄ±ÄŸÄ±nÄ±z enerjiler de bÃ¼yÃ¼k bir uyum taÅŸÄ±yor â€” Ã§evreniz sizi doÄŸal bir Ã§ift olarak algÄ±lÄ±yor.';
        } else if (persScore >= 80) {
            persLayer = ' Sosyal kimlikleriniz birbirini destekliyor â€” birlikte olduÄŸunuzda ikiniz de en iyi versiyonunuzu gÃ¶steriyorsunuz.';
        } else if (persScore >= 70) {
            persLayer = ' KiÅŸilik enerjileriniz farklÄ± aÃ§Ä±lardan parlÄ±yor â€” bu farklÄ±lÄ±k birbirinizin kÃ¶r noktalarÄ±nÄ± aydÄ±nlatÄ±yor.';
        } else {
            persLayer = ' DÄ±ÅŸ dÃ¼nyaya yansÄ±yan yÃ¼zleriniz birbirinden ayrÄ±ÅŸÄ±yor â€” bu gerilim, ikinizi de konfor alanÄ±nÄ±n dÄ±ÅŸÄ±na Ã§Ä±kararak olgunlaÅŸtÄ±rÄ±yor.';
        }

        // SayÄ±sal derinlik: gerÃ§ek sayÄ± isimlerini kullan
        var soulDetail = uE.name + ' (' + uSoul + ') ruhunuzun ' + uE.quality + ' taÅŸÄ±rken, karÅŸÄ±nÄ±zdaki ' + mE.name + ' (' + mSoul + ') ruhu ' + mE.quality + ' yayÄ±yor.';

        vibEl.textContent = soulDetail + ' ' + baseSoulText + persLayer;

        // â”€â”€â”€ KADERÄ°N BAÄI â€” Life Path + Expression bazlÄ± â”€â”€â”€
        var lpScore = window.discovery.getScore(uLP, mLP);
        var expScore = window.discovery.getScore(uExp, mExp);

        var uLPE = NUM_ENERGY[uLP] || NUM_ENERGY[5];
        var mLPE = NUM_ENERGY[mLP] || NUM_ENERGY[5];

        // Ã–zel LP Ã§ifti kalÄ±bÄ± kontrolÃ¼
        var pairType = getLPPairType(uLP, mLP);
        var lpText = '';
        if (pairType) {
            lpText = LP_PAIR_INSIGHTS[pairType];
        } else {
            // Generic ama sayÄ±-spesifik yorum
            if (lpScore >= 85) {
                lpText = uLPE.name + ' (' + uLP + ') ile ' + mLPE.name + ' (' + mLP + ') kader yollarÄ± gÃ¼Ã§lÃ¼ bir rezonansla birleÅŸiyor. ' + uLP + '\'in ' + uLPE.verb + ' enerjisi, ' + mLP + '\'in ' + mLPE.verb + ' gÃ¼cÃ¼yle birleÅŸtiÄŸinde olaÄŸanÃ¼stÃ¼ bir sinerji doÄŸuyor.';
            } else if (lpScore >= 75) {
                lpText = uLPE.name + ' (' + uLP + ') kader Ã§izginiz, ' + mLPE.name + ' (' + mLP + ') yoluyla kesiÅŸiyor. ' + uLP + '\'in ' + uLPE.quality + ', ' + mLP + '\'in ' + mLPE.quality + ' ile dengelenerek iki ruhun da evrimini hÄ±zlandÄ±rÄ±yor.';
            } else {
                lpText = uLPE.name + ' (' + uLP + ') ile ' + mLPE.name + ' (' + mLP + ') farklÄ± kozmik dersler Ã¼zerinde Ã§alÄ±ÅŸÄ±yor. Bu farklÄ±lÄ±k karÅŸÄ±tlÄ±k deÄŸil, tamamlanmamÄ±ÅŸ bulmacalarÄ±n birbirinde saklÄ± parÃ§alarÄ±nÄ± bulma fÄ±rsatÄ±.';
            }
        }

        // Expression katmanÄ± â€” iletiÅŸim & yaÅŸam misyonu derinliÄŸi
        var expLayer = '';
        var uExpE = NUM_ENERGY[uExp] || NUM_ENERGY[5];
        var mExpE = NUM_ENERGY[mExp] || NUM_ENERGY[5];
        if (expScore >= 85) {
            expLayer = ' Ä°fade sayÄ±larÄ±nÄ±z (' + uExp + ' Â· ' + mExp + ') ortak bir yaÅŸam misyonuna iÅŸaret ediyor â€” birlikte yarattÄ±ÄŸÄ±nÄ±z ÅŸeyler, tek baÅŸÄ±nÄ±za mÃ¼mkÃ¼n olandan Ã§ok daha bÃ¼yÃ¼k.';
        } else if (expScore >= 70) {
            expLayer = ' Ä°fade enerjileriniz (' + uExp + ' ' + uExpE.name + ' Â· ' + mExp + ' ' + mExpE.name + ') farklÄ± yetenekleri bir araya getiriyor â€” ' + uExpE.verb + ' ile ' + mExpE.verb + ' gÃ¼cÃ¼ birleÅŸtiÄŸinde yaratÄ±cÄ± potansiyeliniz aÃ§Ä±ÄŸa Ã§Ä±kÄ±yor.';
        } else {
            expLayer = ' Ä°fade yollarÄ±nÄ±z (' + uExp + ' Â· ' + mExp + ') farklÄ± misyonlara hizmet ediyor â€” bu birbirinin dÃ¼nyasÄ±na aÃ§Ä±lan bir pencere, bakÄ±ÅŸ aÃ§Ä±nÄ±zÄ± geniÅŸleten nadir bir baÄŸ.';
        }

        destEl.textContent = lpText + expLayer;
    }

    // â”€â”€â”€ RADAR RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRadar(matches) {
        var dotsEl = document.getElementById('radar-dots');
        dotsEl.innerHTML = '';

        if (!matches.length) {
            document.getElementById('radar-empty').style.display = 'block';
            document.getElementById('radar-info').style.display = 'none';
            return;
        }

        document.getElementById('radar-empty').style.display = 'none';
        document.getElementById('radar-info').style.display = 'block';
        document.getElementById('radar-count').textContent = matches.length;

        var colors = ['#c084fc','#f472b6','#818cf8','#34d399','#fbbf24','#f87171','#22d3ee','#a78bfa'];

        matches.forEach(function(item, idx) {
            var p = item.profile;
            var score = item.score;
            var distance = 120 - (score - 65) * 2;
            distance = Math.max(45, Math.min(115, distance));
            var angle = (idx / matches.length) * 2 * Math.PI - Math.PI/2;
            var x = 130 + distance * Math.cos(angle) - 18;
            var y = 130 + distance * Math.sin(angle) - 18;
            var color = colors[idx % colors.length];

            var dot = document.createElement('div');
            dot.className = 'radar-dot';
            dot.style.cssText = 'left:' + x + 'px;top:' + y + 'px;background:' + color + '22;border-color:' + color + '66;animation:float ' + (2.5 + idx*0.3) + 's ease-in-out infinite;animation-delay:' + (idx*0.2) + 's';
            dot.innerHTML = '<span style="color:' + color + '">' + (p.life_path||'?') + '</span>';
            dot.title = maskName(p.full_name) + ' Â· %' + score;
            dotsEl.appendChild(dot);
        });
    }

    // â”€â”€â”€ GEÃ‡MÄ°Å EÅLEÅMELER RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHistory(matches, radarMatches, isPrem) {
        var listEl = document.getElementById('history-list');
        var emptyEl = document.getElementById('history-empty');

        var historyIds = {};
        (matches || []).forEach(function(m) {
            if (m.matched_user_id) historyIds[m.matched_user_id] = true;
        });

        var radarExtras = [];
        if (radarMatches && radarMatches.length) {
            radarMatches.forEach(function(item) {
                var p = item.profile;
                if (p && p.user_id && !historyIds[p.user_id]) {
                    radarExtras.push({
                        matched: p,
                        match_score: item.score,
                        match_date: '',
                        matched_user_id: p.user_id
                    });
                }
            });
        }

        var allMatches = (matches || []).concat(radarExtras);

        if (!allMatches.length) {
            emptyEl.style.display = 'block';
            return;
        }

        emptyEl.style.display = 'none';

        allMatches.forEach(function(match) {
            var m = match.matched || { full_name: 'Bilinmeyen', life_path: null };
            var revealed = isPrem || match.revealed;
            var displayName = revealed ? (m.full_name || 'Bilinmeyen') : maskName(m.full_name || 'Bilinmeyen');
            var score = match.match_score || 0;
            var date = match.match_date || '';
            var arch = m.life_path ? (window.discovery.ARCHETYPES[m.life_path] || '') : '';

            var card = document.createElement('div');
            card.className = 'flex items-center gap-3 p-3.5 glass-cosmic rounded-2xl';
            card.innerHTML =
                '<div class="size-11 shrink-0 rounded-full overflow-hidden border-2 border-cosmic-violet/30 flex items-center justify-center bg-surface-dark">' +
                    (revealed
                        ? '<img src="' + getPhoto(m.full_name, m.gender, m.avatar_url) + '" class="w-full h-full object-cover" alt="">'
                        : '<span class="text-cosmic-violet text-sm font-black">' + initial(m.full_name) + '</span>') +
                '</div>' +
                '<div class="flex-1 min-w-0">' +
                    '<p class="text-white text-sm font-bold truncate' + (revealed ? ' cursor-pointer conn-name-click' : '') + '"' +
                        (revealed && m.user_id ? ' data-uid="' + m.user_id + '" data-name="' + (m.full_name||'') + '"' : '') +
                    '>' + displayName + '</p>' +
                    '<p class="text-white/35 text-[10px]">LP ' + (m.life_path||'?') + (arch ? ' Â· '+arch : '') + '</p>' +
                '</div>' +
                '<div class="text-right shrink-0">' +
                    '<p class="cosmic-gradient-text text-sm font-black">%' + score + '</p>' +
                    '<p class="text-white/20 text-[10px]">' + formatDate(date) + '</p>' +
                '</div>' +
                (revealed ? '' : '<span class="material-symbols-outlined text-white/15 text-sm">lock</span>');

            listEl.appendChild(card);
        });
    }

    // â”€â”€â”€ ADD CONNECTION POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var popupOverlay = document.getElementById('conn-popup-overlay');
    var popupEl = document.getElementById('conn-popup');
    var popupName = document.getElementById('conn-popup-name');
    var popupBtn = document.getElementById('conn-popup-btn');
    var popupBtnLabel = document.getElementById('conn-popup-btn-label');
    var popupStatus = document.getElementById('conn-popup-status');
    var activePopupUid = null;

    function closePopup() {
        popupEl.style.display = 'none';
        popupOverlay.style.display = 'none';
        activePopupUid = null;
    }

    popupOverlay.addEventListener('click', closePopup);

    document.addEventListener('click', async function(e) {
        var nameEl = e.target.closest('.conn-name-click');
        if (!nameEl) return;

        e.stopPropagation();
        var targetUid = nameEl.getAttribute('data-uid');
        var targetName = nameEl.getAttribute('data-name');
        if (!targetUid || !targetName) return;

        activePopupUid = targetUid;
        popupName.textContent = targetName;
        popupStatus.style.display = 'none';
        popupBtn.disabled = false;
        popupBtnLabel.textContent = 'Add Connection';
        popupBtn.className = 'w-full py-2.5 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all active:scale-95 cosmic-gradient text-white';

        var connected = await window.connectionEngine.areConnected(userId, targetUid);
        if (connected) {
            popupBtn.style.display = 'none';
            popupStatus.textContent = 'Already connected';
            popupStatus.style.display = 'block';
        } else {
            var existingReq = await window.connectionEngine.hasActiveRequest(userId, targetUid);
            if (existingReq) {
                popupBtn.style.display = 'none';
                popupStatus.textContent = existingReq.status === 'pending' ? 'Request pending' : 'Already connected';
                popupStatus.style.display = 'block';
            } else {
                popupBtn.style.display = 'flex';
            }
        }

        var rect = nameEl.getBoundingClientRect();
        popupEl.style.left = Math.min(rect.left, window.innerWidth - 270) + 'px';
        popupEl.style.top = (rect.bottom + 8) + 'px';
        popupEl.style.display = 'block';
        popupOverlay.style.display = 'block';
    });

    popupBtn.addEventListener('click', async function() {
        if (!activePopupUid) return;
        popupBtn.disabled = true;
        popupBtnLabel.textContent = '...';

        var result = await window.connectionEngine.sendConnectionRequest(userId, activePopupUid);
        if (result.success) {
            popupBtn.style.display = 'none';
            popupStatus.textContent = 'Request sent';
            popupStatus.style.display = 'block';
            setTimeout(closePopup, 1500);
        } else {
            popupBtnLabel.textContent = result.error === 'already_connected' ? 'Already connected' : (result.error === 'request_exists' ? 'Request exists' : 'Error');
            popupBtn.disabled = true;
        }
    });

    function formatDate(d) {
        if (!d) return '';
        try { return new Date(d+'T00:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'short'}); } catch(e){ return d; }
    }

});
</script>
<script src="js/notification-engine.js"></script>
<script src="js/avatar-renderer.js"></script>
<script src="js/avatar-lipsync.js"></script>
<script src="js/avatar-widget.js"></script>
<script src="js/avatar-guide.js"></script>
<script src="js/bottom-nav.js"></script>
</body>
</html>
