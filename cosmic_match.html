<!DOCTYPE html>
<html lang="tr"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>NuMatch - Sacred Embers</title>
<script src="js/theme-engine.js"></script>
<script src="js/i18n-engine.js"></script>
<script src="js/tailwind.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="js/supabase.min.js"></script>
<script src="js/supabase-config.js"></script>
<script src="js/api-base.js"></script>
<script src="js/auth.js"></script>
<script src="js/play-billing.js"></script>
<script src="js/premium.js"></script>
<script src="js/gamification-engine.js"></script>
<script src="js/profile.js"></script>
<script src="js/discovery-engine.js"></script>
<script src="js/connection-engine.js"></script>
<script src="js/avatar.js"></script>
<script src="js/turkish-cities.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    primary: "#C47C20",
                    "background-light": "#FDF8F5",
                    "background-dark": "#180F0A",
                    "card-dark": "#241812", "card-light": "#f5f5f0",
                    "accent-gold": "#C47C20",
                    "accent-gold-dark": "#8B5716",
                    "text-muted": "#8D7B6D",
                    "cosmic-violet": "#C47C20"
                },
                fontFamily: {
                    display: ["Cinzel", "serif"],
                    body: ["Lato", "sans-serif"],
                },
                backgroundImage: {
                    'celestial': "url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&auto=format&fit=crop&w=2342&q=80')",
                }
            },
        },
    };
</script>
<style type="text/tailwindcss">
    :root {
        --primary-copper: #C47C20;
        --bg-sacred: #180F0A;
        --card-sacred: #241812;
        --bronze-text: #8D7B6D;
    }
    .no-scrollbar::-webkit-scrollbar { display: none }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none }
    html.dark .glass {
        background: rgba(36, 24, 18, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(196, 124, 32, 0.25);
    }
    html:not(.dark) .glass {
        background: rgba(255, 252, 250, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(196, 124, 32, 0.3);
    }
    html.dark .glass-light {
        background: rgba(36, 24, 18, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(196, 124, 32, 0.25);
    }
    html:not(.dark) .glass-light {
        background: rgba(255, 252, 250, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(196, 124, 32, 0.3);
    }
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
</style>
<style>
    body { min-height: max(884px, 100dvh) }
    .copper-gradient-text{background:linear-gradient(180deg,#C47C20,#8B5716);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .cosmic-gradient-text{background:linear-gradient(180deg,#C47C20,#8B5716);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .cosmic-gradient{background:linear-gradient(135deg,#C47C20 0%,#E5A354 50%,#8B5716 100%)}
    .match-card-blur .blur-layer{filter:blur(8px);-webkit-filter:blur(8px);transition:filter 0.8s ease}
    .match-card-revealed .blur-layer{filter:none;-webkit-filter:none}
    .streak-badge{background:linear-gradient(135deg,var(--primary-copper),#8B5716);box-shadow:0 0 12px rgba(196,124,32,0.4)}
    @keyframes fade-up{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse-glow{0%,100%{box-shadow:0 0 20px rgba(196,124,32,0.3)}50%{box-shadow:0 0 35px rgba(196,124,32,0.5)}}
    @keyframes streak-fire{0%,100%{text-shadow:0 0 8px rgba(196,124,32,0.5)}50%{text-shadow:0 0 16px rgba(196,124,32,0.8)}}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .fade-up{animation:fade-up 0.5s ease forwards;opacity:0}
    .pulse-glow{animation:pulse-glow 3s ease-in-out infinite}
    .streak-fire{animation:streak-fire 2s ease-in-out infinite}
    .shimmer-placeholder{background:linear-gradient(90deg,rgba(196,124,32,0.08) 25%,rgba(229,163,84,0.15) 50%,rgba(196,124,32,0.08) 75%);background-size:200% 100%;animation:shimmer 2s ease-in-out infinite}
    /* Leaflet harita dark tema */
    .dark #cosmic-map .leaflet-tile-pane{filter:brightness(0.7) invert(1) contrast(1.1) hue-rotate(200deg) saturate(0.3)}
    .dark #cosmic-map .leaflet-control-zoom a{background:rgba(36,24,18,0.9);color:#C47C20;border-color:rgba(196,124,32,0.3)}
    .dark #cosmic-map .leaflet-control-attribution{background:rgba(36,24,18,0.8)!important;color:rgba(255,255,255,0.4)!important;font-size:8px}
    .dark #cosmic-map .leaflet-control-attribution a{color:rgba(196,124,32,0.6)!important}
    #cosmic-map .leaflet-control-attribution{font-size:8px}
    #cosmic-map .cosmic-marker{position:relative;display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;transition:transform 0.2s;border:3px solid;box-shadow:0 2px 10px rgba(0,0,0,0.4);overflow:hidden}
    #cosmic-map .cosmic-marker:hover{transform:scale(1.2);z-index:100!important}
    #cosmic-map .cosmic-marker img{width:100%;height:100%;object-fit:cover;border-radius:50%}
    #cosmic-map .cosmic-marker-self{width:40px;height:40px;border-color:#C47C20;box-shadow:0 0 16px rgba(196,124,32,0.5)}
    #cosmic-map .cosmic-marker-match{width:38px;height:38px;border-color:#E5A354;box-shadow:0 2px 12px rgba(0,0,0,0.3)}
    #cosmic-map .cosmic-pin{position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-top:10px solid #E5A354;filter:drop-shadow(0 2px 2px rgba(0,0,0,0.3))}
    #cosmic-map .cosmic-pin-self{border-top-color:#C47C20}
    .leaflet-popup-content-wrapper{background:rgba(36,24,18,0.95)!important;color:#E2D1C3!important;border-radius:12px!important;border:1px solid rgba(196,124,32,0.3)!important;box-shadow:0 4px 20px rgba(0,0,0,0.4)!important}
    .leaflet-popup-tip{background:rgba(36,24,18,0.95)!important}
    .leaflet-popup-content{margin:8px 12px!important;font-family:'Space Grotesk',sans-serif!important;font-size:12px!important}
    html:not(.dark) .leaflet-popup-content-wrapper{background:rgba(255,255,255,0.95)!important;color:#333!important;border-color:rgba(0,0,0,0.1)!important}
    .scroll-fragment{flex:0 0 auto;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;transition:all 0.3s ease}
    .scroll-fragment.ribbon-active .frag-ring{background:linear-gradient(135deg,var(--primary-copper),#E5A354);box-shadow:0 0 16px rgba(196,124,32,0.4);transform:scale(1.05)}
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-body antialiased transition-colors duration-200">

<!-- â•â•â• ANA KAPSAYICI â€” referans tasarÄ±m birebir â•â•â• -->
<div class="relative w-full max-w-md mx-auto h-screen overflow-hidden bg-background-light dark:bg-background-dark shadow-2xl flex flex-col">

<!-- Celestial background -->
<div class="absolute inset-0 z-0 opacity-10 dark:opacity-30 bg-celestial bg-cover bg-center pointer-events-none mix-blend-soft-light"></div>
<div class="absolute inset-0 z-0 bg-gradient-to-b from-transparent via-background-light/60 to-background-light dark:via-background-dark/80 dark:to-background-dark pointer-events-none"></div>

<!-- â•â•â• HEADER â•â•â• -->
<header class="relative z-10 flex items-center justify-between px-6 pt-12 pb-4">
    <button onclick="window.location.href='mystic_numerology_home_1.html'" class="text-gray-800 dark:text-[#E2D1C3] p-2 rounded-full hover:bg-primary/10 transition">
        <span class="material-icons-outlined">arrow_back_ios</span>
    </button>
    <h1 class="text-xl font-display font-bold tracking-wider" style="background:linear-gradient(135deg,#D4AF37,#F5D060,#C47C20);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">NuMatch</h1>
    <div id="streak-badge" class="streak-badge rounded-full px-2.5 py-1 flex items-center gap-1 cursor-default" title="Streak">
        <span class="text-white text-xs streak-fire">ðŸ”¥</span>
        <span id="streak-count" class="text-white text-xs font-black">0</span>
    </div>
</header>

<!-- â•â•â• OPT-IN EKRANI â•â•â• -->
<div id="optin-screen" style="display:none" class="relative z-10 flex-1 flex flex-col items-center justify-center px-6 py-12 text-center">
    <div class="size-28 rounded-full flex items-center justify-center mb-8 pulse-glow" style="background:radial-gradient(circle,rgba(196,124,32,0.15),rgba(24,15,10,0.8));border:3px solid var(--primary-copper)">
        <span class="material-symbols-outlined text-5xl text-primary">auto_awesome</span>
    </div>
    <h2 class="font-display text-2xl font-bold copper-gradient-text mb-3 tracking-wider" data-i18n="match.optin_title">Kozmik EÅŸleÅŸme</h2>
    <p class="text-text-muted text-sm leading-relaxed max-w-[300px] mb-8" data-i18n="match.optin_subtitle">
        Numerolojik profilini diÄŸer kullanÄ±cÄ±larla paylaÅŸ ve evrenin senin iÃ§in seÃ§tiÄŸi ruh eÅŸlerini keÅŸfet.
    </p>
    <div class="glass-light dark:glass rounded-2xl p-4 mb-6 w-full max-w-[320px]">
        <div class="flex items-center gap-3 mb-3">
            <span class="material-symbols-outlined text-primary">visibility</span>
            <div class="flex-1 text-left">
                <p class="text-sm font-bold text-gray-800 dark:text-[#E2D1C3]" data-i18n="match.optin_shared_title">Ne paylaÅŸÄ±lÄ±r?</p>
                <p class="text-text-muted text-xs" data-i18n="match.optin_shared_desc">Sadece ismin, yaÅŸam yolu ve numerolojik sayÄ±larÄ±n</p>
            </div>
        </div>
        <div class="flex items-center gap-3 mb-3">
            <span class="material-symbols-outlined text-red-400">lock</span>
            <div class="flex-1 text-left">
                <p class="text-sm font-bold text-gray-800 dark:text-[#E2D1C3]" data-i18n="match.optin_privacy_title">Gizlilik</p>
                <p class="text-text-muted text-xs" data-i18n="match.optin_privacy_desc">DoÄŸum tarihin ve kiÅŸisel verilerin paylaÅŸÄ±lmaz</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-emerald-400">toggle_on</span>
            <div class="flex-1 text-left">
                <p class="text-sm font-bold text-gray-800 dark:text-[#E2D1C3]" data-i18n="match.optin_toggle_title">Ä°stediÄŸin zaman kapat</p>
                <p class="text-text-muted text-xs" data-i18n="match.optin_toggle_desc">Profil ayarlarÄ±ndan keÅŸfedilebilirliÄŸini kapat</p>
            </div>
        </div>
    </div>
    <!-- Åžehir SeÃ§ici -->
    <div class="w-full max-w-[320px] mb-6">
        <label class="text-xs font-bold text-text-muted uppercase tracking-wider mb-2 block text-left">
            <span class="material-symbols-outlined text-sm align-middle mr-1">location_on</span>
            <span data-i18n="match.select_city_label">Åžehrini SeÃ§</span>
        </label>
        <select id="city-select" class="w-full py-3 px-4 rounded-xl text-sm font-medium bg-white/5 dark:bg-white/5 border border-gray-200 dark:border-primary/20 text-gray-800 dark:text-[#E2D1C3] focus:outline-none focus:ring-2 focus:ring-primary/40 appearance-none" style="background-image:url('data:image/svg+xml;utf8,<svg fill=\&quot;%23C47C20\&quot; viewBox=\&quot;0 0 24 24\&quot; xmlns=\&quot;http://www.w3.org/2000/svg\&quot;><path d=\&quot;M7 10l5 5 5-5z\&quot;/></svg>');background-repeat:no-repeat;background-position:right 12px center;background-size:20px">
            <option value="" data-i18n="match.select_province">â€” Ä°l seÃ§in â€”</option>
        </select>
    </div>
    <button id="btn-optin" class="w-full max-w-[320px] py-4 rounded-2xl text-sm font-bold uppercase tracking-[0.15em] flex items-center justify-center gap-3 text-white transition active:scale-95 bg-gradient-to-r from-primary/80 to-primary shadow-lg shadow-primary/20 border border-white/10">
        <span class="material-symbols-outlined">rocket_launch</span>
        <span data-i18n="match.join_discovery_btn">KeÅŸfe KatÄ±l</span>
    </button>
</div>

<!-- â•â•â• ANA Ä°Ã‡ERÄ°K â•â•â• -->
<main id="main-content" style="display:none" class="relative z-10 flex-1 overflow-y-auto no-scrollbar px-5 pb-32 space-y-6">

    <!-- â•â•â• SACRED MATCH CARD â€” referans tasarÄ±mÄ±n ana kartÄ± â•â•â• -->
    <div id="match-card" class="relative w-full glass-light dark:glass rounded-3xl p-1 shadow-2xl match-card-blur fade-up" style="animation-delay:0.05s">
        <div class="bg-white/40 dark:bg-card-dark/40 rounded-[20px] p-5">

            <!-- Loading state -->
            <div id="match-loading">
                <div class="flex items-center justify-between mb-6 relative">
                    <div class="flex flex-col items-center space-y-2 z-10">
                        <div class="w-20 h-20 rounded-full shimmer-placeholder"></div>
                        <div class="h-3 w-14 rounded shimmer-placeholder"></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="h-3 w-16 rounded shimmer-placeholder mb-2"></div>
                        <div class="h-8 w-14 rounded shimmer-placeholder"></div>
                    </div>
                    <div class="flex flex-col items-center space-y-2 z-10">
                        <div class="w-20 h-20 rounded-full shimmer-placeholder"></div>
                        <div class="h-3 w-14 rounded shimmer-placeholder"></div>
                    </div>
                </div>
                <div class="mb-5">
                    <div class="h-3 w-24 rounded shimmer-placeholder mb-2"></div>
                    <div class="flex gap-2"><div class="h-6 w-20 rounded-full shimmer-placeholder"></div><div class="h-6 w-16 rounded-full shimmer-placeholder"></div></div>
                </div>
                <div class="mb-6"><div class="h-3 w-20 rounded shimmer-placeholder mb-2"></div><div class="h-4 w-full rounded shimmer-placeholder"></div></div>
            </div>

            <!-- Match content (JS dolduracak) -->
            <div id="match-content" style="display:none">
                <!-- Ä°ki avatar + ortada skor â€” referanstaki gibi -->
                <div class="flex items-center justify-between mb-6 relative">
                    <div class="flex flex-col items-center space-y-2 z-10">
                        <div class="w-20 h-20 rounded-full p-0.5 bg-gradient-to-br from-primary via-[#E5A354] to-accent-gold-dark shadow-lg shadow-primary/20">
                            <div id="radar-center" class="w-full h-full rounded-full overflow-hidden border-2 border-background-light dark:border-card-dark flex items-center justify-center bg-white/60 dark:bg-card-dark">
                                <span id="radar-user-initial" class="text-primary text-2xl font-bold">?</span>
                            </div>
                        </div>
                        <span id="radar-rank-label" class="text-lg font-bold text-gray-800 dark:text-[#E2D1C3]" data-i18n="match.you_label">Sen</span>
                    </div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center -mt-2">
                        <span class="text-[10px] text-text-muted uppercase tracking-[0.2em] mb-1 font-bold">Sacred Match</span>
                        <span id="match-score" class="text-4xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-b from-primary to-accent-gold-dark drop-shadow-sm">â€”%</span>
                    </div>
                    <div class="flex flex-col items-center space-y-2 z-10">
                        <div class="w-20 h-20 rounded-full p-0.5 bg-gradient-to-br from-primary via-[#E5A354] to-accent-gold-dark shadow-lg shadow-primary/20">
                            <div id="match-avatar" class="blur-layer w-full h-full rounded-full overflow-hidden border-2 border-background-light dark:border-card-dark flex items-center justify-center bg-white/60 dark:bg-card-dark">
                                <span class="text-primary text-2xl font-bold">?</span>
                            </div>
                        </div>
                        <span id="match-name" class="blur-layer text-lg font-bold text-gray-800 dark:text-[#E2D1C3]">???</span>
                    </div>
                </div>

                <!-- Soul Interests -->
                <div class="mb-5">
                    <h3 class="text-xs font-bold text-text-muted uppercase tracking-wider mb-2" data-i18n="match.soul_harmony">Ruhsal Uyum</h3>
                    <div id="soul-tags" class="flex flex-wrap gap-2">
                        <span id="match-archetype" class="px-3 py-1 rounded-full bg-primary/10 dark:bg-white/5 text-xs font-medium text-primary dark:text-primary/90 border border-primary/20">Life Path ?</span>
                    </div>
                </div>
                <span id="match-lp" style="display:none">?</span>

                <!-- Divine Essence -->
                <div class="mb-8">
                    <h3 class="text-xs font-bold text-text-muted uppercase tracking-wider mb-1" data-i18n="match.cosmic_bond">Kozmik BaÄŸ</h3>
                    <p id="match-bond" class="text-sm text-gray-600 dark:text-[#BCB1A8] leading-relaxed">â€”</p>
                </div>

                <!-- Score bar -->
                <div class="w-full h-1.5 rounded-full overflow-hidden mb-2" style="background:rgba(196,124,32,0.1)">
                    <div id="match-bar" class="h-full rounded-full cosmic-gradient" style="width:0%;transition:width 1.5s cubic-bezier(0.34,1.56,0.64,1)"></div>
                </div>

                <!-- Floating action buttons â€” referanstaki gibi kartÄ±n altÄ±ndan taÅŸan -->
                <div class="absolute -bottom-7 left-0 right-0 flex justify-center gap-6 z-20">
                    <button id="btn-reveal" style="display:none"
                        class="w-14 h-14 rounded-full bg-gradient-to-b from-primary to-accent-gold-dark shadow-xl shadow-black/40 flex items-center justify-center transform hover:scale-105 transition active:scale-95 border border-white/20">
                        <span class="material-icons-round text-white text-2xl">visibility</span>
                    </button>
                </div>
                <p id="reveal-label" style="display:none" data-i18n="match.reveal_profile">Profili AÃ§</p>

                <!-- Revealed info -->
                <div id="revealed-info" style="display:none" class="absolute -bottom-7 left-0 right-0 flex justify-center gap-6 z-20">
                    <div class="flex gap-4">
                        <button id="btn-connect-revealed" class="w-14 h-14 rounded-full bg-gradient-to-b from-primary to-accent-gold-dark shadow-xl shadow-black/40 flex items-center justify-center transform hover:scale-105 transition active:scale-95 border border-white/20">
                            <span class="material-icons-round text-white text-2xl">person_add</span>
                        </button>
                        <button id="btn-msg-revealed" class="w-14 h-14 rounded-full bg-gradient-to-b from-primary to-accent-gold-dark shadow-xl shadow-black/40 flex items-center justify-center transform hover:scale-105 transition active:scale-95 border border-white/20">
                            <span class="material-icons-round text-white text-2xl">chat_bubble</span>
                        </button>
                    </div>
                </div>

                <!-- No credits -->
                <div id="no-credits-msg" style="display:none" class="w-full text-center pt-2">
                    <p class="text-text-muted text-xs" data-i18n="match.no_credits_msg">ðŸ”’ BugÃ¼nkÃ¼ reveal hakkÄ±n doldu</p>
                    <p class="text-text-muted/50 text-[10px] mt-1" data-i18n="match.credits_tomorrow">YarÄ±n 5 yeni hak gelecek</p>
                </div>

                <!-- Premium paywall -->
                <div id="premium-paywall" style="display:none" class="absolute -bottom-7 left-0 right-0 flex justify-center z-20">
                    <button onclick="window.location.href='premium_crystal_store.html'"
                        class="px-6 py-3 rounded-full bg-gradient-to-b from-primary to-accent-gold-dark shadow-xl shadow-black/40 flex items-center justify-center gap-2 transform hover:scale-105 transition active:scale-95 border border-white/20">
                        <span class="material-symbols-outlined text-white text-lg">workspace_premium</span>
                        <span class="text-white text-xs font-bold uppercase tracking-wider">Premium</span>
                    </button>
                </div>
            </div>

            <!-- No match â€” aynÄ± kart yapÄ±sÄ±nda placeholder -->
            <div id="match-empty" style="display:none">
                <div class="flex items-center justify-between mb-6 relative">
                    <div class="flex flex-col items-center space-y-2 z-10">
                        <div class="w-20 h-20 rounded-full p-0.5 bg-gradient-to-br from-primary via-[#E5A354] to-accent-gold-dark shadow-lg shadow-primary/20">
                            <div id="empty-user-avatar" class="w-full h-full rounded-full overflow-hidden border-2 border-background-light dark:border-card-dark flex items-center justify-center bg-white/60 dark:bg-card-dark">
                                <span class="material-symbols-outlined text-primary text-3xl">person</span>
                            </div>
                        </div>
                        <span id="empty-user-name" class="text-lg font-bold text-gray-800 dark:text-[#E2D1C3]" data-i18n="match.you_label">Sen</span>
                    </div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center -mt-2">
                        <span class="text-[10px] text-text-muted uppercase tracking-[0.2em] mb-1 font-bold">Sacred Match</span>
                        <span class="text-4xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-b from-primary to-accent-gold-dark drop-shadow-sm">?</span>
                    </div>
                    <div class="flex flex-col items-center space-y-2 z-10">
                        <div class="w-20 h-20 rounded-full p-0.5 bg-gradient-to-br from-primary/30 via-[#E5A354]/30 to-accent-gold-dark/30 shadow-lg">
                            <div class="w-full h-full rounded-full overflow-hidden border-2 border-background-light dark:border-card-dark flex items-center justify-center bg-white/60 dark:bg-card-dark">
                                <span class="material-symbols-outlined text-text-muted text-3xl">help</span>
                            </div>
                        </div>
                        <span class="text-lg font-bold text-text-muted">???</span>
                    </div>
                </div>
                <div class="mb-5">
                    <h3 class="text-xs font-bold text-text-muted uppercase tracking-wider mb-2" data-i18n="match.soul_harmony">Ruhsal Uyum</h3>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-1 rounded-full bg-primary/10 dark:bg-white/5 text-xs font-medium text-text-muted border border-primary/10" data-i18n="match.waiting_match">EÅŸleÅŸme Bekleniyor</span>
                    </div>
                </div>
                <div class="mb-8">
                    <h3 class="text-xs font-bold text-text-muted uppercase tracking-wider mb-1" data-i18n="match.cosmic_bond">Kozmik BaÄŸ</h3>
                    <p class="text-sm text-gray-600 dark:text-[#BCB1A8] leading-relaxed" data-i18n="match.empty_bond_desc">Daha fazla kullanÄ±cÄ± katÄ±ldÄ±kÃ§a eÅŸleÅŸmeler baÅŸlayacak. Kozmik baÄŸÄ±n yakÄ±nda ortaya Ã§Ä±kacak!</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Streak & Credits (compact bar) -->
    <div id="streak-credits-bar" class="fade-up flex items-center gap-3" style="animation-delay:0.08s">
        <div class="flex-1 glass-light dark:glass rounded-2xl p-2.5 flex items-center gap-2">
            <span class="text-lg streak-fire">ðŸ”¥</span>
            <div>
                <p id="streak-label" class="text-xs font-bold text-gray-800 dark:text-[#E2D1C3]">0 GÃ¼n Streak</p>
                <p id="streak-next" class="text-text-muted text-[10px]">Sonraki Ã¶dÃ¼l: 3 gÃ¼nde</p>
            </div>
        </div>
        <div class="glass-light dark:glass rounded-2xl p-2.5 flex items-center gap-2 shrink-0">
            <span class="material-symbols-outlined text-lg text-primary">visibility</span>
            <div>
                <p id="credits-count" class="text-xs font-bold text-gray-800 dark:text-[#E2D1C3]">3</p>
                <p id="credits-label" class="text-text-muted text-[10px]">BugÃ¼n</p>
            </div>
        </div>
    </div>

    <!-- â•â•â• DAILY DIVINE MATCHES â€” referanstaki yatay avatar scroll â•â•â• -->
    <div class="pt-2 fade-up" style="animation-delay:0.1s">
        <h2 class="text-xs font-bold text-text-muted uppercase tracking-widest mb-3 px-1" data-i18n="match.daily_matches_title">GÃ¼nlÃ¼k EÅŸleÅŸmeler</h2>
        <div id="match-ribbon" class="flex overflow-x-auto no-scrollbar gap-4 pb-2">
            <!-- JS ile doldurulacak -->
        </div>
    </div>

    <!-- â•â•â• NEARBY SPIRITS â€” Åžehir BazlÄ± Harita â•â•â• -->
    <div class="pt-4 fade-up" style="animation-delay:0.15s">
        <div class="flex justify-between items-center mb-3 px-1">
            <h2 class="text-base font-bold text-gray-800 dark:text-[#E2D1C3]" data-i18n="match.cosmic_map_title">Kozmik Harita</h2>
            <div class="flex items-center gap-2">
                <span class="text-text-muted text-xs" id="map-info"></span>
                <button id="btn-change-city" class="flex items-center gap-1 text-xs text-primary font-bold px-2 py-1 rounded-lg bg-primary/10 border border-primary/20 transition active:scale-95">
                    <span class="material-symbols-outlined" style="font-size:14px">edit_location_alt</span>
                    <span id="btn-city-label" data-i18n="match.city_btn">Åžehir</span>
                </button>
            </div>
        </div>
        <!-- Åžehir deÄŸiÅŸtirme paneli -->
        <div id="city-change-panel" style="display:none" class="mb-3 glass-light dark:glass rounded-2xl p-3 flex items-center gap-2">
            <span class="material-symbols-outlined text-primary text-lg">location_on</span>
            <select id="city-change-select" class="flex-1 py-2 px-3 rounded-xl text-sm font-medium bg-white/10 dark:bg-white/5 border border-gray-200 dark:border-primary/20 text-gray-800 dark:text-[#E2D1C3] focus:outline-none focus:ring-2 focus:ring-primary/40 appearance-none" style="background-image:url('data:image/svg+xml;utf8,<svg fill=\&quot;%23C47C20\&quot; viewBox=\&quot;0 0 24 24\&quot; xmlns=\&quot;http://www.w3.org/2000/svg\&quot;><path d=\&quot;M7 10l5 5 5-5z\&quot;/></svg>');background-repeat:no-repeat;background-position:right 10px center;background-size:18px">
                <option value="" data-i18n="match.select_province">â€” Ä°l seÃ§in â€”</option>
            </select>
            <button id="btn-save-city" class="px-3 py-2 rounded-xl text-xs font-bold text-white bg-primary transition active:scale-95" data-i18n="match.save_btn">Kaydet</button>
            <button id="btn-cancel-city" class="px-2 py-2 rounded-xl text-xs text-text-muted transition active:scale-95">
                <span class="material-symbols-outlined" style="font-size:18px">close</span>
            </button>
        </div>
        <div class="relative w-full rounded-3xl overflow-hidden shadow-lg border border-gray-200 dark:border-primary/20" style="height:220px">
            <div id="cosmic-map" style="width:100%;height:100%;z-index:1"></div>
            <div class="absolute top-3 right-3 z-[500] bg-black/60 backdrop-filter backdrop-blur-md p-2 rounded-full text-white pointer-events-none">
                <span class="material-icons-outlined text-sm block">map</span>
            </div>
        </div>
        <div id="map-empty" style="display:none" class="text-center mt-2">
            <p class="text-text-muted text-xs" data-i18n="match.map_empty">Haritada henÃ¼z ruh yok...</p>
        </div>
    </div>

    <!-- â•â•â• KOZMÄ°K ANALÄ°Z (AI) â•â•â• -->
    <div id="insight-section" style="display:none;animation-delay:0.18s" class="fade-up space-y-3">
        <h2 class="text-xs font-bold text-text-muted uppercase tracking-widest px-1" data-i18n="match.cosmic_analysis_title">Kozmik Analiz</h2>
        <div class="glass-light dark:glass rounded-2xl p-4">
            <div class="flex items-center gap-2 mb-3">
                <span class="material-symbols-outlined text-primary text-base">auto_awesome</span>
                <h4 class="text-xs font-bold uppercase tracking-wider text-primary" data-i18n="match.harmony_analysis">Uyum Analizi</h4>
            </div>
            <div id="insight-loading" style="display:none" class="space-y-2">
                <div class="h-3 w-full rounded shimmer-placeholder"></div>
                <div class="h-3 w-5/6 rounded shimmer-placeholder"></div>
                <div class="h-3 w-4/6 rounded shimmer-placeholder"></div>
                <div class="h-3 w-5/6 rounded shimmer-placeholder"></div>
            </div>
            <p id="insight-ai" class="text-sm leading-relaxed text-gray-600 dark:text-[#BCB1A8]" style="white-space:pre-line">â€”</p>
        </div>
    </div>

    <!-- â•â•â• SACRED TRANSITIONS â€” referanstaki arkadaÅŸ listesi stili â•â•â• -->
    <div class="pt-2 fade-up space-y-3" style="animation-delay:0.2s">
        <h2 class="text-xs font-bold text-text-muted uppercase tracking-widest px-1" data-i18n="match.past_matches_title">GeÃ§miÅŸ EÅŸleÅŸmeler</h2>
        <div id="history-list" class="space-y-3"></div>
        <div id="history-empty" style="display:none" class="text-center py-6 text-text-muted/50 text-xs" data-i18n="match.history_empty">
            EÅŸleÅŸme geÃ§miÅŸin burada gÃ¶rÃ¼necek
        </div>
    </div>

    <div class="h-6"></div>
</main>

<!-- Connection Popup -->
<div id="conn-popup-overlay" style="display:none" class="fixed inset-0 bg-black/50 z-[100]"></div>
<div id="conn-popup" style="display:none" class="fixed z-[101] glass-light dark:glass rounded-2xl p-4 shadow-xl max-w-[260px]">
    <p id="conn-popup-name" class="text-sm font-bold mb-3 truncate text-gray-800 dark:text-[#E2D1C3]"></p>
    <button id="conn-popup-btn" class="w-full py-2.5 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all active:scale-95 bg-gradient-to-r from-primary/80 to-primary text-white shadow-sm">
        <span class="material-symbols-outlined text-base">person_add</span>
        <span id="conn-popup-btn-label" data-i18n="match.add_connection">Add Connection</span>
    </button>
    <p id="conn-popup-status" style="display:none" class="text-text-muted text-xs text-center mt-2"></p>
</div>

</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {

    function getPhoto(name, gender, avatarUrl) { return window.avatarUtil.getAvatarUrl({ avatarUrl: avatarUrl, name: name, gender: gender }); }
    function initial(name) { return (name||'?').charAt(0).toUpperCase(); }

    if (window.auth && window.auth.whenReady) { await window.auth.whenReady(); }

    var session = null; var userId = null;
    try { session = await window.auth.getSession(); if (session && session.user) userId = session.user.id; } catch(e) {}
    if (!userId) { window.location.href = 'mystic_sign_up_screen.html'; return; }

    // Supabase'den profili Ã§ek (tek doÄŸru kaynak), localStorage sadece offline fallback
    var ud = null;
    try {
        var profRes = await window.supabaseClient.from('profiles').select('*').eq('id', userId).single();
        if (profRes.data && (profRes.data.full_name || profRes.data.name) && profRes.data.birth_date) {
            ud = { name: profRes.data.full_name || profRes.data.name, birthDate: profRes.data.birth_date, gender: profRes.data.gender || 'unknown', avatarUrl: profRes.data.avatar_url || '' };
            try { localStorage.setItem('numerael_user_data', JSON.stringify(ud)); } catch(e) {}
        }
    } catch(e) {
        console.warn('[CosmicMatch] Supabase profil hatasÄ±, localStorage fallback:', e.message);
        try { ud = JSON.parse(localStorage.getItem('numerael_user_data')||'null'); } catch(e2) {}
    }
    if (!ud || !ud.name) { window.location.href = 'data-ready_birth_form.html'; return; }

    var userProfile = {
        user_id: userId, full_name: ud.name, gender: ud.gender || 'unknown',
        life_path: window.discovery.calcLP(ud.birthDate),
        expression_num: window.discovery.calcExp(ud.name),
        soul_urge: window.discovery.calcSoul(ud.name),
        personality_num: window.discovery.calcPers(ud.name)
    };

    // Set user avatar
    document.getElementById('radar-user-initial').textContent = initial(ud.name);
    var userAvatarUrl = getPhoto(ud.name, ud.gender, null);
    if (userAvatarUrl) {
        document.getElementById('radar-center').innerHTML = '<img src="' + userAvatarUrl + '" class="w-full h-full object-cover rounded-full" alt="">';
        var emptyAvatar = document.getElementById('empty-user-avatar');
        if (emptyAvatar) emptyAvatar.innerHTML = '<img src="' + userAvatarUrl + '" class="w-full h-full object-cover rounded-full" alt="">';
    }
    var rlabel = document.getElementById('radar-rank-label');
    if (rlabel) rlabel.textContent = ud.name ? ud.name.split(' ')[0] : 'Sen';
    var emptyName = document.getElementById('empty-user-name');
    if (emptyName) emptyName.textContent = ud.name ? ud.name.split(' ')[0] : 'Sen';

    var ribbonMatches = []; var activeRibbonIdx = 0; var storedRemaining = 0; var storedIsPrem = false;

    // Gamification
    if (window.gamification) {
        window.gamification.addXP('cosmic_match_view', 0);
        window.gamification.trackAction('cosmic_match_view');
    }

    // Åžehir seÃ§ici doldur (ilÃ§eli ÅŸehirler optgroup ile)
    var citySelect = document.getElementById('city-select');
    if (citySelect && window.populateCitySelect) {
        window.populateCitySelect(citySelect);
    }

    // Opt-in
    var optedIn = localStorage.getItem('numerael_discovery_opted_in') === 'true';
    if (!optedIn) {
        document.getElementById('optin-screen').style.display = 'flex';
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('btn-optin').addEventListener('click', async function() {
            var selectedCity = citySelect ? citySelect.value : '';
            if (!selectedCity) {
                citySelect.style.borderColor = '#ef4444';
                citySelect.focus();
                return;
            }
            this.disabled = true;
            this.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> KatÄ±lÄ±nÄ±yor...';
            var success = await window.discovery.optIn(userId, selectedCity);
            if (success) {
                optedIn = true;
                document.getElementById('optin-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initMain();
            } else {
                this.disabled = false;
                this.innerHTML = '<span class="material-symbols-outlined">rocket_launch</span> KeÅŸfe KatÄ±l';
                alert('BaÄŸlantÄ± hatasÄ±. LÃ¼tfen tekrar dene.');
            }
        });
    } else {
        document.getElementById('optin-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        initMain();
    }

    // Reveal handler
    document.getElementById('btn-reveal').addEventListener('click', async function() {
        var activeItem = ribbonMatches[activeRibbonIdx];
        if (!activeItem || !activeItem.profile) return;
        var m = activeItem.profile;
        this.disabled = true;
        this.innerHTML = '<span class="material-symbols-outlined animate-spin text-white">progress_activity</span>';
        var result = await window.discovery.revealMatch(userId, activeItem.matchDate, activeItem.matchedUserId, storedIsPrem);
        if (result.success) {
            activeItem.revealed = true;
            showRevealed(m);
            storedRemaining = Math.max(0, result.remaining);
            document.getElementById('credits-count').textContent = storedRemaining;
            var frags = document.querySelectorAll('#match-ribbon .scroll-fragment');
            if (frags[activeRibbonIdx]) {
                var innerDiv = frags[activeRibbonIdx].querySelector('.frag-inner');
                if (innerDiv) innerDiv.innerHTML = '<img src="' + getPhoto(m.full_name, m.gender, m.avatar_url) + '" class="w-full h-full object-cover rounded-full">';
            }
            // Revealed eÅŸleÅŸmeyi hemen geÃ§miÅŸ listesine ekle
            addRevealedToHistory(activeItem, m, storedIsPrem);
        } else if (result.reason === 'daily_limit') {
            document.getElementById('btn-reveal').style.display = 'none';
            document.getElementById('no-credits-msg').style.display = 'block';
            document.getElementById('credits-count').textContent = '0';
            storedRemaining = 0;
        } else if (result.reason === 'not_premium') {
            document.getElementById('btn-reveal').style.display = 'none';
            document.getElementById('premium-paywall').style.display = 'flex';
        }
        this.disabled = false;
        this.innerHTML = '<span class="material-icons-round text-white text-2xl">visibility</span>';
    });

    // â”€â”€â”€ Revealed card: Add Connection button â”€â”€â”€
    document.getElementById('btn-connect-revealed').addEventListener('click', async function() {
        var activeItem = ribbonMatches[activeRibbonIdx];
        if (!activeItem || !activeItem.matchedUserId) return;
        var btn = this;
        var icon = btn.querySelector('span');
        btn.disabled = true;
        icon.textContent = 'progress_activity';
        icon.classList.add('animate-spin');

        try {
            var connected = await window.connectionEngine.areConnected(userId, activeItem.matchedUserId);
            if (connected) {
                icon.classList.remove('animate-spin');
                icon.textContent = 'how_to_reg';
                return;
            }
            var existing = await window.connectionEngine.hasActiveRequest(userId, activeItem.matchedUserId);
            if (existing) {
                icon.classList.remove('animate-spin');
                icon.textContent = 'schedule';
                return;
            }
            var result = await window.connectionEngine.sendConnectionRequest(userId, activeItem.matchedUserId);
            icon.classList.remove('animate-spin');
            if (result.success) {
                icon.textContent = 'check_circle';
                icon.style.color = '#10b981';
            } else {
                icon.textContent = 'person_add';
                btn.disabled = false;
            }
        } catch(e) {
            console.error('[CosmicMatch] Connection request error:', e);
            icon.classList.remove('animate-spin');
            icon.textContent = 'person_add';
            btn.disabled = false;
        }
    });

    // â”€â”€â”€ Revealed card: Message button â”€â”€â”€
    document.getElementById('btn-msg-revealed').addEventListener('click', function() {
        var activeItem = ribbonMatches[activeRibbonIdx];
        if (!activeItem || !activeItem.matchedUserId) return;
        var targetName = activeItem.profile ? activeItem.profile.full_name : '';
        window.location.href = 'messaging.html?uid=' + encodeURIComponent(activeItem.matchedUserId) + '&name=' + encodeURIComponent(targetName);
    });

    async function initMain() {
      try {
        var refreshResult = await window.discovery.refreshOwnProfile(userId);
        if (refreshResult && refreshResult.gender) userProfile.gender = refreshResult.gender;
        if (refreshResult && refreshResult.avatar_url) {
            var freshUrl = getPhoto(ud.name, userProfile.gender, refreshResult.avatar_url);
            document.getElementById('radar-center').innerHTML = '<img src="' + freshUrl + '" class="w-full h-full object-cover rounded-full" alt="">';
        }

        var isPrem = false;
        if (window.premium) isPrem = await window.premium.checkStatus();
        if (!isPrem) {
            var streak = await window.discovery.updateStreak(userId);
            renderStreak(streak);
        } else {
            var bar = document.getElementById('streak-credits-bar');
            if (bar) bar.style.display = 'none';
            document.getElementById('streak-badge').style.display = 'none';
        }
        storedIsPrem = isPrem;

        var dailyMatches = await window.discovery.findDailyMatches(userId, userProfile);
        var todayReveals = await window.discovery.getDailyRevealCount(userId);
        storedRemaining = isPrem ? (window.discovery.PREMIUM_DAILY_REVEALS - todayReveals) : 0;
        document.getElementById('credits-count').textContent = isPrem ? Math.max(0, storedRemaining) : 'ðŸ”’';
        document.getElementById('credits-label').textContent = isPrem ? 'BugÃ¼n' : 'Premium';

        populateRibbon(dailyMatches);
        renderMap(dailyMatches);

        if (dailyMatches.length > 0) {
            document.getElementById('match-loading').style.display = 'none';
            document.getElementById('match-content').style.display = 'block';
            updateCardDisplay(ribbonMatches[0]);
        } else {
            document.getElementById('match-loading').style.display = 'none';
            document.getElementById('match-empty').style.display = 'block';
        }

        var history = await window.discovery.getMatchHistory(userId, 30);
        var todayStr = window.discovery.todayStr();
        // BugÃ¼nkÃ¼ revealed eÅŸleÅŸmeler + geÃ§miÅŸ tÃ¼m eÅŸleÅŸmeler
        var visibleHistory = history.filter(function(h) {
            return h.match_date !== todayStr || h.revealed;
        });
        renderHistory(visibleHistory, isPrem);
      } catch(e) { console.error('[CosmicMatch] initMain hatasÄ±:', e); }
    }

    function renderStreak(s) {
        if (!s) return;
        document.getElementById('streak-count').textContent = s.current_streak;
        document.getElementById('streak-label').textContent = s.current_streak + ' GÃ¼n Streak';
        if (s.current_streak >= 7) document.getElementById('streak-next').textContent = 'ðŸ”¥ Harika gidiyorsun!';
        else if (s.current_streak >= 3) document.getElementById('streak-next').textContent = 'âœ¨ Streak\'ini sÃ¼rdÃ¼r!';
        else document.getElementById('streak-next').textContent = 'Her gÃ¼n gir, streak\'ini bÃ¼yÃ¼t!';
    }

    function showRevealed(m) {
        document.getElementById('match-card').classList.remove('match-card-blur');
        document.getElementById('match-card').classList.add('match-card-revealed');
        document.getElementById('match-name').textContent = m.full_name || '???';
        document.getElementById('match-avatar').innerHTML = '<img src="' + getPhoto(m.full_name, m.gender, m.avatar_url) + '" class="w-full h-full object-cover rounded-full" alt="">';
        document.getElementById('btn-reveal').style.display = 'none';
        document.getElementById('no-credits-msg').style.display = 'none';
        document.getElementById('premium-paywall').style.display = 'none';
        document.getElementById('revealed-info').style.display = 'flex';
        // Yeni reveal â€” henÃ¼z baÄŸlantÄ± yok, mesaj butonu gizle
        document.getElementById('btn-msg-revealed').style.display = 'none';
    }

    function maskName(name) {
        if (!name) return '???';
        var parts = name.split(' ');
        return parts.map(function(p) { return p.charAt(0) + 'â€¢'.repeat(Math.max(p.length - 1, 2)); }).join(' ');
    }

    // Ribbon â€” referanstaki Daily Divine Matches yapÄ±sÄ±
    function populateRibbon(dailyMatches) {
        var ribbonEl = document.getElementById('match-ribbon');
        ribbonEl.innerHTML = ''; ribbonMatches = []; activeRibbonIdx = 0;
        (dailyMatches || []).forEach(function(match) {
            if (match && match.matched) {
                ribbonMatches.push({ profile: match.matched, score: match.match_score || 0, revealed: match.revealed || false, matchDate: match.match_date, matchedUserId: match.matched_user_id });
            }
        });
        if (!ribbonMatches.length) return;
        ribbonMatches.forEach(function(item, idx) {
            var frag = document.createElement('button');
            frag.className = 'scroll-fragment flex-shrink-0 flex flex-col items-center gap-1.5 focus:outline-none group' + (idx === 0 ? ' ribbon-active' : '');
            var p = item.profile;
            var showFace = storedIsPrem || item.revealed;
            frag.innerHTML =
                '<div class="frag-ring w-16 h-16 rounded-full p-[2px] bg-gradient-to-tr from-primary/40 to-primary shadow-inner transition-all">' +
                    '<div class="frag-inner w-full h-full rounded-full border-2 border-background-light dark:border-background-dark overflow-hidden flex items-center justify-center bg-white/60 dark:bg-card-dark">' +
                        (showFace
                            ? '<img src="' + getPhoto(p.full_name, p.gender, p.avatar_url) + '" class="w-full h-full object-cover">'
                            : '<span class="text-primary text-lg font-bold">' + initial(p.full_name) + '</span>') +
                    '</div>' +
                '</div>' +
                '<span class="text-[10px] font-bold text-gray-700 dark:text-[#E2D1C3] uppercase tracking-tighter">' + (showFace ? (p.full_name||'?').split(' ')[0] : initial(p.full_name)) + '</span>';
            frag.addEventListener('click', function() { selectRibbonItem(idx); });
            ribbonEl.appendChild(frag);
        });
    }

    function selectRibbonItem(idx) {
        if (idx >= ribbonMatches.length) return;
        activeRibbonIdx = idx;
        document.querySelectorAll('#match-ribbon .scroll-fragment').forEach(function(f, i) {
            if (i === idx) f.classList.add('ribbon-active'); else f.classList.remove('ribbon-active');
        });
        updateCardDisplay(ribbonMatches[idx]);
    }

    function updateCardDisplay(item) {
        var m = item.profile; var score = item.score;
        var isRevealed = item.revealed || storedIsPrem;

        // â”€â”€â”€ 1. Ã–NCE isim, avatar, skor gÃ¼ncelle (kullanÄ±cÄ± hemen gÃ¶rsÃ¼n) â”€â”€â”€
        try {
            document.getElementById('match-loading').style.display = 'none';
            document.getElementById('match-empty').style.display = 'none';
            document.getElementById('match-content').style.display = 'block';
            document.getElementById('match-score').textContent = score + '%';
            document.getElementById('match-bar').style.width = '0%';
            setTimeout(function() { document.getElementById('match-bar').style.width = score + '%'; }, 50);

            // Ä°sim ve avatar â€” revealed durumuna gÃ¶re
            if (isRevealed) {
                document.getElementById('match-card').classList.remove('match-card-blur');
                document.getElementById('match-card').classList.add('match-card-revealed');
                document.getElementById('match-name').textContent = m.full_name || '???';
                document.getElementById('match-avatar').innerHTML = '<img src="' + getPhoto(m.full_name, m.gender, m.avatar_url) + '" class="w-full h-full object-cover rounded-full" alt="">';
                document.getElementById('btn-reveal').style.display = 'none';
                document.getElementById('no-credits-msg').style.display = 'none';
                document.getElementById('premium-paywall').style.display = 'none';
                document.getElementById('revealed-info').style.display = 'flex';

                // BaÄŸlantÄ± durumuna gÃ¶re butonlarÄ± gÃ¼ncelle
                (async function() {
                    try {
                        var connectBtn = document.getElementById('btn-connect-revealed');
                        var msgBtn = document.getElementById('btn-msg-revealed');
                        var connectIcon = connectBtn.querySelector('span');
                        var matchedUid = m.user_id;
                        if (!matchedUid || !window.connectionEngine) return;

                        // Ã–nce reset â€” mesaj butonunu gizle, connect gÃ¶ster
                        connectBtn.disabled = false;
                        connectBtn.style.display = 'flex';
                        connectIcon.textContent = 'person_add';
                        connectIcon.style.color = '';
                        msgBtn.style.display = 'none';

                        var connected = await window.connectionEngine.areConnected(userId, matchedUid);
                        if (connected) {
                            connectIcon.textContent = 'how_to_reg';
                            connectIcon.style.color = '#10b981';
                            connectBtn.disabled = true;
                            // BaÄŸlantÄ± varsa mesaj butonunu gÃ¶ster
                            msgBtn.style.display = 'flex';
                            return;
                        }
                        var pending = await window.connectionEngine.hasActiveRequest(userId, matchedUid);
                        if (pending) {
                            connectIcon.textContent = 'schedule';
                            connectIcon.style.color = '#f59e0b';
                            connectBtn.disabled = true;
                        }
                    } catch(e) {}
                })();
            } else {
                document.getElementById('match-card').classList.add('match-card-blur');
                document.getElementById('match-card').classList.remove('match-card-revealed');
                document.getElementById('match-name').textContent = maskName(m.full_name);
                document.getElementById('match-avatar').innerHTML = '<span class="text-primary text-2xl font-bold">' + initial(m.full_name) + '</span>';
                document.getElementById('revealed-info').style.display = 'none';
                if (!storedIsPrem) {
                    document.getElementById('btn-reveal').style.display = 'none';
                    document.getElementById('no-credits-msg').style.display = 'none';
                    document.getElementById('premium-paywall').style.display = 'flex';
                } else if (storedRemaining > 0) {
                    document.getElementById('btn-reveal').style.display = 'flex';
                    document.getElementById('no-credits-msg').style.display = 'none';
                    document.getElementById('premium-paywall').style.display = 'none';
                } else {
                    document.getElementById('btn-reveal').style.display = 'none';
                    document.getElementById('no-credits-msg').style.display = 'block';
                    document.getElementById('premium-paywall').style.display = 'none';
                }
            }
        } catch(e) { console.error('[CosmicMatch] updateCardDisplay avatar/name hatasÄ±:', e); }

        // â”€â”€â”€ 2. Etiketler ve baÄŸ bilgisi â”€â”€â”€
        try {
            document.getElementById('match-lp').textContent = m.life_path || '?';
            document.getElementById('match-bond').textContent = window.discovery.bondLabel(score);
            var arch = window.discovery.ARCHETYPES[m.life_path] || 'Ruh';
            document.getElementById('match-archetype').textContent = 'Life Path ' + (m.life_path||'?') + ' Â· ' + arch;
            var tagsEl = document.getElementById('soul-tags');
            tagsEl.innerHTML =
                '<span class="px-3 py-1 rounded-full bg-primary/10 dark:bg-white/5 text-xs font-medium text-primary dark:text-primary/90 border border-primary/20">LP ' + (m.life_path||'?') + ' Â· ' + arch + '</span>' +
                '<span class="px-3 py-1 rounded-full bg-primary/10 dark:bg-white/5 text-xs font-medium text-primary dark:text-primary/90 border border-primary/20">%' + score + ' Uyum</span>';
        } catch(e) { console.error('[CosmicMatch] updateCardDisplay tags hatasÄ±:', e); }

        // â”€â”€â”€ 3. AI analiz (en son â€” hata olursa Ã¼st kÄ±smÄ± etkilemesin) â”€â”€â”€
        try { generateInsights(m, score); } catch(e) { console.error('[CosmicMatch] generateInsights hatasÄ±:', e); }
    }

    // Kozmik analiz â€” AI destekli
    var _insightCache = {}; // { 'userId_matchUserId': 'AI text' }
    var _insightAbort = null; // Aktif AI Ã§aÄŸrÄ±sÄ±nÄ± iptal etmek iÃ§in

    function generateInsights(matchProfile, score) {
        var section = document.getElementById('insight-section');
        var aiEl = document.getElementById('insight-ai');
        var loadingEl = document.getElementById('insight-loading');
        if (!matchProfile) { section.style.display = 'none'; return; }
        section.style.display = 'block';

        // Ã–nceki AI Ã§aÄŸrÄ±sÄ±nÄ± iptal et
        if (_insightAbort) { try { _insightAbort.abort(); } catch(e) {} }

        var cacheKey = userProfile.user_id + '_' + (matchProfile.user_id || matchProfile.full_name);

        // Cache'de varsa hemen gÃ¶ster
        if (_insightCache[cacheKey]) {
            loadingEl.style.display = 'none';
            aiEl.style.display = 'block';
            aiEl.textContent = _insightCache[cacheKey];
            return;
        }

        // SessionStorage cache kontrolÃ¼
        try {
            var cached = sessionStorage.getItem('numatch_ai_' + cacheKey);
            if (cached) {
                _insightCache[cacheKey] = cached;
                loadingEl.style.display = 'none';
                aiEl.style.display = 'block';
                aiEl.textContent = cached;
                return;
            }
        } catch(e) {}

        // Loading gÃ¶ster
        aiEl.style.display = 'none';
        loadingEl.style.display = 'block';

        // AI Ã§aÄŸrÄ±sÄ±
        var controller = new AbortController();
        _insightAbort = controller;

        var API_BASE = window.__NUMERAEL_API_BASE || '';
        var prompt = 'Sen numeroloji ve uyumluluk uzmanÄ±sÄ±n. Ä°ki kiÅŸinin numerolojik profillerine bakarak neden eÅŸleÅŸtiklerini 4-5 cÃ¼mle ile aÃ§Ä±kla. Samimi, sÄ±cak ve spesifik ol. Genel kalÄ±p cÃ¼mleler yerine sayÄ±lara dayalÄ± gerÃ§ek analiz yap. TÃ¼rkÃ§e yaz.\n\n' +
            'KiÅŸi 1: ' + (userProfile.full_name || 'KullanÄ±cÄ±') + '\n' +
            '- Kader Yolu (Life Path): ' + (userProfile.life_path || '?') + '\n' +
            '- Ruh GÃ¼dÃ¼sÃ¼ (Soul Urge): ' + (userProfile.soul_urge || '?') + '\n' +
            '- KiÅŸilik SayÄ±sÄ±: ' + (userProfile.personality_num || '?') + '\n' +
            '- Ä°fade SayÄ±sÄ±: ' + (userProfile.expression_num || '?') + '\n\n' +
            'KiÅŸi 2: ' + (matchProfile.full_name || 'EÅŸleÅŸme') + '\n' +
            '- Kader Yolu (Life Path): ' + (matchProfile.life_path || '?') + '\n' +
            '- Ruh GÃ¼dÃ¼sÃ¼ (Soul Urge): ' + (matchProfile.soul_urge || '?') + '\n' +
            '- KiÅŸilik SayÄ±sÄ±: ' + (matchProfile.personality_num || '?') + '\n' +
            '- Ä°fade SayÄ±sÄ±: ' + (matchProfile.expression_num || '?') + '\n\n' +
            'Uyum Skoru: %' + score + '\n\n' +
            'Bu iki kiÅŸinin neden eÅŸleÅŸtiÄŸini, hangi sayÄ±larÄ±nÄ±n uyum saÄŸladÄ±ÄŸÄ±nÄ± ve birlikte nasÄ±l bir enerji yarattÄ±klarÄ±nÄ± kÄ±saca anlat.';

        fetch(API_BASE + '/api/openai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [
                    { role: 'system', content: 'Sen bir numeroloji uyumluluk uzmanÄ±sÄ±n. KÄ±sa, Ã¶z ve sÄ±cak bir dille analiz yaparsÄ±n. Maksimum 5 cÃ¼mle.' },
                    { role: 'user', content: prompt }
                ],
                max_tokens: 300,
                temperature: 0.7
            }),
            signal: controller.signal
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            var text = '';
            if (data.choices && data.choices[0] && data.choices[0].message) {
                text = data.choices[0].message.content.trim();
            }
            if (!text) text = 'Analiz ÅŸu an yÃ¼klenemiyor.';
            _insightCache[cacheKey] = text;
            try { sessionStorage.setItem('numatch_ai_' + cacheKey, text); } catch(e) {}
            loadingEl.style.display = 'none';
            aiEl.style.display = 'block';
            aiEl.textContent = text;
        })
        .catch(function(err) {
            if (err.name === 'AbortError') return;
            console.warn('[CosmicMatch] AI analiz hatasÄ±:', err);
            loadingEl.style.display = 'none';
            aiEl.style.display = 'block';
            aiEl.textContent = 'Uyum analizi yÃ¼klenirken bir hata oluÅŸtu.';
        });
    }

    // Harita â€” Leaflet.js ile ÅŸehir bazlÄ±
    var _cosmicMap = null;
    var _lastDailyMatches = [];
    function renderMap(dailyMatches) {
        _lastDailyMatches = dailyMatches || [];
        var mapEl = document.getElementById('cosmic-map');
        var mapEmpty = document.getElementById('map-empty');
        var mapInfo = document.getElementById('map-info');
        var matches = (dailyMatches || []).filter(function(m) { return m && m.matched; });

        if (!matches.length) {
            if (mapEmpty) mapEmpty.style.display = 'block';
            if (mapInfo) mapInfo.textContent = '';
        } else {
            if (mapEmpty) mapEmpty.style.display = 'none';
            if (mapInfo) mapInfo.textContent = matches.length + ' uyumlu ruh âœ¦';
        }

        // Leaflet haritasÄ± oluÅŸtur
        if (!_cosmicMap) {
            try {
                _cosmicMap = L.map('cosmic-map', {
                    center: [39.0, 35.0],
                    zoom: 6,
                    zoomControl: true,
                    attributionControl: true,
                    scrollWheelZoom: false,
                    dragging: true,
                    doubleClickZoom: false
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OSM',
                    maxZoom: 10,
                    minZoom: 5
                }).addTo(_cosmicMap);
            } catch(e) {
                console.warn('[CosmicMatch] Harita yÃ¼kleme hatasÄ±:', e);
                return;
            }
        }

        // Mevcut marker'larÄ± temizle
        _cosmicMap.eachLayer(function(layer) {
            if (layer instanceof L.Marker) _cosmicMap.removeLayer(layer);
        });

        // KullanÄ±cÄ±nÄ±n kendi ÅŸehrini + avatarÄ±nÄ± gÃ¶ster
        try {
            window.supabaseClient.from('discovery_profiles')
                .select('city, city_lat, city_lng, avatar_url, gender, full_name')
                .eq('user_id', userId)
                .maybeSingle()
                .then(function(res) {
                    if (res.data && res.data.city_lat && res.data.city_lng) {
                        var selfAvatar = getPhoto(res.data.full_name || '', res.data.gender || '', res.data.avatar_url || '');
                        var selfIcon = L.divIcon({
                            className: '',
                            html: '<div style="position:relative"><div class="cosmic-marker cosmic-marker-self"><img src="' + selfAvatar + '" alt=""></div><div class="cosmic-pin cosmic-pin-self"></div></div>',
                            iconSize: [40, 50],
                            iconAnchor: [20, 50]
                        });
                        L.marker([res.data.city_lat, res.data.city_lng], { icon: selfIcon, zIndexOffset: 1000 })
                            .addTo(_cosmicMap)
                            .bindPopup('<div style="text-align:center"><b>Sen</b><br><span style="opacity:0.7">' + (res.data.city || '') + '</span></div>');
                    }
                });
        } catch(e) {}

        // EÅŸleÅŸmelerin avatarlarÄ±nÄ± haritada gÃ¶ster
        var bounds = [];
        matches.forEach(function(match, idx) {
            var p = match.matched;
            if (!p || !p.city_lat || !p.city_lng) return;
            var score = match.match_score || 0;
            var lp = p.life_path || '?';
            var avatarUrl = getPhoto(p.full_name || '', p.gender || '', p.avatar_url || '');

            var markerIcon = L.divIcon({
                className: '',
                html: '<div style="position:relative"><div class="cosmic-marker cosmic-marker-match"><img src="' + avatarUrl + '" alt=""></div><div class="cosmic-pin"></div></div>',
                iconSize: [38, 48],
                iconAnchor: [19, 48]
            });

            var marker = L.marker([p.city_lat, p.city_lng], { icon: markerIcon })
                .addTo(_cosmicMap)
                .bindPopup('<div style="text-align:center"><b>' + maskName(p.full_name) + '</b><br><span style="opacity:0.7">YaÅŸam Yolu: ' + lp + ' Â· %' + score + '</span><br><span style="opacity:0.5;font-size:10px">' + (p.city || '') + '</span></div>');

            (function(i) {
                marker.on('click', function() { selectRibbonItem(i); });
            })(idx);

            bounds.push([p.city_lat, p.city_lng]);
        });

        // Fit bounds â€” tÃ¼m marker'larÄ± gÃ¶ster
        if (bounds.length > 0) {
            try {
                _cosmicMap.fitBounds(bounds, { padding: [30, 30], maxZoom: 8 });
            } catch(e) {}
        }

        // Harita boyutunu dÃ¼zelt (gizli container'dan aÃ§Ä±lÄ±nca)
        setTimeout(function() {
            if (_cosmicMap) _cosmicMap.invalidateSize();
        }, 300);
    }

    // â”€â”€â”€ Åžehir DeÄŸiÅŸtirme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
        var changeBtn = document.getElementById('btn-change-city');
        var panel = document.getElementById('city-change-panel');
        var select = document.getElementById('city-change-select');
        var saveBtn = document.getElementById('btn-save-city');
        var cancelBtn = document.getElementById('btn-cancel-city');
        var cityLabel = document.getElementById('btn-city-label');
        if (!changeBtn || !panel || !select) return;

        // Select'i doldur (ilÃ§eli ÅŸehirler optgroup ile)
        if (window.populateCitySelect) {
            window.populateCitySelect(select);
        }

        // Mevcut ÅŸehri gÃ¶ster
        function loadCurrentCity() {
            window.supabaseClient.from('discovery_profiles')
                .select('city')
                .eq('user_id', userId)
                .maybeSingle()
                .then(function(res) {
                    if (res.data && res.data.city) {
                        cityLabel.textContent = res.data.city;
                        select.value = res.data.city;
                    }
                });
        }
        loadCurrentCity();

        // Panel aÃ§/kapa
        changeBtn.addEventListener('click', function() {
            var isOpen = panel.style.display !== 'none';
            panel.style.display = isOpen ? 'none' : 'flex';
        });
        cancelBtn.addEventListener('click', function() {
            panel.style.display = 'none';
        });

        // Kaydet
        saveBtn.addEventListener('click', async function() {
            var newCity = select.value;
            if (!newCity) return;
            saveBtn.disabled = true;
            saveBtn.textContent = '...';
            var ok = await window.discovery.updateCity(userId, newCity);
            if (ok) {
                cityLabel.textContent = newCity;
                panel.style.display = 'none';
                // HaritayÄ± yenile â€” kendi marker'Ä± gÃ¼ncellensin
                if (_cosmicMap) {
                    _cosmicMap.eachLayer(function(layer) {
                        if (layer instanceof L.Marker) _cosmicMap.removeLayer(layer);
                    });
                }
                renderMap(_lastDailyMatches || []);
            }
            saveBtn.disabled = false;
            saveBtn.textContent = 'Kaydet';
        });
    })();

    // History â€” Sacred Transitions stili
    function addRevealedToHistory(item, m, isPrem) {
        var listEl = document.getElementById('history-list');
        var emptyEl = document.getElementById('history-empty');
        if (emptyEl) emptyEl.style.display = 'none';
        var score = item.score || 0;
        var date = item.matchDate || '';
        var arch = m.life_path ? (window.discovery.ARCHETYPES[m.life_path] || '') : '';
        var card = document.createElement('div');
        card.className = 'flex items-center gap-4 p-3 bg-amber-50 dark:bg-amber-900/20 border border-primary/20 rounded-2xl shadow-sm transition active:scale-[0.98]';
        card.innerHTML =
            '<div class="w-14 h-14 rounded-full border-2 border-primary/40 overflow-hidden flex-shrink-0 flex items-center justify-center bg-white/60 dark:bg-card-dark"><img src="' + getPhoto(m.full_name, m.gender, m.avatar_url) + '" class="w-full h-full object-cover" alt=""></div>' +
            '<div class="flex-1 min-w-0"><h4 class="text-sm font-bold text-gray-800 dark:text-[#E2D1C3] truncate cursor-pointer conn-name-click"' + (m.user_id ? ' data-uid="' + m.user_id + '" data-name="' + (m.full_name || '') + '"' : '') + '>' + (m.full_name || 'Bilinmeyen') + '</h4><p class="text-[10px] text-text-muted uppercase tracking-tighter">LP ' + (m.life_path || '?') + (arch ? ' Â· ' + arch : '') + '</p></div>' +
            '<div class="text-right shrink-0"><p class="copper-gradient-text text-sm font-bold">%' + score + '</p><p class="text-text-muted/50 text-[10px]">' + formatDate(date) + '</p></div>';
        // En Ã¼ste ekle (en yeni)
        if (listEl.firstChild) {
            listEl.insertBefore(card, listEl.firstChild);
        } else {
            listEl.appendChild(card);
        }
    }

    function renderHistory(matches, isPrem) {
        var listEl=document.getElementById('history-list'); var emptyEl=document.getElementById('history-empty');
        if(!matches||!matches.length){emptyEl.style.display='block';return;}
        emptyEl.style.display='none';
        matches.forEach(function(match){
            var m=match.matched||{full_name:'Bilinmeyen',life_path:null};
            var revealed=isPrem||match.revealed;
            var displayName=revealed?(m.full_name||'Bilinmeyen'):maskName(m.full_name||'Bilinmeyen');
            var score=match.match_score||0; var date=match.match_date||'';
            var arch=m.life_path?(window.discovery.ARCHETYPES[m.life_path]||''):'';
            var card=document.createElement('div');
            card.className='flex items-center gap-4 p-3 bg-amber-50 dark:bg-amber-900/20 border border-primary/20 rounded-2xl shadow-sm transition active:scale-[0.98] cursor-pointer';
            card.innerHTML=
                '<div class="w-14 h-14 rounded-full border-2 border-primary/40 overflow-hidden flex-shrink-0 flex items-center justify-center bg-white/60 dark:bg-card-dark">'+(revealed?'<img src="'+getPhoto(m.full_name,m.gender,m.avatar_url)+'" class="w-full h-full object-cover" alt="">':'<span class="text-primary text-sm font-bold">'+initial(m.full_name)+'</span>')+'</div>'+
                '<div class="flex-1 min-w-0"><h4 class="text-sm font-bold text-gray-800 dark:text-[#E2D1C3] truncate'+(revealed?' conn-name-click':'')+'"'+(revealed&&m.user_id?' data-uid="'+m.user_id+'" data-name="'+(m.full_name||'')+'"':'')+'>'+displayName+'</h4><p class="text-[10px] text-text-muted uppercase tracking-tighter">LP '+(m.life_path||'?')+(arch?' Â· '+arch:'')+'</p></div>'+
                '<div class="text-right shrink-0"><p class="copper-gradient-text text-sm font-bold">%'+score+'</p><p class="text-text-muted/50 text-[10px]">'+formatDate(date)+'</p></div>';
            // Karta tÄ±klayÄ±nca Sacred Match kartÄ±nÄ± gÃ¼ncelle
            (function(matchData, profile, matchScore, isRevealed) {
                card.addEventListener('click', function(e) {
                    if (e.target.closest('.conn-name-click')) return; // Ä°sim tÄ±klamasÄ± popup aÃ§sÄ±n
                    updateCardDisplay({ profile: profile, score: matchScore, revealed: isRevealed });
                    // Ä°lgili ribbon item'Ä± da seÃ§ (varsa)
                    for (var ri = 0; ri < ribbonMatches.length; ri++) {
                        if (ribbonMatches[ri].profile && ribbonMatches[ri].profile.user_id === profile.user_id) {
                            activeRibbonIdx = ri;
                            document.querySelectorAll('#match-ribbon .scroll-fragment').forEach(function(f, i) {
                                if (i === ri) f.classList.add('ribbon-active'); else f.classList.remove('ribbon-active');
                            });
                            break;
                        }
                    }
                    // Ãœste scroll
                    document.getElementById('match-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            })(match, m, score, revealed);
            listEl.appendChild(card);
        });
    }

    // Connection popup
    var popupOverlay=document.getElementById('conn-popup-overlay'); var popupEl=document.getElementById('conn-popup');
    var popupName=document.getElementById('conn-popup-name'); var popupBtn=document.getElementById('conn-popup-btn');
    var popupBtnLabel=document.getElementById('conn-popup-btn-label'); var popupStatus=document.getElementById('conn-popup-status');
    var activePopupUid=null;
    function closePopup(){popupEl.style.display='none';popupOverlay.style.display='none';activePopupUid=null;}
    popupOverlay.addEventListener('click',closePopup);

    document.addEventListener('click',async function(e){
        var nameEl=e.target.closest('.conn-name-click'); if(!nameEl) return;
        e.stopPropagation();
        var targetUid=nameEl.getAttribute('data-uid'); var targetName=nameEl.getAttribute('data-name');
        if(!targetUid||!targetName) return;
        activePopupUid=targetUid; popupName.textContent=targetName;
        popupStatus.style.display='none'; popupBtn.disabled=false; popupBtnLabel.textContent='Add Connection';
        popupBtn.className='w-full py-2.5 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all active:scale-95 bg-gradient-to-r from-primary/80 to-primary text-white shadow-sm';
        var connected=await window.connectionEngine.areConnected(userId,targetUid);
        if(connected){popupBtn.style.display='none';popupStatus.textContent='Already connected';popupStatus.style.display='block';}
        else{var existingReq=await window.connectionEngine.hasActiveRequest(userId,targetUid);
            if(existingReq){popupBtn.style.display='none';popupStatus.textContent=existingReq.status==='pending'?'Request pending':'Already connected';popupStatus.style.display='block';}
            else{popupBtn.style.display='flex';}}
        var rect=nameEl.getBoundingClientRect();
        popupEl.style.left=Math.min(rect.left,window.innerWidth-270)+'px';popupEl.style.top=(rect.bottom+8)+'px';
        popupEl.style.display='block';popupOverlay.style.display='block';
    });

    popupBtn.addEventListener('click',async function(){
        if(!activePopupUid) return; popupBtn.disabled=true; popupBtnLabel.textContent='...';
        var result=await window.connectionEngine.sendConnectionRequest(userId,activePopupUid);
        if(result.success){popupBtn.style.display='none';popupStatus.textContent='Request sent';popupStatus.style.display='block';setTimeout(closePopup,1500);}
        else{popupBtnLabel.textContent=result.error==='already_connected'?'Already connected':(result.error==='request_exists'?'Request exists':'Error');popupBtn.disabled=true;}
    });

    function formatDate(d){if(!d)return '';try{return new Date(d+'T00:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'short'});}catch(e){return d;}}
});
</script>
<script src="js/notification-engine.js"></script>
<script src="js/bottom-nav.js"></script>
</body></html>
